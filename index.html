<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Intranet Brigade Municipale</title>
<style>
    
body{
    
    font-family:Segoe UI, sans-serif;
    background:#1c2b49;
    color:white;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
}
 
.container{
    width:450px;
    background:#111827;
    padding:30px;
    border-radius:15px;
    display:flex;
    flex-direction:column;
    gap:15px;
}
h2{text-align:center;}
input,button,select{
    padding:12px;
    border-radius:8px;
    border:none;
    font-size:14px;
}
button{
    background:#2563eb;
    color:white;
    cursor:pointer;
    transition:0.2s;
}
button:hover{background:#1e40af;}
a{
    color:#2563eb;
    cursor:pointer;
    text-decoration:underline;
    text-align:center;
    margin-top:10px;
}
#mdt{
    display:none;
    flex:1;
    width:100%;
    height:100vh;
    flex-direction:row;
}
.sidebar{
    width:260px;
    background:#020617;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:15px;
}

#joinCSU {
    margin-top: 10px; /* espace entre le texte et le bouton */
}

#leaveCSU {
    margin-top: 10px; /* espace entre le texte et le bouton */
}

.main{
    flex:1;
    display:flex;
    padding:30px;
    gap:30px;
    overflow-y:auto;
}

/* Carte normale (hover effect) */
.card {
    background:#0a0f1a;
    padding:20px;
    border-radius:15px;
    position: relative;
    border: 1px solid rgba(59, 130, 246, 0.3);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    transition: 
        transform 0.35s ease,
        box-shadow 0.35s ease,
        border 0.35s ease,
        opacity 0.35s ease;
    opacity: 1;
}

.card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
    border: 1px solid rgba(59, 130, 246, 0.9);
}

/* Cartes ‚Äúpro‚Äù fixes, bordure bleue, pas d‚Äôanimation hover */
.card-blue {
    border: 2px solid #3b82f6; /* bleu vif */
    box-shadow: 0 4px 10px rgba(59,130,246,0.2); /* l√©g√®re ombre */
    transform: none; /* pas de d√©placement au hover */
}

.card-blue:hover {
    transform: none; /* aucun effet hover */
    box-shadow: 0 4px 10px rgba(59,130,246,0.2); /* reste constant */
    border: 2px solid #3b82f6; /* reste bleu */
}




.vacations{
    flex:2;
    display:flex;
    flex-direction:column;
    gap:20px;
}
.waiting{
    flex:1;
}
.agent{
    background:#1f2937;
    padding:6px;
    border-radius:6px;
    margin-top:5px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.csu{
    background:#f59e0b;
    padding:10px;
    border-radius:8px;
    margin-bottom:10px;
}
.csu-button{
    background:#dc2626;
    margin-left:5px;
    padding:4px 6px;
    border-radius:5px;
}
.agent.dragging{opacity:0.5;}


.waiting{
    display:flex;
    flex-direction:column;
    gap:20px;
}

/* Bloc attente */
.waiting > .card:first-child{
    min-height:400px; /* taille minimum */
}

/* Bloc formateurs */
.waiting .trainers{
    min-height:150px;
}


#adminHome {
    display: none;
    flex-direction: column;
    align-items: center;
    width: 90%;
    max-width: 1000px;
}

.admin-grid {
    display: flex;                  /* Flexbox au lieu de Grid */
    flex-wrap: wrap;                /* Permet plusieurs lignes si n√©cessaire */
    justify-content: center;        /* Centre les cartes sur la ligne */
    gap: 25px;                      /* espace entre les cartes */
    width: 100%;
    max-width: 800px;
}


/* Pour l‚Äôadmin uniquement : derni√®re carte occupe toute la largeur */
.admin-grid.admin #btnAllAgents {
    grid-column: 1 / -1;
}

#adminHome .card {
    flex: 1 1 260px; /* largeur min 260px, mais peut grandir pour remplir l‚Äôespace */
    display: flex;
    flex-direction: column;
    text-align: center;
}

.card-text {
    display: block;      /* assure que le texte reste sur sa ligne */
    margin-top: 10px;    /* espace entre le titre et le texte */
}



#btnAllAgents {
    flex: 1 1 100%;                /* prend toute la largeur disponible */
}


h1 {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 3rem;
    font-weight: 700;
    text-align: center;
    color: #1e40af; /* bleu professionnel */
    letter-spacing: 1px;
    margin: 40px 0 20px 0;
    text-transform: uppercase;
    position: relative;
}

/* Ligne d√©corative sous le titre */
h1::after {
    content: '';
    display: block;
    width: 80px;
    height: 4px;
    background-color: #2563eb; /* bleu vif pour accent */
    margin: 12px auto 0 auto;
    border-radius: 2px;
}

#btnAdmin {
    display: none;
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 1000;
    padding: 10px 15px;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out;
}

#btnAdmin:hover {
    background: linear-gradient(135deg, #2563eb, #3b82f6); /* reste instantan√© */
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(37, 99, 235, 0.4);
}

#pageReglement #mainTitle {
    display: none;
}



</style>
</head>
<body>
<h1 id="mainTitle" style="text-align:center; font-size:32px; color:#2563eb; margin-bottom:20px; margin-top:40px;">
    Intranet Brigade Municipale
</h1>
    <button id="btnAdmin">
    ‚öôÔ∏è Admin
    </button>



<!-- INSCRIPTION -->
<div class="container" id="pageInscription" style="display:none;">
    <h2>Inscription</h2>
    <input id="rPrenom" placeholder="Pr√©nom">
    <input id="rNom" placeholder="Nom">
    <input id="rGrade" placeholder="Grade">
    <input id="rArrivalDate" type="date" placeholder="Date d'arriv√©e" />
    <input id="rPass" type="password" placeholder="Mot de passe">
    <button id="btnRegister">Cr√©er compte</button>
    <a id="linkToLogin">D√©j√† un compte ? Connexion</a>
</div>

<!-- LOGIN -->
<div class="container" id="pageLogin">
    <h2>Connexion</h2>
    <input id="lPrenom" placeholder="Pr√©nom">
    <input id="lNom" placeholder="Nom">
    <input id="lPass" type="password" placeholder="Mot de passe">
    <button id="btnLogin">Connexion</button>
    <a id="linkToRegister">Pas de compte ? Inscription</a>
</div>


<!-- HOME APR√àS CONNEXION (Admin) -->
<div class="container" id="adminHome">
    <h2>Admin - Choisissez une option :</h2>

    <div class="admin-grid admin">
        <!-- Carte 1 -->
        <div class="card" id="btnManageAccounts" style="cursor:pointer; text-align:center;">
            <h3>Comptes</h3>
            <p>G√©rer les comptes en attente</p>
        </div>

        <!-- Carte 2 -->
        <div class="card" id="btnTotalHours" style="cursor:pointer; text-align:center;">
            <h3>Heures Totales</h3>
            <p>Voir les heures des agents</p>
        </div>

        <!-- Carte 3 pleine largeur -->
<div class="card" id="btnAllAgents" style="cursor:pointer; text-align:center;">
    <h3>Tous les agents</h3>
    <p class="card-text">Voir et modifier sanctions / formations</p>
</div>

    </div>

    <!-- Bouton retour -->
    <button id="btnBackToHome" 
        style="margin-top:30px; padding:12px 20px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Accueil
    </button>
</div>



<!-- HOME APR√àS CONNEXION (Agent) -->
<div class="container" id="homePage" 
     style="display:none; flex-direction:column; align-items:center; 
            width:90%; max-width:900px; margin:40px auto; 
            background:#111827; padding:40px; border-radius:12px; color:white;">

    <h2 style="margin-bottom:30px; text-align:center;">Bienvenue</h2>

    <div style="display:flex; 
                gap:40px; 
                flex-wrap:wrap; 
                justify-content:center; 
                width:100%;">

        <div class="card" id="btnMDT"
             style="cursor:pointer; 
                    flex:1 1 320px; 
                    text-align:center; 
                    padding:35px; 
                    background:#0a0f1a; 
                    border-radius:12px;">
            <h3 style="font-size:22px;">MDT / Dispatch</h3>
            <p style="font-size:16px;">Voir et g√©rer les vacations</p>
        </div>

        <div class="card" id="btnPointeuse"
             style="cursor:pointer; 
                    flex:1 1 320px; 
                    text-align:center; 
                    padding:35px; 
                    background:#0a0f1a; 
                    border-radius:12px;">
            <h3 style="font-size:22px;">Pointeuse</h3>
            <p style="font-size:16px;">G√©rer vos heures de service</p>
        </div>

        <div class="card" id="btnReglement"
     style="cursor:pointer; 
            flex:1 1 320px; 
            text-align:center; 
            padding:35px; 
            background:#0a0f1a; 
            border-radius:12px;">
    <h3 style="font-size:22px;">R√®glement</h3>
    <p style="font-size:16px;">Lire le r√®glement</p>
</div>
    </div>
</div>



<!-- POINTEUSE -->
<div class="container" id="pagePointeuse" 
     style="display:none; flex-direction:column; align-items:center; padding:30px; margin:80px auto 20px auto; max-width:600px; box-shadow:0 8px 20px rgba(0,0,0,0.3); border-radius:12px; background:#111827; transition: transform 0.3s ease, box-shadow 0.3s ease;">
    
    <h2 style="text-align:center; margin-bottom:20px; color:#f3f4f6;">Pointeuse</h2>

    <div id="pointeuseInfo" style="margin-bottom:20px; font-weight:bold; color:#e5e7eb;"></div>

    <!-- Boutons service -->
    <button id="btnStartShift" 
        style="margin-bottom:10px; background:#16a34a; color:white; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#15803d'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#16a34a'; this.style.transform='scale(1)';">
        üü¢ D√©but de service
    </button>

    <button id="btnEndShift" 
        style="margin-bottom:20px; background:#dc2626; color:white; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#b91c1c'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#dc2626'; this.style.transform='scale(1)';">
        üî¥ Fin de service
    </button>

    <!-- Historique -->
    <div style="width:100%;">
        <h3 style="margin-bottom:10px; color:#f3f4f6;">Historique</h3>
        <div id="pointeuseHistory" style="display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto; padding-right:5px;"></div>
    </div>

    <!-- Retour -->
    <button id="btnBackHomeFromPointeuse" 
        style="margin-top:20px; padding:10px 15px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Retour Accueil
    </button>
</div>


<!-- PAGE R√àGLEMENT -->
<div id="pageReglement" style="
    display:none;
    flex-direction:column;
    background:#0a0f1a;
    color:white;
    min-height:100vh;
    max-height:100vh;
    padding:20px;
    border-radius:12px;
    overflow:hidden;  /* cache la scrollbar pour le conteneur principal */
    margin-top: 150px;
">


    <h1 style="text-align:center; margin-bottom:20px; margin-top: 10px;">üìò CODE DE D√âONTOLOGIE ‚Äì BRIGADE MUNICIPALE</h1>

    <!-- Conteneur scrollable pour tout le texte -->
    <div style="
        flex:1;
        overflow-y: scroll; /* scroll avec la souris */
        -ms-overflow-style: none;  /* IE et Edge */
        scrollbar-width: none;     /* Firefox */
        padding-right:10px;
    " onscroll="">

        <p><strong>La Brigade Municipale, plac√©e sous l‚Äôautorit√© comp√©tente pour les missions de s√©curit√© int√©rieure, agit dans le respect strict des lois et du Code de proc√©dure p√©nale.</strong><br>
        Elle assure :</p>
        <ul>
            <li>La d√©fense des institutions</li>
            <li>Le respect des lois</li>
            <li>Le maintien de l‚Äôordre public</li>
            <li>La protection des personnes et des biens</li>
            <li>Les policiers exercent leurs fonctions avec loyaut√©, honneur, impartialit√© et d√©vouement.</li>
        </ul>

        <h3>TITRE I ‚Äì PRINCIPES G√âN√âRAUX</h3>
        <p><strong>Article R. 434-101 ‚Äì Mission</strong><br>
        La Brigade Municipale exerce ses missions dans le respect strict des lois et r√®glements en vigueur.</p>
        <p><strong>Article R. 434-102 ‚Äì Principe hi√©rarchique</strong><br>
        L‚Äôautorit√© hi√©rarchique donne des ordres pr√©cis et en assume la responsabilit√©. Les ordres suivent la voie hi√©rarchique sauf urgence. Tout fait grave, m√™me hors service, doit √™tre signal√©.</p>
        <p><strong>Article R. 434-103 ‚Äì Ob√©issance</strong><br>
        L‚Äôex√©cution des ordres est obligatoire. Exception : ordre manifestement ill√©gal compromettant gravement l‚Äôint√©r√™t public. En cas de doute, l‚Äôagent signale l‚Äôill√©galit√© et peut demander confirmation √©crite. L‚Äôordre √©crit n‚Äôexon√®re pas de responsabilit√©.</p>
        <p><strong>Article R. 434-104 ‚Äì Responsabilit√©</strong><br>
        Chaque agent demeure personnellement responsable de ses actes. Tout manquement expose √† des sanctions disciplinaires et/ou p√©nales.</p>
        <p><strong>Article R. 434-105 ‚Äì Protection fonctionnelle</strong><br>
        L‚Äô√âtat prot√®ge juridiquement le policier contre menaces, violences ou poursuites li√©es au service, hors faute personnelle.</p>
        <p><strong>Article R. 434-106 ‚Äì Obligations du sup√©rieur</strong><br>
        Le sup√©rieur prot√®ge l‚Äôint√©grit√© physique et mentale de ses subordonn√©s et assure une formation adapt√©e et actualis√©e.</p>

        <h3>TITRE II ‚Äì DEVOIRS PROFESSIONNELS</h3>
        <p><strong>Article R. 434-107 ‚Äì Secret professionnel</strong><br>
        Toute information obtenue dans le cadre du service est strictement confidentielle.</p>
        <p><strong>Article R. 434-108 ‚Äì Probit√©</strong><br>
        Interdiction d‚Äôaccepter cadeaux ou avantages. Interdiction d‚Äôutiliser sa fonction √† des fins personnelles.</p>
        <p><strong>Article R. 434-109 ‚Äì Discernement</strong><br>
        L‚Äôagent agit avec sang-froid et proportionne sa r√©ponse aux risques et menaces.</p>
        <p><strong>Article R. 434-110 ‚Äì Impartialit√©</strong><br>
        Aucune discrimination n‚Äôest tol√©r√©e. Neutralit√© absolue dans l‚Äôexercice des missions.</p>
        <p><strong>Article R. 434-111 ‚Äì Devoir de r√©serve</strong><br>
        Neutralit√© religieuse, politique et philosophique en service. Hors service, libert√© d‚Äôexpression limit√©e par le devoir de r√©serve.</p>
        <p><strong>Article R. 434-112 ‚Äì Non cumul d‚Äôactivit√©</strong><br>
        Toute activit√© priv√©e lucrative doit respecter strictement le cadre l√©gal.</p>
        <p><strong>Article R. 434-113 ‚Äì Disponibilit√©</strong><br>
        Le policier est disponible selon les n√©cessit√©s du service.</p>

        <h3>TITRE III ‚Äì RELATION AVEC LA POPULATION</h3>
        <p><strong>Article R. 434-114 ‚Äì Comportement</strong><br>
        Courtoisie et vouvoiement obligatoires. Respect constant de la dignit√© humaine.</p>
        <p><strong>Article R. 434-115 ‚Äì Contr√¥les d‚Äôidentit√©</strong><br>
        Interdiction de contr√¥le fond√© sur des caract√©ristiques physiques. Respect de la dignit√©. Palpation uniquement si n√©cessaire pour la s√©curit√©.</p>
        <p><strong>Article R. 434-116 ‚Äì Personnes interpell√©es</strong><br>
        Protection contre toute violence ou traitement d√©gradant. Menottes uniquement si danger ou risque de fuite.</p>
        <p><strong>Article R. 434-117 ‚Äì Pr√©somption d‚Äôinnocence</strong><br>
        Toute personne est pr√©sum√©e innocente jusqu‚Äô√† d√©cision judiciaire d√©finitive.</p>
        <p><strong>Article R. 434-118 ‚Äì Assistance et aide aux victimes</strong><br>
        Obligation d‚Äôassistance, m√™me hors service. Attention particuli√®re aux victimes et respect de la confidentialit√©.</p>
        <p><strong>Article R. 434-119 ‚Äì Donn√©es personnelles</strong><br>
        Respect strict des r√®gles relatives aux fichiers et √† la vie priv√©e.</p>
        <p><strong>Article R. 434-120 ‚Äì Sources humaines</strong><br>
        Recours aux informateurs uniquement selon les r√®gles en vigueur.</p>

        <h3>TITRE IV ‚Äì USAGE DE LA FORCE</h3>
        <p><strong>Article R. 434-121 ‚Äì Principe de n√©cessit√©</strong><br>
        La force ne peut √™tre employ√©e que si elle est l√©gale, n√©cessaire et proportionn√©e.</p>
        <p><strong>Article R. 434-122 ‚Äì Arme l√©tale</strong><br>
        L‚Äôarme l√©tale constitue un dernier recours absolu, uniquement en cas de l√©gitime d√©fense ou de danger grave et imminent. Tout usage peut faire l‚Äôobjet d‚Äôun contr√¥le hi√©rarchique ou d‚Äôune enqu√™te.</p>
        <p><strong>Article R. 434-123 ‚Äì Arme hors service</strong><br>
        Autorisation √† partir du grade de Brigadier. Usage exclusivement en l√©gitime d√©fense. Brassard et port dissimul√© obligatoires.</p>
        <p><strong>Article R. 434-124 ‚Äì Tir sur v√©hicule</strong><br>
        Respect strict des ordres du commandement.</p>

        <h3>TITRE V ‚Äì TENUE, DISCIPLINE ET VIE INTERNE</h3>
        <p><strong>Article R. 434-125 ‚Äì Tenue r√©glementaire</strong><br>
        Uniforme obligatoire en service sauf exception r√©glementaire. Uniformit√© stricte. Interdits : polo noir en Police Secours, cache-cou, masque, casquette non r√©glementaire ou port√©e √† l‚Äôenvers. Calot autoris√©.</p>
        <p><strong>Article R. 434-126 ‚Äì Comportement exemplaire</strong><br>
        Comportement irr√©prochable en service comme hors service, y compris sur les r√©seaux sociaux.</p>
        <p><strong>Article R. 434-127 ‚Äì Respect interne</strong><br>
        Langage correct obligatoire. Tout manque de respect est sanctionnable.</p>
        <p><strong>Article R. 434-128 ‚Äì Vie priv√©e</strong><br>
        Interdiction de diffuser photos ou vid√©os sans autorisation.</p>
        <p><strong>Article R. 434-129 ‚Äì Professionnalisme</strong><br>
        Les diff√©rends personnels ne doivent jamais impacter le service.</p>

        <h3>TITRE VI ‚Äì R√àGLES OP√âRATIONNELLES</h3>
        <p><strong>Article R. 434-130 ‚Äì Coop√©ration interservices</strong><br>
        Coop√©ration respectueuse avec les services publics et priv√©s.</p>
        <p><strong>Article R. 434-131 ‚Äì V√©hicules et mat√©riel</strong><br>
        Interdiction d‚Äôutiliser les v√©hicules d‚Äôautres services. Usage strictement encadr√© des armes et mat√©riels.</p>
        <p><strong>Article R. 434-132 ‚Äì Fourri√®re</strong><br>
        Recours justifi√©. Contact privil√©gi√© avec les d√©panneurs.</p>
        <p><strong>Article R. 434-133 ‚Äì Lieux sensibles</strong><br>
        Intervention soumise √† autorisation d‚Äôun officier, pr√©fet ou procureur.</p>
        <p><strong>Article R. 434-134 ‚Äì Signalisation</strong><br>
        V√©hicule l√©ger : 3 c√¥nes en moyenne. Barri√®res et panneaux r√©serv√©s aux unit√©s routi√®res.</p>
        <p><strong>Article R. 434-135 ‚Äì Service minimum</strong><br>
        Toute pr√©sence en ville entre 12h00 et 00h00 impose un minimum d‚Äôune heure de service.</p>

        <h3>TITRE VII ‚Äì CONTR√îLE ET SANCTIONS</h3>
        <p><strong>Article R. 434-136 ‚Äì Contr√¥le</strong><br>
        Les agents sont soumis au contr√¥le hi√©rarchique, aux inspections comp√©tentes et aux autorit√©s l√©gales.</p>
        <p><strong>Article R. 434-137 ‚Äì Sanctions</strong><br>
        Tout manquement au pr√©sent code expose √† une sanction disciplinaire, sans pr√©judice d‚Äô√©ventuelles poursuites p√©nales.</p>

        <div style="
            margin-top: 30px;
            padding: 20px;
            border-radius: 12px;
            background: #2563eb;
            color: white;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
        ">
            üîπ Corps de Commandement üîπ<br>
            Brigade Municipale ‚Äì Respect & Discipline
        </div>

    </div> <!-- fin scrollable -->

    <!-- Bouton Accueil centr√© en bas -->
    <div style="text-align:center; margin-top:10px;">
        <button id="btnBackFromReglement" style="
            margin-top: 10px;
            margin-bottom: 30px;
            padding:10px 15px;
            border-radius:8px;
            background:#2563eb;
            color:white;
            cursor:pointer;
            font-weight:600;
            transition: all 0.25s ease-in-out;"
            onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
            ‚¨ÖÔ∏è Accueil
        </button>
    </div>

</div>



<!-- MDT -->
<div id="mdt">
    <div class="sidebar">
        <h3>Agent</h3>
        <div id="agentInfo"></div>
        <button id="btnAttente" style="margin-bottom:10px; background:#16a34a; color:white; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
            onmouseover="this.style.background='#15803d'; this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#16a34a'; this.style.transform='scale(1)';">
            üü¢ Attente
        </button>
        <button id="btnQuitterAttente" style="margin-bottom:10px; background:#dc2626; color:white; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
            onmouseover="this.style.background='#b91c1c'; this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#dc2626'; this.style.transform='scale(1)';">
            üî¥ Quitter
        </button>
        <div class="csu">
            <h4>CSU</h4>
            <div style="display:flex; align-items:center; gap:20px;"></div>
            <div id="csuInfo">Aucun agent CSU</div>
            <button id="joinCSU" style="background:#2563eb; color:white; padding:8px; border-radius:6px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
                onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
                onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
                Rejoindre CSU
            </button>
            <button id="leaveCSU" style="display:none; background:#dc2626; color:white; padding:8px; border-radius:6px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
                onmouseover="this.style.background='#b91c1c'; this.style.transform='scale(1.03)';"
                onmouseout="this.style.background='#dc2626'; this.style.transform='scale(1)';">
                Quitter CSU
            </button>
        </div>
        <button id="btnBackHomeFromMDT" style="margin-top:20px; padding:10px 15px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
            onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
            ‚¨ÖÔ∏è Accueil
        </button>
    </div>

    <div class="main">

    <div class="vacations" id="vacationsDiv"></div>

    <div class="waiting" style="display:flex; flex-direction:column; gap:20px;">

        <div class="card card-blue">
    <h3>Attente d'affectation</h3>
    <div id="waitingList"></div>
</div>

        <div class="card card-blue trainers">
    <h3>Formateurs disponibles</h3>
    <div id="trainersList"></div>
</div>

    </div>
    </div>
</div>





<!-- PAGE ADMIN -->
<div class="container" id="pageAdmin" style="display:none;">
    <h2>Validation des comptes</h2>
    <div id="adminList" style="display:flex; flex-direction:column; gap:10px;"></div>
    <button id="btnBackAdmin"style="margin-top:10px; padding:10px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Retour</button>
    
</div>

<!-- PAGE ADMIN - HEURES TOTALES -->
<div class="container" id="pageTotalHours" 
     style="display:none; padding:30px; margin:1000px auto 20px auto; max-width:800px; box-shadow:0 8px 20px rgba(0,0,0,0.3); border-radius:12px; background:#111827; transition: transform 0.3s ease, box-shadow 0.3s ease;">
    <h2 style="text-align:center; margin-bottom:20px; color:#f3f4f6;">Heures totales des agents</h2>

<button id="sortButton" type="button"
        style="margin-bottom:15px; padding:8px 15px; border-radius:6px; cursor:pointer;">
    üì∂ Trier par grade
</button>


    <div id="totalHoursList" style="display:flex; flex-direction:column; gap:10px;">
    </div>

    <button id="btnResetHours" 
        style="margin-top:20px; background:#dc2626; color:white; padding:10px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#b91c1c'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#dc2626'; this.style.transform='scale(1)';">
        üîÑ Reset heures
    </button>

    <button id="btnBackAdminHome" 
        style="margin-top:10px; padding:10px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Retour
    </button>
</div>


<!-- PAGE ADMIN - TOUS LES AGENTS -->
<div class="container" id="pageAllAgents" 
    style="
        display:none; 
        padding:30px; 
        margin:600px auto 20px auto;   /* r√©duit le margin-top pour ne pas √™tre trop bas */
        max-width:800px; 
        box-shadow:0 8px 20px rgba(0,0,0,0.3); 
        border-radius:12px; 
        background:#111827; 
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    ">
    <h2 style="text-align:center; margin-bottom:20px; color:#f3f4f6;">Votre effectifs</h2>

    <div id="allAgentsList" style="display:flex; flex-direction:column; gap:10px;"></div>

    <button id="btnBackAllAgents"
        style="margin-top:10px; padding:10px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Retour
    </button>
</div>



<div class="container" id="pageAgentDetail" style="
    display:none; 
    flex-direction:column; 
    align-items:center; 
    width:90%;         /* agrandi par rapport √† 100% du parent */
    max-width:800px;  /* limite pour grands √©crans */
    min-width:600px;   /* garde un minimum pour le confort */
    height: 1000px;;       /* adapte la hauteur au contenu */
    padding:30px;      /* plus de padding pour respirer */
">
    <h2 style="margin-bottom:20px;">Dossier Agent</h2>
    <div id="agentDetailContent" style="
        width:100%; 
        display:flex; 
        flex-direction:column; 
        gap:10px;
    "></div>

    <button id="btnBackAgentDetail"
        style="
            margin-top:20px; 
            padding:12px 20px; 
            border-radius:8px; 
            background:#2563eb; 
            color:white; 
            cursor:pointer; 
            font-weight:600; 
            transition: all 0.25s ease-in-out;
        "
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Retour
    </button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, collection, onSnapshot, getDocs }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDX486w4yzHXDOgJ66Q0VjMRXMGtBFNdIY",
  authDomain: "mydispatch-3a386.firebaseapp.com",
  projectId: "mydispatch-3a386",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ELEMENTS
const pageInscription=document.getElementById("pageInscription");
const pageLogin=document.getElementById("pageLogin");
const pageMDT=document.getElementById("mdt");
const agentInfo=document.getElementById("agentInfo");
const waitingList=document.getElementById("waitingList");
const vacationsDiv=document.getElementById("vacationsDiv");
const csuInfo=document.getElementById("csuInfo");
const joinCSU=document.getElementById("joinCSU");
const leaveCSU=document.getElementById("leaveCSU");
const rPrenom=document.getElementById("rPrenom");
const rNom=document.getElementById("rNom");
const rGrade=document.getElementById("rGrade");
const rPass=document.getElementById("rPass");
const lPrenom=document.getElementById("lPrenom");
const lNom=document.getElementById("lNom");
const lPass=document.getElementById("lPass");
const btnRegister=document.getElementById("btnRegister");
const btnLogin=document.getElementById("btnLogin");
const linkToLogin=document.getElementById("linkToLogin");
const linkToRegister=document.getElementById("linkToRegister");
const btnAttente=document.getElementById("btnAttente");
const btnQuitterAttente=document.getElementById("btnQuitterAttente");
const homePage = document.getElementById("homePage");
const pageTotalHours = document.getElementById("pageTotalHours");
const totalHoursList = document.getElementById("totalHoursList");
const btnBackAdminHome = document.getElementById("btnBackAdminHome");
const pageReglement = document.getElementById("pageReglement");



const btnAdmin = document.getElementById("btnAdmin");
const adminHome = document.getElementById("adminHome");
const pageAdmin = document.getElementById("pageAdmin");
const adminList = document.getElementById("adminList");
const btnBackAdmin = document.getElementById("btnBackAdmin");
const pageAllAgents = document.getElementById("pageAllAgents");
const allAgentsList = document.getElementById("allAgentsList");
const pageAgentDetail = document.getElementById("pageAgentDetail");
const agentDetailContent = document.getElementById("agentDetailContent");
const btnBackAgentDetail = document.getElementById("btnBackAgentDetail");
const btnManageAccounts = document.getElementById("btnManageAccounts");
const btnTotalHours = document.getElementById("btnTotalHours");
const btnAllAgents = document.getElementById("btnAllAgents");


const gradeOrder = [
    "Directeur Principal",
    "Directeur Adjoint",
    "Chef de Police",
    "Chef de Service Classe Exceptionnel",
    "Chef de Service Classe Sup√©rieur",
    "Chef de Service Classe Normal",
    "Chef de Service Classe Stagiaire",
    "Brigadier Chef Principal",
    "Brigadier Chef",
    "Brigadier",
    "Gardien Principal",
    "Gardien Titulaire",
    "Gardien Stagiaire"
];

function sortByGrade(a, b) {
    const indexA = gradeOrder.indexOf(a.grade);
    const indexB = gradeOrder.indexOf(b.grade);

    // Si le grade n'est pas dans la liste, le placer √† la fin
    const valA = indexA === -1 ? gradeOrder.length : indexA;
    const valB = indexB === -1 ? gradeOrder.length : indexB;

    return valA - valB;
}


// Ouvrir MDT depuis la page d'accueil
document.getElementById("btnMDT").onclick = async () => {
    await openMDT();
};

// Ouvrir la page r√®glement
document.getElementById("btnReglement").onclick = () => {
    showPage(pageReglement);
};

// Bouton retour
document.getElementById("btnBackFromReglement").onclick = () => {
    showPage(homePage); // ou une autre page si tu veux
};


let currentUser=null;
let isCSU=false;
let isTrainer = false;

// ADMINS AUTORIS√âS
const admins = ["Robin.Perrick", "Tommy.Angello", "de.de", "Mick.Ross"]; // <-- deux √©l√©ments
// LISTE DES FORMATEURS AUTORIS√âS
const trainers = ["Tristan.De Morsef", "Rayan.Houda", "Yahya.Houda"]; // mettre l'ID Firestore = prenom.nom
const recruiters = ["Yahya.Houda","Tristan.De Morsef" ]; // Mets les vrais ID ici

const isAdmin = currentUser && admins.includes(currentUser.id);

// NAVIGATION
function showPage(page){

    pageInscription.style.display="none";
    pageLogin.style.display="none";
    pageMDT.style.display="none";
    pageAdmin.style.display="none";
    homePage.style.display="none";
    pagePointeuse.style.display="none";
    adminHome.style.display = "none";
    pageTotalHours.style.display="none";
    pageAllAgents.style.display="none";
    pageAgentDetail.style.display="none";
    pageReglement.style.display = "none"; // <-- on cache aussi le r√®glement


    page.style.display="flex";

    const header = document.getElementById("mainTitle");
if (page === pageMDT || page === pageReglement) {
    header.style.display = "none"; // cache le titre sur MDT et R√®glement
} else {
    header.style.display = "block"; // affiche le titre sur toutes les autres pages
}

}

// üî• AJOUTE √áA
linkToLogin.onclick = () => showPage(pageLogin);
linkToRegister.onclick = () => showPage(pageInscription);



// INSCRIPTION
btnRegister.onclick=async()=>{
    const prenom=rPrenom.value.trim();
    const nom=rNom.value.trim();
    const grade=rGrade.value.trim();
    const arrivalDate=rArrivalDate.value; // <-- R√©cup√®re la date
    const pass=rPass.value.trim();
    if(!prenom || !nom || !grade || !arrivalDate || !pass) return alert("Veuillez remplir tout les champs !");
    const id=prenom+"."+nom;
    const docRef=doc(db,"agents",id);
    const snap=await getDoc(docRef);
    if(snap.exists()) return alert("Ce compte existe d√©j√†");
    await setDoc(docRef,{
    prenom,
    nom,
    grade,
    pass,
    validated:false,
    inWaiting:false,
    inVacation:null,
    pointeuse: [],   // <-- ajout automatique
    arrivalDate: arrivalDate, // <-- Stocke la date
    sanctions: "",             // initialisation vide
    formations: "",             // initialisation vide
    formateur: false,
    recruteur: false
});

    alert("Compte cr√©√© ! En attente de validation.");
    rPrenom.value=rNom.value=rGrade.value=rPass.value="";
    showPage(pageLogin);
}


// LOGIN
btnLogin.onclick = async () => {
    const prenom = lPrenom.value.trim();
    const nom = lNom.value.trim();
    const pass = lPass.value.trim();
    if(!prenom || !nom || !pass) return alert("Veuillez remplir tout les champs !");

    const id = prenom + "." + nom;
    const docRef = doc(db,"agents",id);
    const snap = await getDoc(docRef);
    if(!snap.exists()) return alert("Vous n'avez pas de compte");
    const data = snap.data();
    if(data.pass !== pass) return alert("Une de vos informations est incorect");
    if(!data.validated) return alert("Votre compte n'a pas encore √©t√© valid√© !");

    // ‚úÖ D√©finir l'utilisateur courant
    currentUser = {...data, id};
    checkAdmin();

    // ‚úÖ V√©rifier si c'est un formateur
    isTrainer = trainers.includes(currentUser.id); // <-- ligne √† ajouter ici

    // Affichage info agent
    agentInfo.innerText = `${currentUser.prenom} ${currentUser.nom} - ${currentUser.grade}`;

    // Navigation et chargement des donn√©es
    showPage(homePage);
    checkAdmin();
    await initDispatch();
    await initVacations();
    initCSU();
    loadWaiting();
    loadVacations();
    loadTrainers(); // <-- charger la liste des formateurs
};



// üîπ V√©rifie si currentUser est admin, formateur ou recruteur
let isTrainerRole = false;
let isRecruiterRole = false;

function checkAdmin() {
    if (!currentUser || homePage.style.display === "none") {
        btnAdmin.style.display = "none";
        isTrainerRole = false;
        isRecruiterRole = false;
        return;
    }

    // Reset
    isTrainerRole = false;
    isRecruiterRole = false;

    if (admins.includes(currentUser.id)) {
        btnAdmin.style.display = "block";
        btnAdmin.innerText = "‚öôÔ∏è Admin";
    } else {
        btnAdmin.style.display = "block";
        // R√¥les multiples possibles
        if (trainers.includes(currentUser.id)) isTrainerRole = true;
        if (recruiters.includes(currentUser.id)) isRecruiterRole = true;

        if (isTrainerRole && isRecruiterRole) {
            btnAdmin.innerText = "üéì Formateur & üìù Recruteur";
        } else if (isTrainerRole) {
            btnAdmin.innerText = "üéì Formateur";
        } else if (isRecruiterRole) {
            btnAdmin.innerText = "üìù Recruteur";
        } else {
            btnAdmin.style.display = "none";
        }
    }
}


// Charger comptes non valid√©s
async function loadAdminAccounts() {
    adminList.innerHTML = "";
    const snap = await getDocs(collection(db, "agents"));
    let count = 0;

    snap.forEach(docu => {
        const data = docu.data();

        if (!data.validated) {

            const div = document.createElement("div");
            div.className = "agent";
            div.style.display = "flex";
            div.style.justifyContent = "space-between";
            div.style.alignItems = "center";
            div.style.background = "#1f2937";
            div.style.padding = "10px";
            div.style.borderRadius = "10px";
            div.style.marginBottom = "8px"; // un peu d'espace entre les lignes

            const span = document.createElement("span");
            span.innerText = `${data.prenom} ${data.nom} - ${data.grade}`;
            span.style.color = "#f3f4f6"; // texte clair pour contraste
            span.style.fontWeight = "500";
            div.appendChild(span);

            const actions = document.createElement("div");

            // ‚úÖ BOUTON VALIDER
            const btnValider = document.createElement("button");
            btnValider.textContent = "‚úÖ Valider";
            Object.assign(btnValider.style, {
                background: "#16a34a",
                color: "white",
                border: "none",
                padding: "6px 12px",
                borderRadius: "6px",
                cursor: "pointer",
                fontWeight: "600",
                transition: "all 0.2s ease-in-out",
            });
            btnValider.onmouseover = () => btnValider.style.transform = "scale(1.05)";
            btnValider.onmouseout = () => btnValider.style.transform = "scale(1)";
            btnValider.onclick = async () => {
                await updateDoc(doc(db, "agents", docu.id), { validated: true });
                loadAdminAccounts();
            };

            // ‚ùå BOUTON REFUSER
            const btnRefuser = document.createElement("button");
            btnRefuser.textContent = "‚ùå Refuser";
            Object.assign(btnRefuser.style, {
                background: "#dc2626",
                color: "white",
                border: "none",
                padding: "6px 12px",
                borderRadius: "6px",
                cursor: "pointer",
                fontWeight: "600",
                marginLeft: "8px",
                transition: "all 0.2s ease-in-out",
            });
            btnRefuser.onmouseover = () => btnRefuser.style.transform = "scale(1.05)";
            btnRefuser.onmouseout = () => btnRefuser.style.transform = "scale(1)";
            btnRefuser.onclick = async () => {
                if (confirm("Refuser ce compte ?")) {
                    await deleteDoc(doc(db, "agents", docu.id));
                    loadAdminAccounts();
                }
            };

            actions.appendChild(btnValider);
            actions.appendChild(btnRefuser);
            div.appendChild(actions);

            adminList.appendChild(div);
            count++;
        }
    });

    if (count === 0) {
    const span = document.createElement("span");
    span.innerText = "Aucun compte est en attente";
    span.style.color = "#9ca3af";       // gris clair pour le texte
    span.style.fontSize = "18px";       // un peu plus gros
    span.style.fontWeight = "500";      // un peu plus visible
    span.style.textAlign = "center";    // centr√© si tu veux
    span.style.display = "block";       // pour que textAlign fonctionne
    span.style.marginTop = "20px";      // espace au-dessus
    adminList.appendChild(span);
}
}



// INIT DISPATCH & VACATIONS
async function initDispatch(){
    const ref=doc(db,"dispatch","waiting");
    const snap=await getDoc(ref);
    if(!snap.exists()) await setDoc(ref,{agents:[]});
}
async function initVacations(){
    const vacCol=collection(db,"vacations");
    const snap=await getDocs(vacCol);
    if(snap.empty){
        const defaultVacations=[
            {nom:"Victor 01",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"Victor 02",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"Victor 03",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"GSI Alpha",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"GSI Bravo",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"BMU Alpha",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"BMU Bravo",statut:"Disponible",agents:[],vehicules:["Aucun"]},
        ];
        for(let v of defaultVacations){
            const id=v.nom.replace(/\s+/g,"_");
            await setDoc(doc(db,"vacations",id),v);
        }
    }
}

// ATTENTE
btnAttente.onclick=async()=>{
    if(!currentUser || currentUser.inVacation) return alert("Vous √™tes d√©j√† dans une vacation !");
    const ref=doc(db,"dispatch","waiting");
    await updateDoc(ref,{agents:arrayUnion(currentUser)});
    await updateDoc(doc(db,"agents",currentUser.id),{inWaiting:true});
    currentUser.inWaiting=true;
}
btnQuitterAttente.onclick = async () => {
    if(!currentUser) return;
    const ref = doc(db,"dispatch","waiting");
    const snap = await getDoc(ref);
    const agents = snap.data()?.agents || [];
    const newAgents = agents.filter(a => a.id !== currentUser.id);
    await updateDoc(ref, { agents: newAgents });
    await updateDoc(doc(db,"agents",currentUser.id), { inWaiting: false });
    currentUser.inWaiting = false;
};


// CSU
function initCSU(){
    const csuRef=doc(db,"csu","current");
    onSnapshot(csuRef,snap=>{
        const data = snap.data()||{};
        if(data.agent){
            csuInfo.innerText=`${data.agent.prenom} ${data.agent.nom} ${data.agent.grade}`;
            isCSU=(currentUser.id===data.agent.id);
            joinCSU.style.display=isCSU? "none" : "none";
            leaveCSU.style.display=isCSU? "block" : "none";
        } else {
            csuInfo.innerText="Aucun agent CSU";
            isCSU=false;
            joinCSU.style.display="block";
            leaveCSU.style.display="none";
        }
        loadVacations();
        loadWaiting();
    });
}
joinCSU.onclick=async()=>{
    const csuRef=doc(db,"csu","current");
    const snap=await getDoc(csuRef);
    if(snap.data()?.agent) return alert("Un agent est d√©j√† CSU !");
    await setDoc(csuRef,{agent:currentUser});
}
leaveCSU.onclick=async()=>{
    const csuRef=doc(db,"csu","current");
    await setDoc(csuRef,{agent:null});
}

// LOAD
function loadWaiting() {
    const waitingRef = doc(db, "dispatch", "waiting");

    // --------------------------
    // DROP dans waiting (depuis une vacation)
    // --------------------------
    waitingList.addEventListener("dragover", e => e.preventDefault());
    waitingList.addEventListener("drop", async e => {
        e.preventDefault();

        let data;
        try {
            data = JSON.parse(e.dataTransfer.getData("text/plain"));
        } catch {
            return;
        }

        const agentObj = data.agent;

        if (data.from === "waiting") return; // d√©j√† en waiting

        // 1Ô∏è‚É£ Ajouter l'ID de l'agent √† waiting
        const snapWaiting = await getDoc(waitingRef);
        const agentsWaiting = snapWaiting.data()?.agents || [];
        await updateDoc(waitingRef, { agents: [...agentsWaiting, agentObj] });

        // 2Ô∏è‚É£ Mettre √† jour l'agent
        await updateDoc(doc(db, "agents", agentObj.id), { inVacation: null, inWaiting: true });

        // 3Ô∏è‚É£ Retirer de la vacation si besoin
        if (data.from) {
            const fromRef = doc(db, "vacations", data.from);
            const snapFrom = await getDoc(fromRef);
            if (snapFrom.exists()) {
                const agentsFrom = snapFrom.data()?.agents || [];
                const newAgentsFrom = agentsFrom.filter(a => a.id !== agentObj.id);
                await updateDoc(fromRef, { agents: newAgentsFrom });
            }
        }
    });

    // --------------------------
    // √âcoute des changements sur la waiting list
    // --------------------------
    onSnapshot(waitingRef, snap => {
        waitingList.innerHTML = "";
        const agentsInWaiting = snap.data()?.agents || [];

        agentsInWaiting.forEach(a => {
            const div = document.createElement("div");
            div.className = "agent";
            div.innerText = `${a.prenom} ${a.nom} - ${a.grade}`;

            // On affiche les boutons seulement si isCSU
            if (isCSU) {
                // Bouton retirer
                const btn = document.createElement("button");
                btn.textContent = "‚ùå Retirer";
                btn.className = "csu-button";
                btn.onclick = async () => {
                    // Retirer l'agent par ID
                    const snap = await getDoc(waitingRef);
                    const agents = snap.data()?.agents || [];
                    const newAgents = agents.filter(agent => agent.id !== a.id);
                    await updateDoc(waitingRef, { agents: newAgents });

                    await updateDoc(doc(db, "agents", a.id), { inWaiting: false });
                };
                div.appendChild(btn);

                // Drag depuis waiting
                div.draggable = true;
                div.addEventListener("dragstart", e => {
                    e.dataTransfer.setData(
                        "text/plain",
                        JSON.stringify({ agent: a, from: "waiting" })
                    );
                    div.classList.add("dragging");
                });
                div.addEventListener("dragend", () => div.classList.remove("dragging"));
            }

            waitingList.appendChild(div);
        });
    });
}

function loadTrainers(){

    const trainersDiv = document.getElementById("trainersList");

    onSnapshot(collection(db,"agents"),snap=>{

        let trainersArray = [];

        snap.forEach(docu=>{

            const data = docu.data();

            if(
    trainers.includes(docu.id) &&
    data.validated &&
    (
        data.inVacation ||
        data.inWaiting ||
        data.isCSU === true
    )
){
                let statut = "| üü¢ Disponible";

                if(data.inVacation) statut = "| üî¥ En vacation";
                else if(data.inWaiting) statut = "|üü† En attente";

                trainersArray.push({
                    id: docu.id,
                    prenom: data.prenom,
                    nom: data.nom,
                    grade: data.grade,
                    statut: statut
                });
            }
        });

        // üî• TRI PAR GRADE (ton syst√®me existant)
        trainersArray.sort(sortByGrade);

        trainersDiv.innerHTML = "";

        trainersArray.forEach(a=>{
            const div=document.createElement("div");
            div.className="agent";
            div.innerText=`${a.prenom} ${a.nom} - ${a.grade} ${a.statut}`;
            trainersDiv.appendChild(div);
        });

    });
}


function colorStatut(select){
    if(select.value === "Disponible"){
        select.style.backgroundColor = "#2ecc71"; // vert
        select.style.color = "white";
    }
    else if(select.value === "En intervention"){
        select.style.backgroundColor = "#f39c12"; // orange
        select.style.color = "white";
    }
    else if(select.value === "Indisponible"){
        select.style.backgroundColor = "#e74c3c"; // rouge
        select.style.color = "white";
    }
    
}


function loadVacations(){
    const vacCol=collection(db,"vacations");
    onSnapshot(vacCol,snap=>{
        vacationsDiv.innerHTML="";
        // Ordre voulu : Victor -> GSI -> BMU
        const docs = snap.docs.sort((a, b) => {
    const order = [
        "Victor 01", "Victor 02", "Victor 03",
        "GSI Alpha", "GSI Bravo",
        "BMU Alpha", "BMU Bravo"
    ];

    const aData = a.data();
    const bData = b.data();

    const aHasAgents = (aData.agents || []).length > 0 ? 0 : 1;
    const bHasAgents = (bData.agents || []).length > 0 ? 0 : 1;

    // 1Ô∏è‚É£ Priorit√© aux vacations avec agents
    if(aHasAgents !== bHasAgents) return aHasAgents - bHasAgents;

    // 2Ô∏è‚É£ Priorit√© selon l'ordre fixe
    const aIndex = order.indexOf(aData.nom);
    const bIndex = order.indexOf(bData.nom);

    if(aIndex === -1 && bIndex === -1) return 0;
    if(aIndex === -1) return 1;
    if(bIndex === -1) return -1;

    return aIndex - bIndex;
});


        docs.forEach(docu=>{
            const v = docu.data();
            const div = document.createElement("div");
            div.className="card";
            const title = document.createElement("h3");
            title.textContent=v.nom;
            div.appendChild(title);
            // STATUT
            const selectStat = document.createElement("select");
            ["Disponible","En intervention","Indisponible"].forEach(s=>{
                const opt=document.createElement("option");
                opt.value=s; opt.textContent=s;
                if(v.statut===s) opt.selected=true;
                selectStat.appendChild(opt);
            });
            selectStat.disabled=!(isCSU || (v.agents||[]).some(a=>a.id===currentUser.id));
            colorStatut(selectStat);
            selectStat.onchange=async()=>{
            colorStatut(selectStat);
            await updateDoc(doc(db,"vacations",docu.id),{statut:selectStat.value});
            };

            div.appendChild(selectStat);

            // VEHICULE
let vehicles = ["Aucun","Enyoq","Cinq C SW","M√©gane","Kangoo","Tucson","Zo√©"]; // liste compl√®te par d√©faut

// ‚ö° appliquer r√®gles selon type de vacation
if(v.nom.startsWith("Victor")) {
    vehicles = vehicles.filter(vh => vh !== "Cinq C SW"); // tout sauf Cinq C SW
} else if(v.nom.startsWith("GSI")) {
    vehicles = ["Aucun","M√©gane","Cinq C SW"]; // seulement ces deux
}

const selVeh = document.createElement("select");
vehicles.forEach(vh => {
    const opt = document.createElement("option");
    opt.value = vh;
    opt.textContent = vh;
    if((v.vehicules||["Aucun"]).includes(vh)) opt.selected = true;
    selVeh.appendChild(opt);
});

selVeh.disabled = !(isCSU || (v.agents||[]).some(a => a.id === currentUser.id));

selVeh.onchange = async () => {
    await updateDoc(doc(db,"vacations",docu.id), {vehicules:[selVeh.value]});
};

div.appendChild(selVeh);


            // BOUTONS REJOINDRE / QUITTER
            const joinBtn=document.createElement("button");
            joinBtn.textContent="Rejoindre"; joinBtn.onclick=()=>rejoindreVacation(docu.id);
            const leaveBtn=document.createElement("button");
            leaveBtn.textContent="Quitter"; leaveBtn.onclick=()=>quitterVacation(docu.id);
            div.appendChild(joinBtn); div.appendChild(leaveBtn);

            // AGENTS
            const agentDiv=document.createElement("div");
            agentDiv.className="agents-container";
            // Trie les agents de la vacation par grade
            const sortedAgents = (v.agents || []).sort(sortByGrade);
            sortedAgents.forEach(a => {
                const ag = document.createElement("div");
                ag.className = "agent";
                ag.innerText = `${a.prenom} ${a.nom} - ${a.grade}`;
                ag.draggable = isCSU;
    
                if (isCSU) {
                    const btn = document.createElement("button");
                    btn.textContent = "‚ùå Retirer";
                    btn.className = "csu-button";
                    btn.onclick = async () => {
                        await updateDoc(doc(db,"vacations",docu.id), { agents: arrayRemove(a) });
                        await updateDoc(doc(db,"agents",a.id), { inVacation: null });
                    };
                    ag.appendChild(btn);

                    // Drag & drop
                    ag.addEventListener("dragstart", e => {
                        e.dataTransfer.setData("text/plain", JSON.stringify({ agent: a, from: docu.id }));
                        ag.classList.add("dragging");
                    });
                    ag.addEventListener("dragend", () => ag.classList.remove("dragging"));
                }

                agentDiv.appendChild(ag);
        });

            div.addEventListener("dragover", e => e.preventDefault()); // obligatoire pour drop
div.addEventListener("drop", async e => {
    e.preventDefault(); 
    if(!isCSU) return;

    const data = JSON.parse(e.dataTransfer.getData("text/plain"));
    const agentObj = data.agent;
    const toRef = doc(db, "vacations", docu.id);

    if(data.from === docu.id) return; // m√™me vacation, rien √† faire

    if(data.from === "waiting") {
    const waitingRef = doc(db, "dispatch", "waiting");
    await updateDoc(toRef, { agents: arrayUnion(agentObj.id) });
    await updateDoc(waitingRef, { agents: arrayRemove(agentObj.id) });
    await updateDoc(doc(db, "agents", agentObj.id), { inWaiting: false, inVacation: docu.id });
} else {
    const fromRef = doc(db, "vacations", data.from);
    await updateDoc(toRef, { agents: arrayUnion(agentObj) });
    await updateDoc(fromRef, { agents: arrayRemove(agentObj) });
    await updateDoc(doc(db, "agents", agentObj.id), { inVacation: docu.id });
}

});


            div.appendChild(agentDiv);
            vacationsDiv.appendChild(div);
        });
    });
}

// REJOINDRE / QUITTER VACATION
async function rejoindreVacation(id){
    if(!currentUser) return;

    // Si l'agent est d√©j√† dans une vacation
    if(currentUser.inVacation) return alert("Vous √™tes d√©j√† dans une vacation !");

    // Si l'agent est en attente, le retirer de la liste d'attente
    if(currentUser.inWaiting){
    const ref = doc(db, "dispatch", "waiting");
    
    // R√©cup√®re les agents en attente
    const snap = await getDoc(ref);
    const waitingAgents = snap.data()?.agents || [];

    // Retire uniquement l'agent avec le m√™me id
    const newWaitingAgents = waitingAgents.filter(a => a.id !== currentUser.id);

    // Met √† jour la liste
    await updateDoc(ref, { agents: newWaitingAgents });

    // Mets √† jour l'√©tat local
    await updateDoc(doc(db,"agents",currentUser.id), { inWaiting: false });
    currentUser.inWaiting = false;
}


    // Rejoindre la vacation
    await updateDoc(doc(db,"vacations",id), { agents: arrayUnion(currentUser) });
    await updateDoc(doc(db,"agents",currentUser.id), { inVacation: id });
    currentUser.inVacation = id;
} 

async function quitterVacation(id){
    if(!currentUser) return;

    const vacRef = doc(db,"vacations",id);
    const snapVac = await getDoc(vacRef);
    const agents = snapVac.data()?.agents || [];

    // Retirer l'agent par ID
    const newAgents = agents.filter(a => a.id !== currentUser.id);
    await updateDoc(vacRef, { agents: newAgents });

    await updateDoc(doc(db,"agents",currentUser.id), { inVacation: null });
    currentUser.inVacation = null;

    // Reset v√©hicule si la vacation est vide
    if(newAgents.length === 0){
        const vehicules = snapVac.data().vehicules || [];
        for(let v of vehicules){
            if(v !== "Aucun"){ 
                await updateDoc(vacRef, { vehicules: ["Aucun"], statut: "Indisponible" });
            }
        }
    }
}




async function openMDT(){
    if(!currentUser) return alert("Vous devez √™tre connect√© !");

    showPage(pageMDT);        // Affiche le MDT
    checkAdmin();             // Montre le bouton admin si c'est un admin
    await initDispatch();     // Initialise dispatch si n√©cessaire
    await initVacations();    // Initialise vacations si n√©cessaire
    initCSU();                // Initialise le CSU
    loadWaiting();            // Recharge la liste d'attente
    loadVacations();          // Recharge les vacations
}

// ===== POINTEUSE =====
const pagePointeuse = document.getElementById("pagePointeuse");
const pointeuseInfo = document.getElementById("pointeuseInfo");
const pointeuseHistory = document.getElementById("pointeuseHistory");
const btnStartShift = document.getElementById("btnStartShift");
const btnEndShift = document.getElementById("btnEndShift");

// Ouvrir la pointeuse depuis l'accueil
document.getElementById("btnPointeuse").onclick = () => {
    showPage(pagePointeuse);
    loadPointeuse();
};

// Charger historique et total heures
function formatDateFR(dateStr) {
    if (!dateStr) return "-";
    const date = new Date(dateStr);
    return date.toLocaleString("fr-FR", { 
        year: "numeric", month: "2-digit", day: "2-digit", 
        hour: "2-digit", minute: "2-digit" 
    });
}

// --- Charger historique et total heures ---
async function loadPointeuse() {
    if (!currentUser) return;

    try {
        const docRef = doc(db, "agents", currentUser.id);
        const snap = await getDoc(docRef);
        if (!snap.exists()) return;

        const data = snap.data();
        const history = data.pointeuse || [];

        // --- Calcul du total ---
        let totalMs = history.reduce((acc, entry) => {
            if (entry.arrivee && entry.depart) {
                return acc + (new Date(entry.depart) - new Date(entry.arrivee));
            }
            return acc;
        }, 0);

        const heures = Math.floor(totalMs / 1000 / 60 / 60);
        const minutes = Math.floor((totalMs / 1000 / 60) % 60);
        pointeuseInfo.innerText = `Total travaill√© : ${heures}h ${minutes}m`;

        // --- Historique ---
        pointeuseHistory.innerHTML = "";
        history.forEach(entry => {
            const div = document.createElement("div");
            div.classList.add("pointeuse-entry"); // pour style CSS si besoin
            div.innerText = `Arriv√©e : ${formatDateFR(entry.arrivee)} | D√©part : ${formatDateFR(entry.depart)}`;
            pointeuseHistory.appendChild(div);
        });

        // --- Boutons ---
        const enService = history.length && !history[history.length-1].depart;
        btnStartShift.disabled = enService;
        btnEndShift.disabled = !enService;

    } catch (error) {
        console.error("Erreur lors du chargement de la pointeuse:", error);
        alert("Impossible de charger vos heures pour le moment.");
    }
}

// --- D√©but de service ---
btnStartShift.onclick = async () => {
    if (!currentUser) return;

    try {
        const now = new Date().toISOString();
        const docRef = doc(db, "agents", currentUser.id);
        await updateDoc(docRef, { pointeuse: arrayUnion({ arrivee: now, depart: null }) });
        loadPointeuse();
    } catch (error) {
        console.error("Erreur au d√©but du service:", error);
        alert("Impossible de d√©marrer votre service !");
    }
};

// --- Fin de service ---
btnEndShift.onclick = async () => {
    if (!currentUser) return;

    try {
        const docRef = doc(db, "agents", currentUser.id);
        const snap = await getDoc(docRef);
        const history = snap.data().pointeuse || [];

        if (!history.length) return alert("Aucun d√©but de service trouv√© !");
        const last = history[history.length - 1];

        if (last.depart) return alert("Vous n'√™tes pas en service !");
        
        // Met √† jour le dernier enregistrement
        history[history.length - 1] = { ...last, depart: new Date().toISOString() };
        await updateDoc(docRef, { pointeuse: history });

        loadPointeuse();
    } catch (error) {
        console.error("Erreur √† la fin du service:", error);
        alert("Impossible de terminer votre service !");
    }
};

btnAdmin.onclick = () => {
    showPage(adminHome);

    // üîπ Gestion affichage
    btnManageAccounts.style.display =
        isRecruiterRole || admins.includes(currentUser.id) ? "block" : "none";

    btnTotalHours.style.display =
        admins.includes(currentUser.id) ? "block" : "none";

    btnAllAgents.style.display =
        isTrainerRole || admins.includes(currentUser.id) ? "block" : "none";

    // üîπ CHANGER LES NOMS DES CARTES

    if (isRecruiterRole && !admins.includes(currentUser.id)) {
        btnManageAccounts.querySelector("h3").textContent = "Comptes";
        btnManageAccounts.querySelector("p").textContent = "G√©rer les comptes en attente";
    }

    if (isTrainerRole && !admins.includes(currentUser.id)) {
        btnAllAgents.querySelector("h3").textContent = "Tout les agents";
        btnAllAgents.querySelector("p").textContent = "Voir et modifier les formations";
    }

    if (admins.includes(currentUser.id)) {
        btnManageAccounts.querySelector("h3").textContent = "Comptes";
        btnManageAccounts.querySelector("p").textContent = "G√©rer les comptes en attente";

        btnAllAgents.querySelector("h3").textContent = "Tous les agents";
        btnAllAgents.querySelector("p").textContent = "Voir et modifier sanctions / formations";
    }
};


document.getElementById("btnBackToHome").onclick = () => {
    showPage(homePage);
    checkAdmin();
};

document.getElementById("btnManageAccounts").onclick = () => {
    showPage(pageAdmin);
    loadAdminAccounts();
};

btnBackAdmin.onclick = () => {
    showPage(adminHome);
};

document.getElementById("btnTotalHours").onclick = () => {
    showPage(pageTotalHours);
    loadTotalHours();
};

btnBackAdminHome.onclick = () => {
    showPage(adminHome);
};

document.getElementById("btnAllAgents").onclick = () => {
    showPage(pageAllAgents);
    loadAllAgents();
};

document.getElementById("btnBackAllAgents").onclick = () => {
    showPage(adminHome);
};

btnBackAgentDetail.onclick = () => {
    showPage(pageAllAgents);
};


let currentSort = "hours"; // par d√©faut : tri par heures

// ‚ö° Ajouter l'√©v√©nement au bouton existant
const sortButton = document.getElementById("sortButton");
sortButton.onclick = (e) => {
    e.preventDefault(); // ‚ùå emp√™che le reload ou flash
    currentSort = currentSort === "hours" ? "grade" : "hours";
    sortButton.innerText = currentSort === "hours" ? "üì∂ Trier par grade" : "‚è± Trier par heures";
    loadTotalHours();
};


async function loadTotalHours() {
    totalHoursList.innerHTML = "";

    const snap = await getDocs(collection(db, "agents"));
    const agentsArray = [];

    snap.forEach(docu => {
        const data = docu.data();
        const history = data.pointeuse || [];

        let totalMs = 0;
        history.forEach(entry => {
            if (entry.arrivee && entry.depart) {
                totalMs += new Date(entry.depart) - new Date(entry.arrivee);
            }
        });

        agentsArray.push({
            id: docu.id,
            data,
            history,
            totalMs
        });
    });

    // üîπ TRI selon le crit√®re actuel
    if (currentSort === "hours") {
        agentsArray.sort((a, b) => b.totalMs - a.totalMs);
    } else if (currentSort === "grade") {
        agentsArray.sort((a, b) => sortByGrade(a.data, b.data));
    }

    // üîπ AFFICHAGE APR√àS TRI
    agentsArray.forEach(agent => {
        const { data, history, totalMs, id } = agent;
        const heures = Math.floor(totalMs / 1000 / 60 / 60);
        const minutes = Math.floor((totalMs / 1000 / 60) % 60);

        const div = document.createElement("div");
        div.className = "agent";
        div.style.cursor = "pointer";
        div.style.padding = "10px";
        div.style.background = "#1f2937";
        div.style.borderRadius = "8px";
        div.style.marginBottom = "10px";
        div.innerText = `${data.prenom} ${data.nom} - ${data.grade} | ${heures}h ${minutes}m`;

        div.onclick = async () => {
            const oldPopup = document.getElementById("adminPointeusePopup");
            if (oldPopup) oldPopup.remove();

            const popup = document.createElement("div");
            popup.id = "adminPointeusePopup";
            popup.style.position = "fixed";
            popup.style.top = "50%";
            popup.style.left = "50%";
            popup.style.transform = "translate(-50%, -50%)";
            popup.style.width = "350px";
            popup.style.maxHeight = "400px";
            popup.style.overflowY = "auto";
            popup.style.background = "#1f2937";
            popup.style.padding = "20px";
            popup.style.borderRadius = "10px";
            popup.style.boxShadow = "0 0 15px rgba(0,0,0,0.5)";
            popup.style.zIndex = 2000;
            popup.style.color = "white";

            const closeBtn = document.createElement("span");
            closeBtn.innerText = "‚úñ";
            closeBtn.style.cursor = "pointer";
            closeBtn.style.float = "right";
            closeBtn.style.fontWeight = "bold";
            closeBtn.onclick = () => popup.remove();
            popup.appendChild(closeBtn);

            const title = document.createElement("h4");
            title.innerText = `Pointeuse de ${data.prenom} ${data.nom}`;
            title.style.marginTop = "0";
            popup.appendChild(title);

            history.forEach((entry, index) => {
                const arrivee = entry.arrivee ? new Date(entry.arrivee).toLocaleString("fr-FR") : "-";
                const depart = entry.depart ? new Date(entry.depart).toLocaleString("fr-FR") : "-";

                const entryDiv = document.createElement("div");
                entryDiv.style.display = "flex";
                entryDiv.style.justifyContent = "space-between";
                entryDiv.style.alignItems = "center";
                entryDiv.style.marginTop = "10px";
                entryDiv.innerText = `Arriv√©e : ${arrivee} | D√©part : ${depart}`;

                if (!entry.depart) {
                    const stopBtn = document.createElement("button");
                    stopBtn.textContent = "üî¥ Terminer le service";
                    stopBtn.style.marginLeft = "10px";
                    stopBtn.onclick = async () => {
                        history[index] = { ...entry, depart: new Date().toISOString() };
                        await updateDoc(doc(db, "agents", id), { pointeuse: history });
                        alert("Service termin√© !");
                        popup.remove();
                        loadTotalHours();
                    };
                    entryDiv.appendChild(stopBtn);
                }

                popup.appendChild(entryDiv);
            });

            document.body.appendChild(popup);
        };

        totalHoursList.appendChild(div);
    });
}




const btnResetHours = document.getElementById("btnResetHours");

btnResetHours.onclick = async () => {
    if(!confirm("Voulez-vous vraiment r√©initialiser les heures de tous les agents ?")) return;

    const snap = await getDocs(collection(db,"agents"));

    for(const docu of snap.docs){
        await updateDoc(doc(db,"agents",docu.id), { pointeuse: [] });
    }

    loadTotalHours(); // recharge la page pour afficher tout vide
};


document.getElementById("btnBackHomeFromMDT").onclick = () => {
    showPage(homePage);
    checkAdmin(); // pour remettre le bouton admin si n√©cessaire
};

document.getElementById("btnBackHomeFromPointeuse").onclick = () => {
    showPage(homePage);
    checkAdmin(); // pour remettre le bouton admin si l‚Äôutilisateur est admin
};


async function loadAllAgents(){
    const list = document.getElementById("allAgentsList");
    list.innerHTML = "";

    const snap = await getDocs(collection(db, "agents"));

    if(snap.empty){
        const span = document.createElement("span");
        span.innerText = "Aucun agent trouv√©.";
        list.appendChild(span);
        return;
    }

    // Stocke tous les agents dans un tableau
    const agents = snap.docs.map(docu => ({ id: docu.id, ...docu.data() }));

    // Trie par grade
    agents.sort(sortByGrade);

    // Affiche les agents tri√©s
    agents.forEach(data => {
        const div = document.createElement("div");
        div.className = "agent";
        div.style.cursor = "pointer";
        div.style.padding = "10px";
        div.style.background = "#1f2937";
        div.style.borderRadius = "8px";
        div.innerText = `${data.prenom} ${data.nom} - ${data.grade}`;

        div.onclick = () => openAgentDetail(data.id, data);

        list.appendChild(div);
    });
}


async function openAgentDetail(id) { // async ajout√©, plus besoin de param√®tre data
    // ‚ö° R√©cup√©rer les donn√©es √† jour depuis Firestore
    const docSnap = await getDoc(doc(db, "agents", id));
    if (!docSnap.exists()) return alert("Agent introuvable");
    const data = docSnap.data();
    data.id = id; // utile pour updateDoc plus tard
    const isTrainerRole = currentUser && trainers.includes(currentUser.id);


    showPage(pageAgentDetail);

    const formattedDate = data.arrivalDate
        ? new Date(data.arrivalDate).toLocaleDateString("fr-FR", {
            day: "2-digit",
            month: "long",
            year: "numeric"
        })
        : "Non renseign√©e";

    // Sanctions existantes
    let sanctions = data.sanctions || [];
    let notes = data.notes || [];

    function renderNotes() {
  if (!notes.length) return `<p>Aucune note</p>`;

  return `
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
      ${notes.map((n, index) => `
        <div style="background:#111827; padding:8px; border-radius:6px; display:flex; justify-content:space-between;">
          <span>${n.texte} <small style="color:#9ca3af;">(${n.date})</small></span>
          <button onclick="removeNote(${index})"
            style="background:#dc2626; color:white; border:none; padding:4px 6px; border-radius:4px; cursor:pointer;">
            üóëÔ∏è
          </button>
        </div>
      `).join("")}
    </div>
  `;
}




      // ‚ö° Fonction pour supprimer une sanction
window.removeSanction = async (index) => {
    sanctions.splice(index, 1); // supprime la sanction du tableau
    await updateDoc(doc(db, "agents", data.id), { sanctions }); // met √† jour Firestore
    document.getElementById("sanctionsList").innerHTML = renderSanctions(); // rafra√Æchit l'affichage
    document.getElementById("sanctionsList").appendChild(sanctionDiv);
};


    // ‚ö° Fonction pour afficher les sanctions (d√©j√† existante)
    function renderSanctions() {
    if (!sanctions.length) return `<p>Aucune sanction</p>`;

    return `
    <div style="margin-top:10px; overflow-x:auto;">
      <table style="width:100%; border-collapse: collapse; text-align:left; background:#111827; color:white; border-radius:8px; overflow:hidden;">
        <thead style="background:#1f2937;">
          <tr>
            <th style="padding:8px 12px;">Type</th>
            <th style="padding:8px 12px;">Raison</th>
            <th style="padding:8px 12px;">Date</th>
            <th style="padding:8px 12px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${sanctions.map((s, index) => `
            <tr style="border-bottom: 1px solid #333;">
              <td style="padding:8px 12px;">${s.type}</td>
              <td style="padding:8px 12px;">${s.raison}</td>
              <td style="padding:8px 12px; color:#f87171;">${s.date || ''}</td>
              <td style="padding:8px 12px;">
                <button onclick="removeSanction(${index})"
                  style="background:#dc2626; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    `;
}



    // ‚ö° Ici on met le code formations
    function renderFormations() {

    const formations = data.formations || [];

    const formationsPossibles = [
        "Call Radio",
        "PPA Th√©orique",
        "Formation Finale",
        "PPA Pratique",
        "APJA"
    ];

    return `
<div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
    ${formationsPossibles.map(f => {
        const found = formations.find(x => x.nom === f);

        return `
        <div class="formation-row" 
             style="display:flex; justify-content:space-between; align-items:center; padding:6px 10px; background:#111827; border-radius:8px;">

            <span>
                ${f}
                ${found ? `<small style="color:#16a34a; margin-left:8px;">(${found.date})</small>` : ""}
            </span>

            <label class="switch" style="transform: scale(1.5);"> <!-- agrandi le switch -->
                <input type="checkbox"
                       ${found ? "checked" : ""}
                       onchange="toggleFormation('${f}')">
                <span class="slider"></span>
            </label>
        </div>
        `;
    }).join("")}
</div>
`;
}




window.toggleFormation = async (formation) => {
    let formations = data.formations || [];

    const today = new Date().toLocaleDateString("fr-FR");

    const index = formations.findIndex(f => f.nom === formation);

    if (index !== -1) {
        formations.splice(index, 1);
    } else {
        formations.push({
            nom: formation,
            date: today
        });
    }

    data.formations = formations;

    await updateDoc(doc(db, "agents", data.id), { formations });

    document.getElementById("FormationsList").innerHTML = renderFormations();
};


window.removeNote = async (index) => {
  notes.splice(index, 1);
  await updateDoc(doc(db, "agents", data.id), { notes });
  document.getElementById("notesItems").innerHTML = renderNotes();
};


window.addNote = async () => {
  const input = document.getElementById("noteInput");
  const texte = input.value.trim();

  if (!texte) return alert("√âcris une note");

  const today = new Date().toLocaleDateString("fr-FR");

  notes.push({
    texte,
    date: today
  });

  await updateDoc(doc(db, "agents", data.id), { notes });

  document.getElementById("notesItems").innerHTML = renderNotes();
  input.value = "";
};



    // ‚ö° Contenu HTML
    agentDetailContent.innerHTML = `
  <div class="card card-blue">
    <h3>${data.prenom} ${data.nom}</h3>

     ${currentUser && admins.includes(currentUser.id) ? `
      <button id="deleteAgentBtn"
              style="
                position:absolute;
                top:10px;
                right:10px;
                background:#dc2626;
                color:white;
                border:none;
                padding:4px 8px;
                border-radius:5px;
                cursor:pointer;
              ">
        üóëÔ∏è
      </button>` : ``}

    <div style="display:flex; align-items:center; gap:5px;"> 
  <strong>Grade :</strong>
  <span id="gradeText">${data.grade}</span>

  ${!isTrainerRole ? `
  <div style="position:relative; display:inline-block; margin-left:5px;">
    <button id="gradeMenuBtn"
      style="
        background:none;
        border:none;
        cursor:pointer;
        font-weight:bold;
        padding:0;
        line-height:1;
      ">
      ‚Ä¶
    </button>

    <div id="gradeMenu" style="
        display:none;
        position:absolute;
        top:100%;   
        right:0;    
        background:#111827;
        color:white;
        border:1px solid #333;
        padding:8px;
        border-radius:6px;
        z-index:1000;
        width:220px;
        margin-top:4px;
    ">
      <select id="gradeSelect" style="width:100%;">
        ${gradeOrder.map(g => `<option value="${g}" ${g === data.grade ? "selected" : ""}>${g}</option>`).join('')}
      </select>
      <button id="gradeSaveBtn" style="
          margin-top:5px;
          background:#16a34a; 
          color:white; 
          border:none; 
          padding:4px 8px; 
          border-radius:4px; 
          cursor:pointer;
          width:100%;
        ">
        Valider
      </button>
    </div>
  </div>
  ` : ``}
</div>


${currentUser && admins.includes(currentUser.id) ? `
<!-- CHECKBOX ADMIN -->
<div style="margin-top:10px; border-top:1px solid #333; padding-top:8px;">
  <strong>R√¥le :</strong>
  <label style="display:inline-block; margin-left:10px; margin-right:15px;">
    <input type="checkbox" id="roleFormateur" ${data.formateur ? 'checked' : ''} />
    Formateur
  </label>
  <label style="display:inline-block;">
    <input type="checkbox" id="roleRecruteur" ${data.recruteur ? 'checked' : ''} />
    Recruteur
  </label>
</div>
` : ``}



<p><strong>Date arriv√©e :</strong> ${formattedDate}</p>

    <hr style="border:none; height:3px; background:#555; margin:10px 0;">

    <!-- Onglets -->
    <div style="display:flex; gap:10px; margin-bottom:10px;">
  <button id="tabFormations">Formations</button>

  ${!isTrainerRole ? `
    <button id="tabSanctions">Sanctions</button>
    <button id="tabNotes">Notes</button>
    <button id="tabGradeHistory">Historique Grades</button>
  ` : ``}
</div>



    <!-- Contenus -->
<div id="tabContent">

  <div id="FormationsList">
    ${renderFormations()}
  </div>

  <div id="sanctionsList" style="display:none;">
    <div id="sanctionsItems">${renderSanctions()}</div>
    <div id="sanctionFormContainer"></div>
  </div>

  <div id="notesList" style="display:none;">
  <div id="notesItems">${renderNotes()}</div>

  <div style="display:flex; gap:10px; margin-top:10px;">
    <input id="noteInput" placeholder="Ajouter une note..."
      style="flex:1; padding:6px; border-radius:6px; border:none;">

    <button id="addNoteBtn"
      style="background:#2563eb; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
      Ajouter
    </button>
  </div>
</div>
<div id="gradeHistoryList" style="display:none;"></div>
</div>
</div>
`;

document.getElementById("gradeHistoryList").innerHTML = renderGradeHistory();


document.getElementById("tabFormations").onclick = () => {
  FormationsList.style.display = "block";
  sanctionsList.style.display = "none";
  notesList.style.display = "none";
  gradeHistoryList.style.display = "none";
};

document.getElementById("tabSanctions").onclick = () => {
  FormationsList.style.display = "none";
  sanctionsList.style.display = "block";
  notesList.style.display = "none";
  gradeHistoryList.style.display = "none";
};

document.getElementById("tabNotes").onclick = () => {
  FormationsList.style.display = "none";
  sanctionsList.style.display = "none";
  notesList.style.display = "block";
  gradeHistoryList.style.display = "none";
};

document.getElementById("tabGradeHistory").onclick = () => {
  FormationsList.style.display = "none";
  sanctionsList.style.display = "none";
  notesList.style.display = "none";
  gradeHistoryList.style.display = "block";
  gradeHistoryList.innerHTML = renderGradeHistory();
};


const formateurCheck = document.getElementById("roleFormateur");
const recruteurCheck = document.getElementById("roleRecruteur");

if (currentUser && admins.includes(currentUser.id)) {
    // Admin connect√© ‚Üí peut cocher/d√©cocher
    formateurCheck.disabled = false;
    recruteurCheck.disabled = false;

    formateurCheck.onchange = async (e) => {
        const value = e.target.checked;
        await updateDoc(doc(db, "agents", data.id), { formateur: value });
        data.formateur = value;
    };

    recruteurCheck.onchange = async (e) => {
        const value = e.target.checked;
        await updateDoc(doc(db, "agents", data.id), { recruteur: value });
        data.recruteur = value;
    };
} else {
    // Pas admin ‚Üí d√©sactiv√©
    formateurCheck.disabled = true;
    recruteurCheck.disabled = true;
}









const deleteBtn = document.getElementById("deleteAgentBtn");
if (deleteBtn) {
    deleteBtn.onclick = async () => {
        const confirmDelete = confirm(`Voulez-vous vraiment supprimer ${data.prenom} ${data.nom} ?`);
        if (!confirmDelete) return;

        try {
            await deleteDoc(doc(db, "agents", data.id));
            alert("Agent supprim√© !");
            showPage(adminHome);
            loadAllAgents(); // rafra√Æchir la liste si tu as une fonction existante
        } catch (err) {
            console.error(err);
            alert("Erreur lors de la suppression.");
        }
    };
}


const gradeBtn = document.getElementById("gradeMenuBtn");
const gradeMenu = document.getElementById("gradeMenu");
const gradeSelect = document.getElementById("gradeSelect");
const gradeText = document.getElementById("gradeText");
const gradeSave = document.getElementById("gradeSaveBtn");

// Afficher / cacher le menu
gradeBtn.onclick = (e) => {
    e.stopPropagation(); // emp√™che la fermeture instantan√©e
    gradeMenu.style.display = gradeMenu.style.display === "block" ? "none" : "block";
};

// Fermer le menu si clic √† l‚Äôext√©rieur
document.addEventListener("click", (e) => {
    if (!gradeMenu.contains(e.target) && e.target !== gradeBtn) {
        gradeMenu.style.display = "none";
    }
});

// Sauvegarder le grade
gradeSave.onclick = async () => {
    const newGrade = gradeSelect.value;
    const oldGrade = data.grade;

    if (newGrade === oldGrade) return;

    const today = new Date().toLocaleDateString("fr-FR");

    const newHistoryEntry = {
        oldGrade: oldGrade,
        newGrade: newGrade,
        date: today
    };

    const gradeHistory = data.gradeHistory || [];
    gradeHistory.push(newHistoryEntry);

    gradeText.textContent = newGrade;
    gradeMenu.style.display = "none";

    await updateDoc(doc(db, "agents", data.id), {
        grade: newGrade,
        gradeHistory: gradeHistory
    });

    data.grade = newGrade;
    data.gradeHistory = gradeHistory;

    alert("Grade mis √† jour !");
};





    // ‚ö° Ajouter une nouvelle sanction
    const sanctionDiv = document.createElement("div");
    sanctionDiv.style.display = "flex";
    sanctionDiv.style.gap = "10px";
    sanctionDiv.style.marginTop = "10px";

    const typeSelect = document.createElement("select");
    ["Avertissement oral", "Avertissement √©crit", "Bl√¢me", "Mise √† pied", "Licenciement"].forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        typeSelect.appendChild(opt);
    });

    const reasonInput = document.createElement("input");
    reasonInput.placeholder = "Raison";
    reasonInput.style.flex = "1";

    const btnAdd = document.createElement("button");
    btnAdd.textContent = "Ajouter";
    btnAdd.style.background = "#dc2626";
    btnAdd.style.color = "white";
    btnAdd.style.border = "none";
    btnAdd.style.padding = "6px 10px";
    btnAdd.style.borderRadius = "5px";
    btnAdd.style.cursor = "pointer";

    btnAdd.onclick = async () => {
    const type = typeSelect.value;
    const raison = reasonInput.value.trim();
    if (!raison) return alert("Veuillez indiquer une raison");

    const newSanction = { 
        type, 
        raison,
        date: new Date().toLocaleDateString("fr-FR")
    };

    sanctions.push(newSanction);

    await updateDoc(doc(db, "agents", data.id), { sanctions });

    // ‚úÖ Mettre √† jour seulement la liste
    document.getElementById("sanctionsItems").innerHTML = renderSanctions();

    reasonInput.value = "";
    typeSelect.selectedIndex = 0;
    alert("Sanction ajout√©e !");
};


    sanctionDiv.appendChild(typeSelect);
    sanctionDiv.appendChild(reasonInput);
    sanctionDiv.appendChild(btnAdd);
    if (!isTrainerRole) {
    document.getElementById("sanctionsList").appendChild(sanctionDiv);
}
    document.getElementById("addNoteBtn").onclick = addNote;

    function renderGradeHistory() {
        const history = data.gradeHistory || [];
        if (!history.length) return "<p>Aucun changement de grade</p>";

        return `
        <div style="display:flex; flex-direction:column; gap:6px; margin-top:10px;">
            ${history.map(h => `
            <div style="background:#111827; padding:6px 10px; border-radius:6px; display:flex; justify-content:space-between;">
                <span>
                    ${h.oldGrade} ‚Üí ${h.newGrade} 
                    <small style="color:#9ca3af;">(${h.date})</small>
                </span>
            </div>
            `).join("")}
        </div>
        `;
    }

}


</script>
</body>
</html>
