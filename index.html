<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Intranet Brigade Municipale</title>
<style>
    
body{
    
    font-family:Segoe UI, sans-serif;
    background:#1c2b49;
    color:white;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
}
 
.container{
    width:450px;
    background:#111827;
    padding:30px;
    border-radius:15px;
    display:flex;
    flex-direction:column;
    gap:15px;
}
h2{text-align:center;}
input,button,select{
    padding:12px;
    border-radius:8px;
    border:none;
    font-size:14px;
}
button{
    background:#2563eb;
    color:white;
    cursor:pointer;
    transition:0.2s;
}
button:hover{background:#1e40af;}
a{
    color:#2563eb;
    cursor:pointer;
    text-decoration:underline;
    text-align:center;
    margin-top:10px;
}
#mdt{
    display:none;
    flex:1;
    width:100%;
    height:100vh;
    flex-direction:row;
}
.sidebar{
    width:260px;
    background:#020617;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:15px;
}

#joinCSU {
    margin-top: 10px; /* espace entre le texte et le bouton */
}

#leaveCSU {
    margin-top: 10px; /* espace entre le texte et le bouton */
}

.main{
    flex:1;
    display:flex;
    padding:30px;
    gap:30px;
    overflow-y:auto;
}

/* Carte normale (hover effect) */
.card {
    background:#0a0f1a;
    padding:20px;
    border-radius:15px;
    position: relative;
    border: 1px solid rgba(59, 130, 246, 0.3);
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    transition: 
        transform 0.35s ease,
        box-shadow 0.35s ease,
        border 0.35s ease,
        opacity 0.35s ease;
    opacity: 1;
}

.card:hover {
    transform: translateY(-10px) scale(1.02);
    box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
    border: 1px solid rgba(59, 130, 246, 0.9);
}

/* Cartes ‚Äúpro‚Äù fixes, bordure bleue, pas d‚Äôanimation hover */
.card-blue {
    border: 2px solid #3b82f6; /* bleu vif */
    box-shadow: 0 4px 10px rgba(59,130,246,0.2); /* l√©g√®re ombre */
    transform: none; /* pas de d√©placement au hover */
}

.card-blue:hover {
    transform: none; /* aucun effet hover */
    box-shadow: 0 4px 10px rgba(59,130,246,0.2); /* reste constant */
    border: 2px solid #3b82f6; /* reste bleu */
}










.vacations{
    flex:2;
    display:flex;
    flex-direction:column;
    gap:20px;
}
.waiting{
    flex:1;
}
.agent{
    background:#1f2937;
    padding:6px;
    border-radius:6px;
    margin-top:5px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.csu{
    background:#f59e0b;
    padding:10px;
    border-radius:8px;
    margin-bottom:10px;
}
.csu-button{
    background:#dc2626;
    margin-left:5px;
    padding:4px 6px;
    border-radius:5px;
}
.agent.dragging{opacity:0.5;}


.waiting{
    display:flex;
    flex-direction:column;
    gap:20px;
}

/* Bloc attente */
.waiting > .card:first-child{
    min-height:400px; /* taille minimum */
}

/* Bloc formateurs */
.waiting .trainers{
    min-height:150px;
}


#adminHome {
    display: none;
    flex-direction: column;
    align-items: center;
    width: 90%;
    max-width: 1000px;
}

.admin-grid {
    display: flex;                  /* Flexbox au lieu de Grid */
    flex-wrap: wrap;                /* Permet plusieurs lignes si n√©cessaire */
    justify-content: center;        /* Centre les cartes sur la ligne */
    gap: 25px;                      /* espace entre les cartes */
    width: 100%;
    max-width: 800px;
}


/* Pour l‚Äôadmin uniquement : derni√®re carte occupe toute la largeur */
.admin-grid.admin #btnAllAgents {
    grid-column: 1 / -1;
}

#adminHome .card {
    flex: 1 1 260px; /* largeur min 260px, mais peut grandir pour remplir l‚Äôespace */
    display: flex;
    flex-direction: column;
    text-align: center;
}

.card-text {
    display: block;      /* assure que le texte reste sur sa ligne */
    margin-top: 10px;    /* espace entre le titre et le texte */
}



#btnAllAgents {
    flex: 1 1 100%;                /* prend toute la largeur disponible */
}


h1 {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 3rem;
    font-weight: 700;
    text-align: center;
    color: #1e40af; /* bleu professionnel */
    letter-spacing: 1px;
    margin: 40px 0 20px 0;
    text-transform: uppercase;
    position: relative;
}

/* Ligne d√©corative sous le titre */
h1::after {
    content: '';
    display: block;
    width: 80px;
    height: 4px;
    background-color: #2563eb; /* bleu vif pour accent */
    margin: 12px auto 0 auto;
    border-radius: 2px;
}

#btnAdmin {
    display: none;
    position: fixed;
    top: 15px;
    right: 15px;
    z-index: 1000;
    padding: 10px 15px;
    border-radius: 8px;
    background: #2563eb;
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: transform 0.25s ease-in-out, box-shadow 0.25s ease-in-out;
}

#btnAdmin:hover {
    background: linear-gradient(135deg, #2563eb, #3b82f6); /* reste instantan√© */
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(37, 99, 235, 0.4);
}

#pageReglement #mainTitle {
    display: none;
}



/* ======================= G√âN√âRAL ======================= */
#pageProcedures {
    display: none;
    flex-direction: column;
    align-items: center;
    width: 90%;
    max-width: 900px;
    margin: 20px auto;
    background: #111827;
    padding: 20px;
    border-radius: 10px;
    color: white;
    max-height: 90vh;
    overflow-y: auto;
    font-family: Arial, sans-serif;
    font-size: 0.95rem;
    line-height: 1.4;
}

/* Masque la scrollbar sur Chrome, Safari et Edge */
#pageProcedures::-webkit-scrollbar,
#procOutput::-webkit-scrollbar {
    display: none;
}

/* ======================= TITRES ======================= */
#pageProcedures h2 {
    font-size: 1.6rem;
    text-align: center;
    margin-bottom: 20px;
}

#pageProcedures h3 {
    font-size: 1.2rem;
    margin-bottom: 12px;
    text-align: left; /* titres en haut √† gauche */
}

#pageProcedures h4 {
    font-size: 1rem;
    margin-bottom: 6px;
}

/* ======================= STEP ======================= */
.step {
    display: none;
    flex-direction: column;
    gap: 15px;
    width: 100%;
}

.step.active {
    display: flex;
}

/* ======================= FORMULAIRES ======================= */
#pageProcedures input,
#pageProcedures select,
#pageProcedures textarea {
    font-size: 0.95rem;
    padding: 8px 10px;
    border-radius: 6px;
    border: none;
    background: #1f2937;
    color: white;
    width: 100%;
    box-sizing: border-box;
}

#pageProcedures textarea {
    resize: vertical;
    min-height: 60px;
}

/* ======================= BOUTONS ======================= */
#pageProcedures button {
    font-size: 0.95rem;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    border: none;
    transition: 0.2s;
}

#pageProcedures button:hover {
    opacity: 0.9;
}

/* Couleurs sp√©cifiques pour les boutons */
#validateID,
#validateFouille,
#validateDroits,
#procGenerateBtn {
    background: #2563eb;
    color: white;
}

#copyDiscordBtn {
    background: #10b981;
    color: white;
}



/* ======================= ACCORD√âON ======================= */
.accordion-category {
    margin-bottom: 10px;
    background: #1f2937;
    border-radius: 8px;
    overflow: hidden;
}

.accordion-header {
    cursor: pointer;
    font-weight: 600;
    padding: 10px;
    user-select: none;
    border-bottom: 1px solid #374151;
    background: #1f2937;
    font-size: 1rem;
}

.accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    display: flex;
    flex-direction: column;
    gap: 5px;
    padding: 0 10px;
}

.accordion-content.active {
    max-height: 400px;
    padding: 10px 10px 10px 10px;
}

/* ======================= DROITS ======================= */
#droitsContainer label {
    font-size: 1rem;
}

/* ======================= RAPPORT ======================= */
#procOutput {
    font-size: 1rem;
    padding: 15px;
    border-radius: 10px;
    background: #1f2937;
    white-space: pre-line;
    min-height: 150px;
}


/* ======================= TOAST ======================= */
.toast {
    position: fixed;
    top: 15px;      /* distance depuis le haut */
    left: 20px;     /* distance depuis la gauche */
    transform: none; /* on n'a plus besoin de centrer horizontalement */
    background: #10b981;
    color: white;
    padding: 15px 25px;
    border-radius: 10px;
    font-size: 1rem;
    display: none;
    z-index: 1000;
}


.toast.show {
    display: block;
}




/* Step 3 - Lecture des droits et droits exerc√©s */
#step3 .lectureText {
    background: #1f2937;
    color: #fff;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 15px;
    line-height: 1.5;
}

#step3 label {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    cursor: pointer;
}

#step3 input[type="checkbox"] {
    width: 18px;
    height: 18px;
    margin: 0;
}

#presenceAvocatContainer {
    display: none; /* reste cach√© tant que Avocat non coch√© */
    margin-left: 20px;
    margin-bottom: 10px;
}

#presenceAvocatContainer label {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.multiplicateur-input {
    border-radius: 6px;
    border: 1px solid #ccc;
}




.confirm-box {
    position: fixed;
    top: 20px;       /* distance depuis le haut */
    left: 20px;     /* distance depuis la droite */
    background: none; /* plus d‚Äôoverlay noir */
    display: none;
    z-index: 2000;
}

.confirm-box.show {
    display: flex;
}

.confirm-content {
    background: #1f2937;
    padding: 20px;
    border-radius: 12px;
    width: 320px;
    color: white;
    text-align: center;
}

.confirm-actions {
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
}

.confirm-actions button {
    flex: 1;
    margin: 0 5px;
    padding: 10px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

#confirmYes {
    background: #ef4444;
    color: white;
}

#confirmNo {
    background: #374151;
    color: white;
}



.confirm-box.show {
    display: block;
    animation: slideInRight 0.3s ease;
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(50px); }
    to { opacity: 1; transform: translateX(0); }
}




/* Container principal */
#pageTotalHours {
    display: none;               /* reste masqu√© au d√©part */
    flex-direction: column;      /* colonnes pour titre, recherche, liste, boutons */
    align-items: center;         /* centr√© horizontalement */
    justify-content: flex-start; /* commence par le haut */
    padding: 30px;               /* padding g√©n√©ral */
    max-width: 800px;
    min-height: 80vh;            /* garde le container presque plein √©cran */
    margin: 20px auto;           /* centr√© horizontalement */
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    border-radius: 12px;
    background: #111827;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}



/* Titre */
#pageTotalHours h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #f3f4f6;
}

/* Barre de recherche */
#pageTotalHours > .search-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
    width: 100%;
}

#searchAgent {
    flex: 1;
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #1f2937;
    color: #f3f4f6;
}

/* Bouton tri */
#sortButton {
    margin-bottom: 15px;
    padding: 8px 15px;
    border-radius: 6px;
    cursor: pointer;
}

/* Wrapper scrollable pour la liste */

/* Wrapper du contenu sauf les boutons */
#totalHoursWrapper {
    flex-grow: 1; /* prend tout l‚Äôespace restant */
    width: 100%;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}


/* Bouton Reset heures en rouge */
#btnResetHours {
    margin-top: 20px;
    padding: 10px 15px;
    border-radius: 8px;
    background: #dc2626;      /* rouge de base */
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.25s ease-in-out;
}

/* Effet au survol */
#btnResetHours:hover {
    background: #b91c1c;      /* rouge plus fonc√© */
    transform: scale(1.03);   /* l√©ger agrandissement */
}
</style>
</head>
<body>
<h1 id="mainTitle" style="text-align:center; font-size:32px; color:#2563eb; margin-bottom:20px; margin-top:40px;">
    Intranet Brigade Municipale
</h1>
    <button id="btnAdmin">
    ‚öôÔ∏è Admin
    </button>



<div id="confirmBox" class="confirm-box">
    <div class="confirm-content">
        <p id="confirmText"></p>
        <div class="confirm-actions">
            <button id="confirmYes">Confirmer</button>
            <button id="confirmNo">Annuler</button>
        </div>
    </div>
</div>


<!-- INSCRIPTION -->
<div class="container" id="pageInscription" style="display:none;">
    <h2>Inscription</h2>
    <input id="rPrenom" placeholder="Pr√©nom">
    <input id="rNom" placeholder="Nom">
    <input id="rGrade" placeholder="Grade">
    <input id="rArrivalDate" type="date" placeholder="Date d'arriv√©e" />
    <input id="rPass" type="password" placeholder="Mot de passe">
    <button id="btnRegister">Cr√©er compte</button>
    <a id="linkToLogin">D√©j√† un compte ? Connexion</a>
</div>

<!-- LOGIN -->
<div class="container" id="pageLogin">
    <h2>Connexion</h2>
    <input id="lPrenom" placeholder="Pr√©nom">
    <input id="lNom" placeholder="Nom">
    <input id="lPass" type="password" placeholder="Mot de passe">
    <button id="btnLogin">Connexion</button>
    <a id="linkToRegister">Pas de compte ? Inscription</a>
</div>


<!-- TOAST GLOBAL -->
<div id="copyToast" class="toast"></div>

<!-- HOME APR√àS CONNEXION (Admin) -->
<div class="container" id="adminHome">
    <h2>Admin - Choisissez une option :</h2>

    <div class="admin-grid admin">
        <!-- Carte 1 -->
        <div class="card" id="btnManageAccounts" style="cursor:pointer; text-align:center;">
            <h3>Comptes</h3>
            <p>G√©rer les comptes en attente</p>
        </div>

        <!-- Carte 2 -->
        <div class="card" id="btnTotalHours" style="cursor:pointer; text-align:center;">
            <h3>Heures Totales</h3>
            <p>Voir les heures des agents</p>
        </div>

        <!-- Carte 3 pleine largeur -->
<div class="card" id="btnAllAgents" style="cursor:pointer; text-align:center;">
    <h3>Tous les agents</h3>
    <p class="card-text">Voir et modifier sanctions / formations</p>
</div>

    </div>

    <!-- Bouton retour -->
    <button id="btnBackToHome" 
        style="margin-top:30px; padding:12px 20px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Accueil
    </button>
</div>



<!-- HOME APR√àS CONNEXION (Agent) -->
<div class="container" id="homePage" 
     style="display:none; flex-direction:column; align-items:center; 
            width:90%; max-width:900px; margin:40px auto; 
            background:#111827; padding:40px; border-radius:12px; color:white;">

    <h2 style="margin-bottom:30px; text-align:center;">Bienvenue</h2>

    <div style="display:flex; 
                gap:40px; 
                flex-wrap:wrap; 
                justify-content:center; 
                width:100%;">

        <div class="card" id="btnMDT"
             style="cursor:pointer; 
                    flex:1 1 320px; 
                    text-align:center; 
                    padding:35px; 
                    background:#0a0f1a; 
                    border-radius:12px;">
            <h3 style="font-size:22px;">MDT / Dispatch</h3>
            <p style="font-size:16px;">Voir et g√©rer les vacations</p>
        </div>

        <div class="card" id="btnPointeuse"
             style="cursor:pointer; 
                    flex:1 1 320px; 
                    text-align:center; 
                    padding:35px; 
                    background:#0a0f1a; 
                    border-radius:12px;">
            <h3 style="font-size:22px;">Pointeuse</h3>
            <p style="font-size:16px;">G√©rer vos heures de service</p>
        </div>

        <div class="card" id="btnReglement"
     style="cursor:pointer; 
            flex:1 1 320px; 
            text-align:center; 
            padding:35px; 
            background:#0a0f1a; 
            border-radius:12px;">
    <h3 style="font-size:22px;">Brigade Municipale</h3>
    <p style="font-size:16px;">Information sur la Brigade Municipale</p>
</div>
</div>
</div>




<!-- PAGE BRIGADE MUNICIPALE -->
<div class="container" id="pageBrigade" 
     style="display:none; flex-direction:column; align-items:center; 
            width:90%; max-width:900px; margin:40px auto; 
            background:#111827; padding:40px; border-radius:12px; color:white;">

    <h2 style="margin-bottom:30px; text-align:center;">Brigade Municipale</h2>

    <div style="display:flex; gap:40px; flex-wrap:wrap; justify-content:center; width:100%;">

        <div class="card" id="btnTenues" style="cursor:pointer; flex:1 1 320px; text-align:center; padding:35px; background:#0a0f1a; border-radius:12px;">
            <h3 style="font-size:22px;">Tenues</h3>
            <p style="font-size:16px;">Voir les tenues r√©glementaires</p>
        </div>

        <div class="card" id="btnProcedures" style="cursor:pointer; flex:1 1 320px; text-align:center; padding:35px; background:#0a0f1a; border-radius:12px;">
            <h3 style="font-size:22px;">Proc√©dures</h3>
            <p style="font-size:16px;">Effectuer une proc√©dures internes</p>
        </div>

        <div class="card" id="btnReglementBrigade" style="cursor:pointer; flex:1 1 320px; text-align:center; padding:35px; background:#0a0f1a; border-radius:12px;">
            <h3 style="font-size:22px;">R√®glement</h3>
            <p style="font-size:16px;">Lire le r√®glement complet</p>
        </div>

    </div>

    <button id="btnBackHomeFromBrigade" style="margin-top:30px; padding:12px 20px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Accueil
    </button>

</div>



<!-- POINTEUSE -->
<div class="container" id="pagePointeuse" 
     style= "display:none; flex-direction:column; align-items:center; padding:30px; margin:20px auto 20px auto; max-width:600px; box-shadow:0 8px 20px rgba(0,0,0,0.3); border-radius:12px; background:#111827; transition: transform 0.3s ease, box-shadow 0.3s ease;">
    
    <h2 style="text-align:center; margin-bottom:20px; color:#f3f4f6;">Pointeuse</h2>

<div id="pointeuseInfo" style="margin-bottom:20px; font-weight:bold; color:#e5e7eb;"></div>

    <!-- Boutons service -->
    <button id="btnStartShift" 
        style="margin-bottom:10px; background:#16a34a; color:white; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#15803d'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#16a34a'; this.style.transform='scale(1)';">
        üü¢ D√©but de service
    </button>

    <button id="btnEndShift" 
        style="margin-bottom:20px; background:#dc2626; color:white; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#b91c1c'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#dc2626'; this.style.transform='scale(1)';">
        üî¥ Fin de service
    </button>

    <!-- Historique -->
    <div style="width:100%;">
        <h3 style="margin-bottom:10px; color:#f3f4f6;">Historique</h3>
        <div id="pointeuseHistory" style="display:flex; flex-direction:column; gap:8px; max-height:200px; overflow-y:auto; padding-right:5px;"></div>
    </div>

    <!-- Retour -->
    <button id="btnBackHomeFromPointeuse" 
        style="margin-top:20px; padding:10px 15px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Accueil
    </button>
</div>


<div class="container" id="pageProcedures"
     style="display:none; flex-direction:column; align-items:center; width:90%; max-width:900px; margin:40px auto; background:#111827; padding:40px; border-radius:12px; color:white; max-height:90vh; overflow-y:scroll;">

    <h2 style="margin-bottom:10px; text-align:center;">Proc√©dures internes</h2>

    <!-- ================= PAGE CHOIX ================= -->
<div class="step active" id="stepChoice">
    <h3 style="text-align:left; margin-bottom:20px; text-align: center;">Choisissez la proc√©dure</h3>
    <div style="display:flex; gap:30px; flex-wrap:wrap; margin-top:20px;">
        <div class="card" id="creationCasier" style="flex:1 1 320px; cursor:pointer; text-align:center;">
            <h3 style="font-size:22px; text-align: center;">Cr√©ation de casier</h3>
            <p style="font-size:16px; text-align: center;">Nouvelle proc√©dure compl√®te</p>
        </div>

        <div class="card" id="ajoutCasier" style="flex:1 1 320px; cursor:pointer; text-align:center;">
            <h3 style="font-size:22px; text-align: center;">Ajout de casier</h3>
            <p style="font-size:16px; text-align: center;">Passer directement √† la fouille</p>
        </div>

        <!-- Retour -->
    <button id="btnBackHomepageBrigade" 
        style="
    display:block;
    margin:30px auto 0 auto;
    padding:12px 20px; 
    border-radius:8px; 
    background:#2563eb; 
    color:white; 
    cursor:pointer; 
    font-weight:600; 
    transition: all 0.25s ease-in-out;"
    onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
    onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
    ‚¨ÖÔ∏è Accueil
</button>
    </div>
</div>


    <!-- ================= √âTAPE 1 (Cr√©ation casier) ================= -->
    <div class="step" id="step1">
        <h3 style="margin-top:5px; margin-bottom:15px;">Cr√©ation de casier</h3>
        <input id="procNom" placeholder="Nom">
        <input id="procPrenom" placeholder="Pr√©nom">
        <input id="procDOB" type="date" min="1900-01-01" max="2099-12-31">
        <input id="procTaille" type="number" placeholder="Taille (cm)" min="1" max="300" step="1">
        <select id="procSexe">
            <option value="">Sexe</option>
            <option value="M">M</option>
            <option value="F">F</option>
        </select>
        <input id="procTel" placeholder="Num√©ro de t√©l√©phone">
        <button id="validateID">Valider l'identit√©</button>

        <button id="btnBackcreaproc1" 
        style="
    display:block;
    margin:30px auto 0 auto;
    padding:12px 20px; 
    border-radius:8px; 
    background:#2563eb; 
    color:white; 
    cursor:pointer; 
    font-weight:600; 
    transition: all 0.25s ease-in-out;"
    onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
    onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
    ‚¨ÖÔ∏è Retour
</button>
        
    </div>

    <!-- ================= √âTAPE 2 (Fouille) ================= -->
    <div class="step" id="step2">
        <h3>Fouille de l'individu</h3>
        <textarea id="fouilleObservation" placeholder="R√©sultat de la fouille" style="height:100px;"></textarea>
        <button id="validateFouille">Continuer</button>
        <button id="btnBackcreaproc2" 
        style="
    display:block;
    margin:30px auto 0 auto;
    padding:12px 20px; 
    border-radius:8px; 
    background:#2563eb; 
    color:white; 
    cursor:pointer; 
    font-weight:600; 
    transition: all 0.25s ease-in-out;"
    onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
    onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
    ‚¨ÖÔ∏è Retour
</button>
    </div>

   <!-- ================= √âTAPE 3 (Lecture des droits) ================= -->
<div class="step" id="step3">
    <h3>Lecture des droits</h3>
    <div class="lectureText">
        Monsieur/Madame X, vous √™tes en √©tat d'arrestation pour [CHEF D'INCULPATION]. Sachez que ces chefs d'inculpations peuvent √™tre amen√©s √† changer durant la proc√©dure. Vous avez droit de garder le silence, tout ce que vous pourrez dire pourra √™tre retenu contre vous devant une cour de justice.<br><br>
        Vous avez le droit √† un avocat et d'avoir un avocat pr√©sent lors de l'interrogatoire. Si vous n'en avez pas les moyens, un avocat vous sera commis d'office.<br><br>
        Durant votre temps d'arrestation, vous avez droit √† des soins m√©dicaux ainsi que de la nourriture et de l'eau. Vous pouvez d√©cider √† n'importe quel moment d'exercer aucune de ces fonctions et de ne faire aucune d√©claration. Avez-vous bien compris vos droits Monsieur/Madame ?
    </div>

    <label>
        <input type="checkbox" id="lectureConfirm">
        Lecture des droits effectu√©e
    </label>

    <h3>Infractions retenues</h3>

<!-- Barre de recherche -->
<input type="text" id="searchInfractions" placeholder="Rechercher une infraction..." style="width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;">

<div id="infractionsList"></div>

    <h3>Droits exerc√©s</h3>
    <div id="droitsContainer">
        <label>
            <input type="checkbox" class="droitCheckbox" value="Avocat" id="chkAvocat">
            Avocat
        </label>
        <div id="presenceAvocatContainer">
            <strong>Pr√©sence avocat :</strong><br>
            <label>
                <input type="checkbox" id="presenceOui"> Oui
            </label>
            <label>
                <input type="checkbox" id="presenceNon"> Non
            </label>
        </div>
        <label>
            <input type="checkbox" class="droitCheckbox" value="Soins m√©dicaux">
            Soins m√©dicaux
        </label>
        <label>
            <input type="checkbox" class="droitCheckbox" value="√Ä boire et manger">
            √Ä boire et manger
        </label>
    </div>

    <div id="reconnaissanceContainer">
    <h3>Reconnaissance des faits :</h3>
    <label><input type="checkbox" name="reconnaissance" value="oui"> Oui</label>
    <label><input type="checkbox" name="reconnaissance" value="non"> Non</label>
    </div>


    <button id="validateDroits">Continuer vers le rapport</button>
    <button id="btnBackcreaproc3" 
        style="
    display:block;
    margin:30px auto 0 auto;
    padding:12px 20px; 
    border-radius:8px; 
    background:#2563eb; 
    color:white; 
    cursor:pointer; 
    font-weight:600; 
    transition: all 0.25s ease-in-out;"
    onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
    onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
    ‚¨ÖÔ∏è Retour
</button>
</div>


    <!-- ================= √âTAPE 4 (Rapport) ================= -->
    <div class="step" id="step4">
        <h3>Rapport final</h3>
        <!-- input cach√© pour APJ -->
<input id="procAPJ" type="text" style="display:none;">
        <textarea id="procObservation" placeholder="Observation de garde √† vue" style="height:80px;"></textarea>
        <textarea id="procRapport" placeholder="Rapport succinct de l'intervention" style="height:100px;"></textarea>
        <button id="procGenerateBtn" style="padding:10px; border-radius:8px; background:#2563eb; color:white; font-weight:600; cursor:pointer;">G√©n√©rer le rapport</button>
        <div id="procOutput" style="margin-top:20px; white-space:pre-line; background:#1f2937; padding:20px; border-radius:12px; min-height:200px;"></div>
        <button id="copyDiscordBtn" style="padding:10px; border-radius:8px; background:#10b981; color:white; font-weight:600; cursor:pointer; margin-top:10px;">Copier pour Discord</button>
        

        <!-- NOUVEAU BOUTON RETOUR -->
<button id="btnBackcreaproc4" 
    style="
    display:block;
    margin:30px auto 0 auto;
    padding:12px 20px; 
    border-radius:8px; 
    background:#2563eb; 
    color:white; 
    cursor:pointer; 
    font-weight:600; 
    transition: all 0.25s ease-in-out;"
    onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
    onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
    ‚¨ÖÔ∏è Retour
</button>



        <button id="btnBackcreaprocaccueil" 
        style="
    display:block;
    margin:30px auto 0 auto;
    padding:12px 20px; 
    border-radius:8px; 
    background:#2563eb; 
    color:white; 
    cursor:pointer; 
    font-weight:600; 
    transition: all 0.25s ease-in-out;"
    onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
    onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
    ‚¨ÖÔ∏è Accueil
</button>
    </div>

    <!-- Toast -->
    <div id="copyToast" class="toast">Texte copi√© pour Discord !</div>

</div>









<!-- PAGE R√àGLEMENT -->
<div id="pageReglement" style="
    display:none;
    flex-direction:column;
    background:#0a0f1a;
    color:white;
    min-height:100vh;
    max-height:100vh;
    padding:20px;
    border-radius:12px;
    overflow:hidden;  /* cache la scrollbar pour le conteneur principal */
    margin-top: 150px;
">


    <h1 style="text-align:center; margin-bottom:20px; margin-top: 10px;">üìò CODE DE D√âONTOLOGIE ‚Äì BRIGADE MUNICIPALE</h1>

    <!-- Conteneur scrollable pour tout le texte -->
    <div style="
        flex:1;
        overflow-y: scroll; /* scroll avec la souris */
        -ms-overflow-style: none;  /* IE et Edge */
        scrollbar-width: none;     /* Firefox */
        padding-right:10px;
    " onscroll="">

        <p><strong>La Brigade Municipale, plac√©e sous l‚Äôautorit√© comp√©tente pour les missions de s√©curit√© int√©rieure, agit dans le respect strict des lois et du Code de proc√©dure p√©nale.</strong><br>
        Elle assure :</p>
        <ul>
            <li>La d√©fense des institutions</li>
            <li>Le respect des lois</li>
            <li>Le maintien de l‚Äôordre public</li>
            <li>La protection des personnes et des biens</li>
            <li>Les policiers exercent leurs fonctions avec loyaut√©, honneur, impartialit√© et d√©vouement.</li>
        </ul>

        <h3>TITRE I ‚Äì PRINCIPES G√âN√âRAUX</h3>
        <p><strong>Article R. 434-101 ‚Äì Mission</strong><br>
        La Brigade Municipale exerce ses missions dans le respect strict des lois et r√®glements en vigueur.</p>
        <p><strong>Article R. 434-102 ‚Äì Principe hi√©rarchique</strong><br>
        L‚Äôautorit√© hi√©rarchique donne des ordres pr√©cis et en assume la responsabilit√©. Les ordres suivent la voie hi√©rarchique sauf urgence. Tout fait grave, m√™me hors service, doit √™tre signal√©.</p>
        <p><strong>Article R. 434-103 ‚Äì Ob√©issance</strong><br>
        L‚Äôex√©cution des ordres est obligatoire. Exception : ordre manifestement ill√©gal compromettant gravement l‚Äôint√©r√™t public. En cas de doute, l‚Äôagent signale l‚Äôill√©galit√© et peut demander confirmation √©crite. L‚Äôordre √©crit n‚Äôexon√®re pas de responsabilit√©.</p>
        <p><strong>Article R. 434-104 ‚Äì Responsabilit√©</strong><br>
        Chaque agent demeure personnellement responsable de ses actes. Tout manquement expose √† des sanctions disciplinaires et/ou p√©nales.</p>
        <p><strong>Article R. 434-105 ‚Äì Protection fonctionnelle</strong><br>
        L‚Äô√âtat prot√®ge juridiquement le policier contre menaces, violences ou poursuites li√©es au service, hors faute personnelle.</p>
        <p><strong>Article R. 434-106 ‚Äì Obligations du sup√©rieur</strong><br>
        Le sup√©rieur prot√®ge l‚Äôint√©grit√© physique et mentale de ses subordonn√©s et assure une formation adapt√©e et actualis√©e.</p>

        <h3>TITRE II ‚Äì DEVOIRS PROFESSIONNELS</h3>
        <p><strong>Article R. 434-107 ‚Äì Secret professionnel</strong><br>
        Toute information obtenue dans le cadre du service est strictement confidentielle.</p>
        <p><strong>Article R. 434-108 ‚Äì Probit√©</strong><br>
        Interdiction d‚Äôaccepter cadeaux ou avantages. Interdiction d‚Äôutiliser sa fonction √† des fins personnelles.</p>
        <p><strong>Article R. 434-109 ‚Äì Discernement</strong><br>
        L‚Äôagent agit avec sang-froid et proportionne sa r√©ponse aux risques et menaces.</p>
        <p><strong>Article R. 434-110 ‚Äì Impartialit√©</strong><br>
        Aucune discrimination n‚Äôest tol√©r√©e. Neutralit√© absolue dans l‚Äôexercice des missions.</p>
        <p><strong>Article R. 434-111 ‚Äì Devoir de r√©serve</strong><br>
        Neutralit√© religieuse, politique et philosophique en service. Hors service, libert√© d‚Äôexpression limit√©e par le devoir de r√©serve.</p>
        <p><strong>Article R. 434-112 ‚Äì Non cumul d‚Äôactivit√©</strong><br>
        Toute activit√© priv√©e lucrative doit respecter strictement le cadre l√©gal.</p>
        <p><strong>Article R. 434-113 ‚Äì Disponibilit√©</strong><br>
        Le policier est disponible selon les n√©cessit√©s du service.</p>

        <h3>TITRE III ‚Äì RELATION AVEC LA POPULATION</h3>
        <p><strong>Article R. 434-114 ‚Äì Comportement</strong><br>
        Courtoisie et vouvoiement obligatoires. Respect constant de la dignit√© humaine.</p>
        <p><strong>Article R. 434-115 ‚Äì Contr√¥les d‚Äôidentit√©</strong><br>
        Interdiction de contr√¥le fond√© sur des caract√©ristiques physiques. Respect de la dignit√©. Palpation uniquement si n√©cessaire pour la s√©curit√©.</p>
        <p><strong>Article R. 434-116 ‚Äì Personnes interpell√©es</strong><br>
        Protection contre toute violence ou traitement d√©gradant. Menottes uniquement si danger ou risque de fuite.</p>
        <p><strong>Article R. 434-117 ‚Äì Pr√©somption d‚Äôinnocence</strong><br>
        Toute personne est pr√©sum√©e innocente jusqu‚Äô√† d√©cision judiciaire d√©finitive.</p>
        <p><strong>Article R. 434-118 ‚Äì Assistance et aide aux victimes</strong><br>
        Obligation d‚Äôassistance, m√™me hors service. Attention particuli√®re aux victimes et respect de la confidentialit√©.</p>
        <p><strong>Article R. 434-119 ‚Äì Donn√©es personnelles</strong><br>
        Respect strict des r√®gles relatives aux fichiers et √† la vie priv√©e.</p>
        <p><strong>Article R. 434-120 ‚Äì Sources humaines</strong><br>
        Recours aux informateurs uniquement selon les r√®gles en vigueur.</p>

        <h3>TITRE IV ‚Äì USAGE DE LA FORCE</h3>
        <p><strong>Article R. 434-121 ‚Äì Principe de n√©cessit√©</strong><br>
        La force ne peut √™tre employ√©e que si elle est l√©gale, n√©cessaire et proportionn√©e.</p>
        <p><strong>Article R. 434-122 ‚Äì Arme l√©tale</strong><br>
        L‚Äôarme l√©tale constitue un dernier recours absolu, uniquement en cas de l√©gitime d√©fense ou de danger grave et imminent. Tout usage peut faire l‚Äôobjet d‚Äôun contr√¥le hi√©rarchique ou d‚Äôune enqu√™te.</p>
        <p><strong>Article R. 434-123 ‚Äì Arme hors service</strong><br>
        Autorisation √† partir du grade de Brigadier. Usage exclusivement en l√©gitime d√©fense. Brassard et port dissimul√© obligatoires.</p>
        <p><strong>Article R. 434-124 ‚Äì Tir sur v√©hicule</strong><br>
        Respect strict des ordres du commandement.</p>

        <h3>TITRE V ‚Äì TENUE, DISCIPLINE ET VIE INTERNE</h3>
        <p><strong>Article R. 434-125 ‚Äì Tenue r√©glementaire</strong><br>
        Uniforme obligatoire en service sauf exception r√©glementaire. Uniformit√© stricte. Interdits : polo noir en Police Secours, cache-cou, masque, casquette non r√©glementaire ou port√©e √† l‚Äôenvers. Calot autoris√©.</p>
        <p><strong>Article R. 434-126 ‚Äì Comportement exemplaire</strong><br>
        Comportement irr√©prochable en service comme hors service, y compris sur les r√©seaux sociaux.</p>
        <p><strong>Article R. 434-127 ‚Äì Respect interne</strong><br>
        Langage correct obligatoire. Tout manque de respect est sanctionnable.</p>
        <p><strong>Article R. 434-128 ‚Äì Vie priv√©e</strong><br>
        Interdiction de diffuser photos ou vid√©os sans autorisation.</p>
        <p><strong>Article R. 434-129 ‚Äì Professionnalisme</strong><br>
        Les diff√©rends personnels ne doivent jamais impacter le service.</p>

        <h3>TITRE VI ‚Äì R√àGLES OP√âRATIONNELLES</h3>
        <p><strong>Article R. 434-130 ‚Äì Coop√©ration interservices</strong><br>
        Coop√©ration respectueuse avec les services publics et priv√©s.</p>
        <p><strong>Article R. 434-131 ‚Äì V√©hicules et mat√©riel</strong><br>
        Interdiction d‚Äôutiliser les v√©hicules d‚Äôautres services. Usage strictement encadr√© des armes et mat√©riels.</p>
        <p><strong>Article R. 434-132 ‚Äì Fourri√®re</strong><br>
        Recours justifi√©. Contact privil√©gi√© avec les d√©panneurs.</p>
        <p><strong>Article R. 434-133 ‚Äì Lieux sensibles</strong><br>
        Intervention soumise √† autorisation d‚Äôun officier, pr√©fet ou procureur.</p>
        <p><strong>Article R. 434-134 ‚Äì Signalisation</strong><br>
        V√©hicule l√©ger : 3 c√¥nes en moyenne. Barri√®res et panneaux r√©serv√©s aux unit√©s routi√®res.</p>
        <p><strong>Article R. 434-135 ‚Äì Service minimum</strong><br>
        Toute pr√©sence en ville entre 12h00 et 00h00 impose un minimum d‚Äôune heure de service.</p>

        <h3>TITRE VII ‚Äì CONTR√îLE ET SANCTIONS</h3>
        <p><strong>Article R. 434-136 ‚Äì Contr√¥le</strong><br>
        Les agents sont soumis au contr√¥le hi√©rarchique, aux inspections comp√©tentes et aux autorit√©s l√©gales.</p>
        <p><strong>Article R. 434-137 ‚Äì Sanctions</strong><br>
        Tout manquement au pr√©sent code expose √† une sanction disciplinaire, sans pr√©judice d‚Äô√©ventuelles poursuites p√©nales.</p>

        <div style="
            margin-top: 30px;
            padding: 20px;
            border-radius: 12px;
            background: #2563eb;
            color: white;
            text-align: center;
            font-weight: 600;
            font-size: 18px;
        ">
            üîπ Corps de Commandement üîπ<br>
            Brigade Municipale ‚Äì Respect & Discipline
        </div>

    </div> <!-- fin scrollable -->

    <!-- Bouton Accueil centr√© en bas -->
    <div style="text-align:center; margin-top:10px;">
        <button id="btnBackFromReglement" style="
            margin-top: 10px;
            margin-bottom: 30px;
            padding:10px 15px;
            border-radius:8px;
            background:#2563eb;
            color:white;
            cursor:pointer;
            font-weight:600;
            transition: all 0.25s ease-in-out;"
            onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
            ‚¨ÖÔ∏è Accueil
        </button>
    </div>

</div>



<!-- MDT -->
<div id="mdt">
    <div class="sidebar" style="border-radius: 12px; max-height: 650px;">
        <h3>Agent</h3>
        <div id="agentInfo"></div>
        <button id="btnAttente" style="margin-bottom:10px; background:#16a34a; color:white; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
            onmouseover="this.style.background='#15803d'; this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#16a34a'; this.style.transform='scale(1)';">
            üü¢ Attente
        </button>
        <button id="btnQuitterAttente" style="margin-bottom:10px; background:#dc2626; color:white; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
            onmouseover="this.style.background='#b91c1c'; this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#dc2626'; this.style.transform='scale(1)';">
            üî¥ Quitter
        </button>
        <div class="csu">
            <h4>CSU</h4>
            <div style="display:flex; align-items:center; gap:20px;"></div>
            <div id="csuInfo">Aucun agent CSU</div>
            <button id="joinCSU" style="background:#2563eb; color:white; padding:8px; border-radius:6px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
                onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
                onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
                Rejoindre CSU
            </button>
            <button id="leaveCSU" style="display:none; background:#dc2626; color:white; padding:8px; border-radius:6px; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
                onmouseover="this.style.background='#b91c1c'; this.style.transform='scale(1.03)';"
                onmouseout="this.style.background='#dc2626'; this.style.transform='scale(1)';">
                Quitter CSU
            </button>
        </div>
        <button id="btnBackHomeFromMDT" style="margin-top:20px; padding:10px 15px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
            onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
            onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
            ‚¨ÖÔ∏è Accueil
        </button>
    </div>

    <div class="main">

    <div class="vacations" id="vacationsDiv"></div>

    <div class="waiting" style="display:flex; flex-direction:column; gap:20px;">

        <div class="card card-blue">
    <h3>Attente d'affectation</h3>
    <div id="waitingList"></div>
</div>

        <div class="card card-blue trainers">
    <h3>Formateurs disponibles</h3>
    <div id="trainersList"></div>
</div>

    </div>
    </div>
</div>





<!-- PAGE ADMIN -->
<div class="container" id="pageAdmin" style="display:none;">
    <h2>Validation des comptes</h2>
    <div id="adminList" style="display:flex; flex-direction:column; gap:10px;"></div>
    <button id="btnBackAdmin"style="margin-top:10px; padding:10px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Retour</button>
    
</div>

<!-- PAGE ADMIN - HEURES TOTALES -->
<div class="container" id="pageTotalHours">
    <h2>Heures totales des agents</h2>

    <div class="search-bar">
        <span>üîç</span>
        <input id="searchAgent" type="text" placeholder="Rechercher un agent...">
    </div>

    <button id="sortButton" type="button">üì∂ Trier par grade</button>

    <div id="totalHoursWrapper">
        <div id="totalHoursList"></div>
    </div>

    <button id="btnResetHours">üîÑ Reset heures</button>
    <button id="btnBackAdminHome">‚¨ÖÔ∏è Retour</button>
</div>


<!-- PAGE ADMIN - TOUS LES AGENTS -->
<div class="container" id="pageAllAgents" 
    style="
        display:none; 
        padding:30px; 
        margin:600px auto 20px auto;   /* r√©duit le margin-top pour ne pas √™tre trop bas */
        max-width:800px; 
        box-shadow:0 8px 20px rgba(0,0,0,0.3); 
        border-radius:12px; 
        background:#111827; 
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    ">
    <h2 style="text-align:center; margin-bottom:20px; color:#f3f4f6; margin-top: 150px;">Votre effectifs</h2>

    <div id="allAgentsList" style="display:flex; flex-direction:column; gap:10px;"></div>

    <button id="btnBackAllAgents"
        style="margin-top:10px; padding:10px; border-radius:8px; background:#2563eb; color:white; cursor:pointer; font-weight:600; transition: all 0.25s ease-in-out;"
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Retour
    </button>
</div>



<div class="container" id="pageAgentDetail" style="
    display:none; 
    flex-direction:column; 
    align-items:center; 
    width:90%;         /* agrandi par rapport √† 100% du parent */
    max-width:800px;  /* limite pour grands √©crans */
    min-width:600px;   /* garde un minimum pour le confort */
    height: 1000px;;       /* adapte la hauteur au contenu */
    padding:30px;      /* plus de padding pour respirer */
">
    <h2 style="margin-bottom:20px;">Dossier Agent</h2>
    <div id="agentDetailContent" style="
        width:100%; 
        display:flex; 
        flex-direction:column; 
        gap:10px;
    "></div>

    <button id="btnBackAgentDetail"
        style="
            margin-top:20px; 
            padding:12px 20px; 
            border-radius:8px; 
            background:#2563eb; 
            color:white; 
            cursor:pointer; 
            font-weight:600; 
            transition: all 0.25s ease-in-out;
        "
        onmouseover="this.style.background='#1e40af'; this.style.transform='scale(1.03)';"
        onmouseout="this.style.background='#2563eb'; this.style.transform='scale(1)';">
        ‚¨ÖÔ∏è Retour
    </button>
</div>


<div id="copyToast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, collection, onSnapshot, getDocs }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDX486w4yzHXDOgJ66Q0VjMRXMGtBFNdIY",
  authDomain: "mydispatch-3a386.firebaseapp.com",
  projectId: "mydispatch-3a386",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ELEMENTS
const pageInscription=document.getElementById("pageInscription");
const pageLogin=document.getElementById("pageLogin");
const pageMDT=document.getElementById("mdt");
const agentInfo=document.getElementById("agentInfo");
const waitingList=document.getElementById("waitingList");
const vacationsDiv=document.getElementById("vacationsDiv");
const csuInfo=document.getElementById("csuInfo");
const joinCSU=document.getElementById("joinCSU");
const leaveCSU=document.getElementById("leaveCSU");
const rPrenom=document.getElementById("rPrenom");
const rNom=document.getElementById("rNom");
const rGrade=document.getElementById("rGrade");
const rPass=document.getElementById("rPass");
const lPrenom=document.getElementById("lPrenom");
const lNom=document.getElementById("lNom");
const lPass=document.getElementById("lPass");
const btnRegister=document.getElementById("btnRegister");
const btnLogin=document.getElementById("btnLogin");
const linkToLogin=document.getElementById("linkToLogin");
const linkToRegister=document.getElementById("linkToRegister");
const btnAttente=document.getElementById("btnAttente");
const btnQuitterAttente=document.getElementById("btnQuitterAttente");
const homePage = document.getElementById("homePage");
const pageTotalHours = document.getElementById("pageTotalHours");
const totalHoursList = document.getElementById("totalHoursList");
const btnBackAdminHome = document.getElementById("btnBackAdminHome");
const pageBrigade = document.getElementById("pageBrigade");
const btnTenues = document.getElementById("btnTenues");
const btnProcedures = document.getElementById("btnProcedures");
const btnReglementBrigade = document.getElementById("btnReglementBrigade");
const btnBackHomeFromBrigade = document.getElementById("btnBackHomeFromBrigade");
const btnBackHomepageBrigade = document.getElementById("btnBackHomepageBrigade");


const btnAdmin = document.getElementById("btnAdmin");
const adminHome = document.getElementById("adminHome");
const pageAdmin = document.getElementById("pageAdmin");
const adminList = document.getElementById("adminList");
const btnBackAdmin = document.getElementById("btnBackAdmin");
const pageAllAgents = document.getElementById("pageAllAgents");
const allAgentsList = document.getElementById("allAgentsList");
const pageAgentDetail = document.getElementById("pageAgentDetail");
const agentDetailContent = document.getElementById("agentDetailContent");
const btnBackAgentDetail = document.getElementById("btnBackAgentDetail");
const btnManageAccounts = document.getElementById("btnManageAccounts");
const btnTotalHours = document.getElementById("btnTotalHours");
const btnAllAgents = document.getElementById("btnAllAgents");


const gradeOrder = [
    "Directeur Principal",
    "Directeur Adjoint",
    "Chef de Police",
    "Chef de Service Classe Exceptionnel",
    "Chef de Service Classe Sup√©rieur",
    "Chef de Service Classe Normal",
    "Chef de Service Classe Stagiaire",
    "Brigadier Chef Principal",
    "Brigadier Chef",
    "Brigadier",
    "Gardien Principal",
    "Gardien Titulaire",
    "Gardien Stagiaire"
];

function sortByGrade(a, b) {
    const indexA = gradeOrder.indexOf(a.grade);
    const indexB = gradeOrder.indexOf(b.grade);

    // Si le grade n'est pas dans la liste, le placer √† la fin
    const valA = indexA === -1 ? gradeOrder.length : indexA;
    const valB = indexB === -1 ? gradeOrder.length : indexB;

    return valA - valB;
}


// Ouvrir MDT depuis la page d'accueil
document.getElementById("btnMDT").onclick = async () => {
    await openMDT();
};

// Carte "Brigade Municipale" sur la page d'accueil
const btnBrigadeHome = document.getElementById("btnReglement"); // oui, ton bouton home s'appelle btnReglement
btnBrigadeHome.onclick = () => {
    showPage(pageBrigade); // affiche les 3 cartes : Tenues, Proc√©dures, R√®glement
};

// Carte "Tenues" √† l'int√©rieur de la page Brigade Municipale
btnTenues.onclick = () => {
    alert("En cours de d√©vloppement !")
    // ou showPage(pageTenues) si tu cr√©es une vraie page
};

// Carte "Proc√©dures" √† l'int√©rieur de la page Brigade Municipale
btnProcedures.onclick = () => {
    showPage(pageProcedures)
};

btnReglementBrigade.onclick = () => {
    pageBrigade.style.display = "none"; // cache les 3 cartes
    showPage(pageReglement); // affiche uniquement le r√®glement
};


// Bouton retour depuis la page Brigade Municipale
btnBackHomeFromBrigade.onclick = () => {
    showPage(homePage);
};

btnBackHomepageBrigade.onclick = () => {
    showPage(pageBrigade)
}



btnBackFromReglement.onclick = () => {
    showPage(pageBrigade);
};


function customConfirm(message) {
    return new Promise((resolve) => {
        const box = document.getElementById("confirmBox");
        const text = document.getElementById("confirmText");
        const yes = document.getElementById("confirmYes");
        const no = document.getElementById("confirmNo");

        text.innerText = message;
        box.classList.add("show");

        const clean = () => {
            box.classList.remove("show");
            yes.onclick = null;
            no.onclick = null;
        };

        yes.onclick = () => {
            clean();
            resolve(true);
        };

        no.onclick = () => {
            clean();
            resolve(false);
        };
    });
}



// Quand on clique sur la carte "Proc√©dures" depuis la home
btnProcedures.onclick = () => {
    showPage(pageProcedures); // Affiche la page proc√©dure
};




function resetProcedureForm() {
    // Masque toutes les √©tapes et remet stepChoice active
    document.querySelectorAll(".step").forEach(step => step.classList.remove("active"));
    document.getElementById("stepChoice").classList.add("active");

    // R√©initialise tous les inputs de step1
    document.getElementById("procNom").value = "";
    document.getElementById("procPrenom").value = "";
    document.getElementById("procDOB").value = "";
    document.getElementById("procTaille").value = "";
    document.getElementById("procSexe").value = "";
    document.getElementById("procTel").value = "";
    document.getElementById("procObservation").value = "";
    document.getElementById("procRapport").value = "";
    document.getElementById("procAPJ").value = "";

    // R√©initialise step2
    document.getElementById("fouilleObservation").value = "";

    // R√©initialise step3
    document.getElementById("lectureConfirm").checked = false;
    document.querySelectorAll(".droitCheckbox").forEach(cb => cb.checked = false);
    document.getElementById("presenceOui").checked = false;
    document.getElementById("presenceNon").checked = false;
    document.querySelectorAll('input[name="reconnaissance"]').forEach(cb => cb.checked = false);

    // R√©initialise les infractions
    document.querySelectorAll(".infractionCheckbox").forEach(cb => cb.checked = false);
}




// √âtape 1 ‚Üí choix des cartes
const btnBackcreaproc1 = document.getElementById("btnBackcreaproc1");
btnBackcreaproc1.addEventListener("click", () => {

    resetProcedureForm(); // üî• reset ici

    document.getElementById("step1").classList.remove("active");
    document.getElementById("stepChoice").classList.add("active");
});


// √âtape 2 ‚Üí √©tape 1
const btnBackcreaproc2 = document.getElementById("btnBackcreaproc2");
btnBackcreaproc2.addEventListener("click", () => {

    if (modeGeneration === "creation") {
        // Si on vient d'une cr√©ation normale
        document.getElementById("step2").classList.remove("active");
        document.getElementById("step1").classList.add("active");

    } else if (modeGeneration === "ajout") {
        // Si on vient d'un ajout direct
        resetProcedureForm(); // üî• reset complet
    }

});


// √âtape 3 ‚Üí √©tape 2
const btnBackcreaproc3 = document.getElementById("btnBackcreaproc3");
btnBackcreaproc3.addEventListener("click", () => {
    document.getElementById("step3").classList.remove("active"); // masque √©tape 3
    document.getElementById("step2").classList.add("active");    // affiche √©tape 2
});

// √âtape 4 ‚Üí √©tape 3
const btnBackcreaproc4 = document.getElementById("btnBackcreaproc4");
btnBackcreaproc4.addEventListener("click", () => {
    document.getElementById("step4").classList.remove("active"); // masque √©tape 4
    document.getElementById("step3").classList.add("active");    // affiche √©tape 3
});


const btnBackcreaprocaccueil = document.getElementById("btnBackcreaprocaccueil");
btnBackcreaprocaccueil.addEventListener("click", () => {
    resetProcedureForm(); // <-- ici
    showPage(pageBrigade);
});




let currentUser=null;
let isCSU=false;
let isTrainer = false;

// ADMINS AUTORIS√âS
const admins = ["Robin.Perrick", "Tommy.Angello", "Mick.Ross","de.de"]; // <-- deux √©l√©ments
// LISTE DES FORMATEURS AUTORIS√âS
const trainers = ["Tristan.De Morsef", "Rayan.Houda", "Yahya.Houda", "Robin.Perrick", "Tommy.Angello", "Mick.Ross"]; // mettre l'ID Firestore = prenom.nom
const recruiters = ["Yahya.Houda","Tristan.De Morsef" ]; // Mets les vrais ID ici



// NAVIGATION
function showPage(page) {
    // üîπ cache toutes les pages
    pageInscription.style.display = "none";
    pageLogin.style.display = "none";
    pageMDT.style.display = "none";
    pageAdmin.style.display = "none";
    homePage.style.display = "none";
    pagePointeuse.style.display = "none";
    adminHome.style.display = "none";
    pageTotalHours.style.display = "none";
    pageAllAgents.style.display = "none";
    pageAgentDetail.style.display = "none";
    pageReglement.style.display = "none";
    pageBrigade.style.display = "none";
    pageProcedures.style.display = "none";

    // üîπ affiche la page demand√©e
    page.style.display = "flex";

    // üîπ mets √† jour le bouton admin selon la page et l'utilisateur
    updateRoles(page);

    // üîπ gestion du header
    const header = document.getElementById("mainTitle");
    if (page === pageMDT || page === pageReglement) {
        header.style.display = "none"; // cache sur MDT et r√®glement
    } else {
        header.style.display = "block"; // visible sur les autres pages
        header.style.marginTop = page === pageBrigade ? "130px" : "40px";
    }
}






// üî• AJOUTE √áA
linkToLogin.onclick = () => showPage(pageLogin);
linkToRegister.onclick = () => showPage(pageInscription);



// INSCRIPTION
btnRegister.onclick = async () => {
    const prenom = rPrenom.value.trim();
    const nom = rNom.value.trim();
    const grade = rGrade.value.trim();
    const arrivalDate = rArrivalDate.value;
    const pass = rPass.value.trim();

    if (!prenom || !nom || !grade || !arrivalDate || !pass) {
        showToast("Veuillez remplir tous les champs !", 2500, "#ef4444");
        return;
    }

    const id = prenom + "." + nom;
    const docRef = doc(db, "agents", id);
    const snap = await getDoc(docRef);

    if (snap.exists()) {
        showToast("Ce compte existe d√©j√†", 2500, "#ef4444");
        return;
    }

    await setDoc(docRef, {
        prenom,
        nom,
        grade,
        pass,
        validated: false,
        inWaiting: false,
        inVacation: null,
        panicVolume: 1,
        pointeuse: [],
        arrivalDate: arrivalDate,
        sanctions: "",
        formations: "",
        formateur: false,
        recruteur: false
    });

    showToast("Compte cr√©√© ! En attente de validation.", 2500, "#10b981");

    rPrenom.value = "";
    rNom.value = "";
    rGrade.value = "";
    rPass.value = "";

    showPage(pageLogin);
};


// LOGIN
btnLogin.onclick = async () => {
    const prenom = lPrenom.value.trim();
    const nom = lNom.value.trim();
    const pass = lPass.value.trim();

    if (!prenom || !nom || !pass) {
        showToast("Veuillez remplir tous les champs !", 2500, "#ef4444");
        return;
    }

    const id = prenom + "." + nom;
    const docRef = doc(db, "agents", id);
    const snap = await getDoc(docRef);

    if (!snap.exists()) {
        showToast("Vous n'avez pas de compte", 2500, "#ef4444");
        return;
    }

    const data = snap.data();

    if (data.pass !== pass) {
        showToast("Une de vos informations est incorrecte", 2500, "#ef4444");
        return;
    }

    if (!data.validated) {
        showToast("Votre compte n'a pas encore √©t√© valid√© !", 2500, "#f59e0b");
        return;
    }

    // ‚úÖ D√©finir l'utilisateur courant
    currentUser = { ...data, id };

    updateRoles();

    agentInfo.innerHTML = `
      <span>${currentUser.prenom} ${currentUser.nom}</span> 
      <span style="display:block">${currentUser.grade}</span>
    `;

    showToast("Connexion r√©ussie !", 2000, "#10b981");

    showPage(homePage);
    await initDispatch();
    await initVacations();
    initCSU();
    loadWaiting();
    loadVacations();
    loadTrainers();
    await loadUserVolume();
    initPanicListener();
};






let isAdmin = false;
let isTrainerRole = false;
let isRecruiterRole = false;

function updateRoles(currentPage) {
    // üîπ SI ON EST SUR LA PAGE MDT, ON CACHE LE BOUTON
    if (currentPage === pageMDT) {
        btnAdmin.style.display = "none";
        return;
    }

    if (!currentUser) {
        isAdmin = false;
        isTrainerRole = false;
        isRecruiterRole = false;
        btnAdmin.style.display = "none";
        return;
    }

    isAdmin = admins.includes(currentUser.id);
    isTrainerRole = trainers.includes(currentUser.id);
    isRecruiterRole = recruiters.includes(currentUser.id);

    if (isAdmin) {
        btnAdmin.style.display = "block";
        btnAdmin.innerText = "‚öôÔ∏è Admin";
    } else if (isTrainerRole && isRecruiterRole) {
        btnAdmin.style.display = "block";
        btnAdmin.innerText = "üéì Formateur & üìù Recruteur";
    } else if (isTrainerRole) {
        btnAdmin.style.display = "block";
        btnAdmin.innerText = "üéì Formateur";
    } else if (isRecruiterRole) {
        btnAdmin.style.display = "block";
        btnAdmin.innerText = "üìù Recruteur";
    } else {
        btnAdmin.style.display = "none";
    }
}





// Charger comptes non valid√©s
async function loadAdminAccounts() {
    adminList.innerHTML = "";
    const snap = await getDocs(collection(db, "agents"));
    let count = 0;

    snap.forEach(docu => {
        const data = docu.data();

        if (!data.validated) {
            // üîπ Div principal de l'agent
            const div = document.createElement("div");
            div.className = "agent";
            Object.assign(div.style, {
                display: "flex",
                justifyContent: "space-between",
                alignItems: "center",
                background: "#1f2937",
                padding: "10px",
                borderRadius: "10px",
                marginBottom: "8px",
                flexWrap: "wrap",     // permet de passer sur une ligne si le texte est trop long
            });

            // üîπ Texte de l'agent
            const span = document.createElement("span");
            span.innerText = `${data.prenom} ${data.nom} - ${data.grade}`;
            Object.assign(span.style, {
                color: "#f3f4f6",
                fontWeight: "500",
                marginRight: "10px",
                flex: "1 1 auto",    // prend l'espace disponible
            });
            div.appendChild(span);

            // üîπ Wrapper des boutons
            const actions = document.createElement("div");
            Object.assign(actions.style, {
                display: "flex",
                gap: "8px",
                flexShrink: "0",      // ne se r√©tr√©cit pas
            });

            // ‚úÖ Bouton Valider
            const btnValider = document.createElement("button");
            btnValider.textContent = "‚úÖ Valider";
            Object.assign(btnValider.style, {
                background: "#16a34a",
                color: "white",
                border: "none",
                padding: "6px 12px",
                borderRadius: "6px",
                cursor: "pointer",
                fontWeight: "600",
                transition: "all 0.2s ease-in-out",
            });
            btnValider.onmouseover = () => btnValider.style.transform = "scale(1.05)";
            btnValider.onmouseout = () => btnValider.style.transform = "scale(1)";
            btnValider.onclick = async () => {
                const ok = await customConfirm(`Voulez-vous vraiment valider le compte de ${data.prenom} ${data.nom} ?`);
                if (!ok) return;
                try {
                    await updateDoc(doc(db, "agents", docu.id), { validated: true });
                    loadAdminAccounts();
                    customAlert(`Compte de ${data.prenom} ${data.nom} valid√© !`);
                } catch (err) {
                    console.error(err);
                    customAlert("Erreur lors de la validation du compte.");
                }
            };

            // ‚ùå Bouton Refuser
            const btnRefuser = document.createElement("button");
            btnRefuser.textContent = "‚ùå Refuser";
            Object.assign(btnRefuser.style, {
                background: "#dc2626",
                color: "white",
                border: "none",
                padding: "6px 12px",
                borderRadius: "6px",
                cursor: "pointer",
                fontWeight: "600",
                transition: "all 0.2s ease-in-out",
            });
            btnRefuser.onmouseover = () => btnRefuser.style.transform = "scale(1.05)";
            btnRefuser.onmouseout = () => btnRefuser.style.transform = "scale(1)";
            btnRefuser.onclick = async () => {
                const ok = await customConfirm(`Voulez-vous vraiment refuser le compte de ${data.prenom} ${data.nom} ?`);
                if (!ok) return;
                try {
                    await deleteDoc(doc(db, "agents", docu.id));
                    loadAdminAccounts();
                    customAlert(`Compte de ${data.prenom} ${data.nom} supprim√© !`);
                } catch (err) {
                    console.error(err);
                    customAlert("Erreur lors de la suppression du compte.");
                }
            };

            actions.appendChild(btnValider);
            actions.appendChild(btnRefuser);
            div.appendChild(actions);

            adminList.appendChild(div);
            count++;
        }
    });

    if (count === 0) {
        const span = document.createElement("span");
        span.innerText = "Aucun compte est en attente";
        Object.assign(span.style, {
            color: "#9ca3af",
            fontSize: "18px",
            fontWeight: "500",
            textAlign: "center",
            display: "block",
            marginTop: "20px",
        });
        adminList.appendChild(span);
    }
}


let userVolume = 1;
let panicListenerAttached = false;

async function loadUserVolume() {
    if (!currentUser) return;

    const snap = await getDoc(doc(db, "agents", currentUser.id));
    if (snap.exists() && snap.data().panicVolume !== undefined) {
        userVolume = snap.data().panicVolume;
    }
}




function initPanicListener() {
    if (panicListenerAttached) return;
    panicListenerAttached = true;

    let firstSnapshot = true;

    onSnapshot(doc(db, "panic", "current"), snap => {
        if (!snap.exists() || !currentUser) return;

        const data = snap.data();

        if (firstSnapshot) {
            firstSnapshot = false;
            return;
        }

        // üîπ NE JOUER QUE SI L'AGENT EST EN VACATION
        if (!currentUser.inVacation) return; // pas en vacation ‚Üí rien

        // üîπ Jouer le son 3 fois √† la suite
        let playCount = 0;
        const maxPlays = 3;

        function playNext() {
            if (playCount >= maxPlays) return;
            playCount++;
            const audio = new Audio("panic-button-sfx.mp3");
            audio.volume = userVolume;
            audio.play().catch(err => console.log("Erreur audio :", err));
            audio.addEventListener("ended", playNext, { once: true });
        }

        playNext();

        // üéá Animation panic button
        const animationDiv = document.createElement("div");
        animationDiv.id = "panicAnimation";
        animationDiv.style.position = "fixed";
        animationDiv.style.top = 0;
        animationDiv.style.left = 0;
        animationDiv.style.width = "100%";
        animationDiv.style.height = "100%";
        animationDiv.style.background = "rgba(255,0,0,0.8)";
        animationDiv.style.display = "flex";
        animationDiv.style.flexDirection = "column";
        animationDiv.style.justifyContent = "center";
        animationDiv.style.alignItems = "center";
        animationDiv.style.zIndex = 9999;
        animationDiv.style.color = "white";
        animationDiv.style.fontSize = "3em";
        animationDiv.style.fontWeight = "bold";
        animationDiv.style.textAlign = "center";
        animationDiv.style.animation = "pulseRed 1s infinite alternate";

        const vacationName = data.vacation ? data.vacation.replace(/_/g, " ") : "Aucune";

        animationDiv.innerHTML = `
        üö® PANIC BUTTON üö®<br>
        D√©clench√© par <br>${data.prenom} ${data.nom} | ${data.grade}<br>
        Vacation : <strong>${vacationName}</strong>
        `;

        document.body.appendChild(animationDiv);
        setTimeout(() => animationDiv.remove(), 7000);

        // üîπ CSS animation
        const style = document.createElement("style");
        style.innerHTML = `
        @keyframes pulseRed {
            0% { background-color: rgba(255,0,0,0.6); transform: scale(1); }
            50% { background-color: rgba(255,0,0,1); transform: scale(1.05); }
            100% { background-color: rgba(255,0,0,0.6); transform: scale(1); }
        }
        `;
        document.head.appendChild(style);
    });
}





// INIT DISPATCH & VACATIONS
async function initDispatch(){
    const ref=doc(db,"dispatch","waiting");
    const snap=await getDoc(ref);
    if(!snap.exists()) await setDoc(ref,{agents:[]});
}
async function initVacations(){
    const vacCol=collection(db,"vacations");
    const snap=await getDocs(vacCol);
    if(snap.empty){
        const defaultVacations=[
            {nom:"Victor 01",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"Victor 02",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"Victor 03",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"GSI Alpha",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"GSI Bravo",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"BMU Alpha",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"BMU Bravo",statut:"Disponible",agents:[],vehicules:["Aucun"]},
        ];
        for(let v of defaultVacations){
            const id=v.nom.replace(/\s+/g,"_");
            await setDoc(doc(db,"vacations",id),v);
        }
    }
}

// ATTENTE
btnAttente.onclick = async () => {

    if (!currentUser) {
        showToast("Utilisateur non connect√©.", 2500, "#ef4444");
        return;
    }

    if (currentUser.inVacation) {
        showToast("Vous √™tes d√©j√† dans une vacation !", 2500, "#f59e0b");
        return;
    }

    if (currentUser.inWaiting) {
        showToast("Vous √™tes d√©j√† en attente.", 2500, "#f59e0b");
        return;
    }

    const ref = doc(db, "dispatch", "waiting");

    await updateDoc(ref, {
        agents: arrayUnion(currentUser)
    });

    await updateDoc(doc(db, "agents", currentUser.id), {
        inWaiting: true
    });

    currentUser.inWaiting = true;

    showToast("Vous √™tes maintenant en attente.", 2000, "#10b981");
};
btnQuitterAttente.onclick = async () => {
    if(!currentUser) return;
    const ref = doc(db,"dispatch","waiting");
    const snap = await getDoc(ref);
    const agents = snap.data()?.agents || [];
    const newAgents = agents.filter(a => a.id !== currentUser.id);
    await updateDoc(ref, { agents: newAgents });
    await updateDoc(doc(db,"agents",currentUser.id), { inWaiting: false });
    currentUser.inWaiting = false;
};


// CSU
function initCSU(){
    const csuRef=doc(db,"csu","current");
    onSnapshot(csuRef,snap=>{
        const data = snap.data()||{};
        if(data.agent){
            csuInfo.innerText=`${data.agent.prenom} ${data.agent.nom} | ${data.agent.grade}`;
            isCSU=(currentUser.id===data.agent.id);
            joinCSU.style.display=isCSU? "none" : "none";
            leaveCSU.style.display=isCSU? "block" : "none";
        } else {
            csuInfo.innerText="Aucun agent CSU";
            isCSU=false;
            joinCSU.style.display="block";
            leaveCSU.style.display="none";
        }
        loadVacations();
        loadWaiting();
    });
}
joinCSU.onclick = async () => {

    if (!currentUser) {
        showToast("Utilisateur non connect√©.", 2500, "#ef4444");
        return;
    }

    const csuRef = doc(db, "csu", "current");
    const snap = await getDoc(csuRef);

    if (snap.data()?.agent) {
        showToast("Un agent est d√©j√† CSU !", 2500, "#f59e0b");
        return;
    }

    await setDoc(csuRef, { agent: currentUser });

    showToast("Vous √™tes maintenant CSU.", 2000, "#10b981");
};
leaveCSU.onclick = async () => {

    if (!currentUser) {
        showToast("Utilisateur non connect√©.", 2500, "#ef4444");
        return;
    }

    const csuRef = doc(db, "csu", "current");

    await setDoc(csuRef, { agent: null });

    showToast("Vous avez quitt√© le CSU.", 2000, "#ef4444");
};

// LOAD
function loadWaiting() {
    const waitingRef = doc(db, "dispatch", "waiting");

    // --------------------------
    // DROP dans waiting (depuis une vacation)
    // --------------------------
    waitingList.addEventListener("dragover", e => e.preventDefault());
    waitingList.addEventListener("drop", async e => {
        e.preventDefault();

        let data;
        try {
            data = JSON.parse(e.dataTransfer.getData("text/plain"));
        } catch {
            return;
        }

        const agentObj = data.agent;

        if (data.from === "waiting") return; // d√©j√† en waiting

        // 1Ô∏è‚É£ Ajouter l'ID de l'agent √† waiting
        const snapWaiting = await getDoc(waitingRef);
        const agentsWaiting = snapWaiting.data()?.agents || [];
        await updateDoc(waitingRef, { agents: [...agentsWaiting, agentObj] });

        // 2Ô∏è‚É£ Mettre √† jour l'agent
        await updateDoc(doc(db, "agents", agentObj.id), { inVacation: null, inWaiting: true });

        // 3Ô∏è‚É£ Retirer de la vacation si besoin
        if (data.from) {
            const fromRef = doc(db, "vacations", data.from);
            const snapFrom = await getDoc(fromRef);
            if (snapFrom.exists()) {
                const agentsFrom = snapFrom.data()?.agents || [];
                const newAgentsFrom = agentsFrom.filter(a => a.id !== agentObj.id);
                await updateDoc(fromRef, { agents: newAgentsFrom });
            }
        }
    });

    // --------------------------
    // √âcoute des changements sur la waiting list
    // --------------------------
    onSnapshot(waitingRef, snap => {
        waitingList.innerHTML = "";
        const agentsInWaiting = snap.data()?.agents || [];

        agentsInWaiting.forEach(a => {
            const div = document.createElement("div");
            div.className = "agent";
            div.innerText = `${a.prenom} ${a.nom} - ${a.grade}`;

            // On affiche les boutons seulement si isCSU
            if (isCSU) {
                // Bouton retirer
                const btn = document.createElement("button");
                btn.textContent = "‚ùå Retirer";
                btn.className = "csu-button";
                btn.onclick = async () => {
                    // Retirer l'agent par ID
                    const snap = await getDoc(waitingRef);
                    const agents = snap.data()?.agents || [];
                    const newAgents = agents.filter(agent => agent.id !== a.id);
                    await updateDoc(waitingRef, { agents: newAgents });

                    await updateDoc(doc(db, "agents", a.id), { inWaiting: false });
                };
                div.appendChild(btn);

                // Drag depuis waiting
                div.draggable = true;
                div.addEventListener("dragstart", e => {
                    e.dataTransfer.setData(
                        "text/plain",
                        JSON.stringify({ agent: a, from: "waiting" })
                    );
                    div.classList.add("dragging");
                });
                div.addEventListener("dragend", () => div.classList.remove("dragging"));
            }

            waitingList.appendChild(div);
        });
    });
}

function loadTrainers(){

    const trainersDiv = document.getElementById("trainersList");

    onSnapshot(collection(db,"agents"),snap=>{

        let trainersArray = [];

        snap.forEach(docu=>{

            const data = docu.data();

            if(
    trainers.includes(docu.id) &&
    data.validated &&
    (
        data.inVacation ||
        data.inWaiting ||
        data.isCSU === true
    )
){
                let statut = "üü¢ Disponible";

                if(data.inVacation) statut = "üî¥ En vacation";
                else if(data.inWaiting) statut = "üü† En attente";

                trainersArray.push({
                    id: docu.id,
                    prenom: data.prenom,
                    nom: data.nom,
                    grade: data.grade,
                    statut: statut
                });
            }
        });

        // üî• TRI PAR GRADE (ton syst√®me existant)
        trainersArray.sort(sortByGrade);

        trainersDiv.innerHTML = "";

        trainersArray.forEach(a => {
    const div = document.createElement("div");
    div.className = "agent";
    div.innerHTML = `${a.prenom} ${a.nom} | ${a.grade}<br> ${a.statut}`;
    trainersDiv.appendChild(div);
});
    });
}


function colorStatut(select){
    if(select.value === "Disponible"){
        select.style.backgroundColor = "#2ecc71"; // vert
        select.style.color = "white";
    }
    else if(select.value === "En intervention"){
        select.style.backgroundColor = "#f39c12"; // orange
        select.style.color = "white";
    }
    else if(select.value === "Indisponible"){
        select.style.backgroundColor = "#e74c3c"; // rouge
        select.style.color = "white";
    }
    
}


const allVolumeSliders = []; // tableau global pour tous les sliders


function loadVacations(){
    const vacCol=collection(db,"vacations");
    onSnapshot(vacCol,snap=>{
        vacationsDiv.innerHTML="";
        // Ordre voulu : Victor -> GSI -> BMU
        const docs = snap.docs.sort((a, b) => {
    const order = [
        "Victor 01", "Victor 02", "Victor 03",
        "GSI Alpha", "GSI Bravo",
        "BMU Alpha", "BMU Bravo"
    ];

    const aData = a.data();
    const bData = b.data();

    const aHasAgents = (aData.agents || []).length > 0 ? 0 : 1;
    const bHasAgents = (bData.agents || []).length > 0 ? 0 : 1;

    // 1Ô∏è‚É£ Priorit√© aux vacations avec agents
    if(aHasAgents !== bHasAgents) return aHasAgents - bHasAgents;

    // 2Ô∏è‚É£ Priorit√© selon l'ordre fixe
    const aIndex = order.indexOf(aData.nom);
    const bIndex = order.indexOf(bData.nom);

    if(aIndex === -1 && bIndex === -1) return 0;
    if(aIndex === -1) return 1;
    if(bIndex === -1) return -1;

    return aIndex - bIndex;
});


        docs.forEach(docu=>{
            const v = docu.data();
            const div = document.createElement("div");
            div.className="card";
            const title = document.createElement("h3");
            title.textContent=v.nom;
            div.appendChild(title);
            // STATUT
            const selectStat = document.createElement("select");
            ["Disponible","En intervention","Indisponible"].forEach(s=>{
                const opt=document.createElement("option");
                opt.value=s; opt.textContent=s;
                if(v.statut===s) opt.selected=true;
                selectStat.appendChild(opt);
            });
            selectStat.disabled=!(isCSU || (v.agents||[]).some(a=>a.id===currentUser.id));
            colorStatut(selectStat);
            selectStat.onchange=async()=>{
            colorStatut(selectStat);
            await updateDoc(doc(db,"vacations",docu.id),{statut:selectStat.value});
            };

            div.appendChild(selectStat);

            // VEHICULE
let vehicles = ["Aucun","Enyoq","Cinq C SW","M√©gane","Kangoo","Tucson","Zo√©"]; // liste compl√®te par d√©faut

// ‚ö° appliquer r√®gles selon type de vacation
if(v.nom.startsWith("Victor")) {
    vehicles = vehicles.filter(vh => vh !== "Cinq C SW"); // tout sauf Cinq C SW
} else if(v.nom.startsWith("GSI")) {
    vehicles = ["Aucun","M√©gane","Cinq C SW"]; // seulement ces deux
}

const selVeh = document.createElement("select");
vehicles.forEach(vh => {
    const opt = document.createElement("option");
    opt.value = vh;
    opt.textContent = vh;
    if((v.vehicules||["Aucun"]).includes(vh)) opt.selected = true;
    selVeh.appendChild(opt);
});

selVeh.disabled = !(isCSU || (v.agents||[]).some(a => a.id === currentUser.id));

selVeh.onchange = async () => {
    await updateDoc(doc(db,"vacations",docu.id), {vehicules:[selVeh.value]});
};

div.appendChild(selVeh);


            // BOUTONS PANIC / REJOINDRE / QUITTER

// üî• Bouton Panic + Volume
const panicBtn = document.createElement("button");
panicBtn.textContent = "Panic üö®";
panicBtn.style.marginRight = "10px";
panicBtn.style.background = "#e74c3c";
panicBtn.style.color = "white";
panicBtn.style.padding = "10px 12px";
panicBtn.style.borderRadius = "6px";
panicBtn.style.cursor = "pointer";
panicBtn.style.fontWeight = "600";

// üéö Slider volume
const volumeSlider = document.createElement("input");
volumeSlider.type = "range";
volumeSlider.min = 0;
volumeSlider.max = 1;
volumeSlider.step = 0.05;
volumeSlider.value = userVolume;
volumeSlider.style.width = "100px";
volumeSlider.style.marginLeft = "5px";

// ‚úÖ Ajoute ce slider au tableau global
allVolumeSliders.push(volumeSlider);

// Sauvegarde volume et synchronisation
volumeSlider.oninput = async () => {
    userVolume = parseFloat(volumeSlider.value);

    // üîÑ Met √† jour tous les sliders avec la nouvelle valeur
    allVolumeSliders.forEach(slider => {
        if(slider !== volumeSlider) slider.value = userVolume;
    });

    if (!currentUser) return;

    await setDoc(
        doc(db, "agents", currentUser.id),
        { panicVolume: userVolume },
        { merge: true }
    );
};


// Clique Panic
panicBtn.onclick = async () => {

    if (!currentUser) {
        alert("Vous devez √™tre connect√© !");
        return;
    }

    await setDoc(doc(db, "panic", "current"), {
        user: currentUser.id,
        prenom: currentUser.prenom,
        nom: currentUser.nom,
        grade: currentUser.grade,
        vacation: currentUser.inVacation || "Aucune",
        timestamp: Date.now()
    });
};


// Container
const panicContainer = document.createElement("div");
panicContainer.style.display = "flex";
panicContainer.style.alignItems = "center";
panicContainer.style.gap = "8px";
panicContainer.style.marginTop = "8px";

panicBtn.disabled = !(isCSU || (v.agents || []).some(a => a.id === currentUser.id));
volumeSlider.disabled = !(isCSU || (v.agents || []).some(a => a.id === currentUser.id));

const canEditPanic = isCSU || (v.agents || []).some(a => a.id === currentUser.id);

panicBtn.disabled = !canEditPanic;
volumeSlider.disabled = !canEditPanic;

// üîπ Styles visuels quand d√©sactiv√©
if(!canEditPanic){
    panicBtn.style.opacity = "0.7";
    panicBtn.style.cursor = "not-allowed";
    volumeSlider.style.opacity = "0.7";
    volumeSlider.style.cursor = "not-allowed";
} else {
    panicBtn.style.opacity = "1";
    panicBtn.style.cursor = "pointer";
    volumeSlider.style.opacity = "1";
    volumeSlider.style.cursor = "pointer";
}



panicContainer.appendChild(panicBtn);
panicContainer.appendChild(volumeSlider);
const joinBtn = document.createElement("button");
joinBtn.textContent = "Rejoindre";
joinBtn.onclick = () => rejoindreVacation(docu.id);

const leaveBtn = document.createElement("button");
leaveBtn.textContent = "Quitter";
leaveBtn.onclick = () => quitterVacation(docu.id);

div.appendChild(joinBtn);
div.appendChild(leaveBtn);
div.appendChild(panicContainer);





            // AGENTS
            const agentDiv=document.createElement("div");
            agentDiv.className="agents-container";
            // Trie les agents de la vacation par grade
            const sortedAgents = (v.agents || []).sort(sortByGrade);
            sortedAgents.forEach(a => {
                const ag = document.createElement("div");
                ag.className = "agent";
                ag.innerText = `${a.prenom} ${a.nom} - ${a.grade}`;
                ag.draggable = isCSU;
    
                if (isCSU) {
                    const btn = document.createElement("button");
                    btn.textContent = "‚ùå Retirer";
                    btn.className = "csu-button";
                    btn.onclick = async () => {
                        await updateDoc(doc(db,"vacations",docu.id), { agents: arrayRemove(a) });
                        await updateDoc(doc(db,"agents",a.id), { inVacation: null });
                    };
                    ag.appendChild(btn);

                    // Drag & drop
                    ag.addEventListener("dragstart", e => {
                        e.dataTransfer.setData("text/plain", JSON.stringify({ agent: a, from: docu.id }));
                        ag.classList.add("dragging");
                    });
                    ag.addEventListener("dragend", () => ag.classList.remove("dragging"));
                }

                agentDiv.appendChild(ag);
        });

            div.addEventListener("dragover", e => e.preventDefault()); // obligatoire pour drop
div.addEventListener("drop", async e => {
    e.preventDefault(); 
    if(!isCSU) return;

    const data = JSON.parse(e.dataTransfer.getData("text/plain"));
    const agentObj = data.agent;
    const toRef = doc(db, "vacations", docu.id);

    if(data.from === docu.id) return; // m√™me vacation, rien √† faire

    if(data.from === "waiting") {
    const waitingRef = doc(db, "dispatch", "waiting");
    await updateDoc(toRef, { agents: arrayUnion(agentObj.id) });
    await updateDoc(waitingRef, { agents: arrayRemove(agentObj.id) });
    await updateDoc(doc(db, "agents", agentObj.id), { inWaiting: false, inVacation: docu.id });
} else {
    const fromRef = doc(db, "vacations", data.from);
    await updateDoc(toRef, { agents: arrayUnion(agentObj) });
    await updateDoc(fromRef, { agents: arrayRemove(agentObj) });
    await updateDoc(doc(db, "agents", agentObj.id), { inVacation: docu.id });
}

});


            div.appendChild(agentDiv);
            vacationsDiv.appendChild(div);
        });
    });
}

// REJOINDRE / QUITTER VACATION
async function rejoindreVacation(id) {

    if (!currentUser) {
        showToast("Utilisateur non connect√©.", 2500, "#ef4444");
        return;
    }

    // Si l'agent est d√©j√† dans une vacation
    if (currentUser.inVacation) {
        showToast("Vous √™tes d√©j√† dans une vacation !", 2500, "#f59e0b");
        return;
    }

    // Si l'agent est en attente, le retirer de la liste d'attente
    if (currentUser.inWaiting) {

        const ref = doc(db, "dispatch", "waiting");

        const snap = await getDoc(ref);
        const waitingAgents = snap.data()?.agents || [];

        const newWaitingAgents = waitingAgents.filter(a => a.id !== currentUser.id);

        await updateDoc(ref, { agents: newWaitingAgents });

        await updateDoc(doc(db, "agents", currentUser.id), { inWaiting: false });

        currentUser.inWaiting = false;

        showToast("Vous √™tes dans une vaccation !", 2000, "#3b82f6");
    }


    // Rejoindre la vacation
    await updateDoc(doc(db,"vacations",id), { agents: arrayUnion(currentUser) });
    await updateDoc(doc(db,"agents",currentUser.id), { inVacation: id });
    currentUser.inVacation = id;
} 

async function quitterVacation(id){
    if(!currentUser) return;

    const vacRef = doc(db,"vacations",id);
    const snapVac = await getDoc(vacRef);
    const agents = snapVac.data()?.agents || [];

    // Retirer l'agent par ID
    const newAgents = agents.filter(a => a.id !== currentUser.id);
    await updateDoc(vacRef, { agents: newAgents });

    await updateDoc(doc(db,"agents",currentUser.id), { inVacation: null });
    currentUser.inVacation = null;

    // Reset v√©hicule si la vacation est vide
    if(newAgents.length === 0){
        const vehicules = snapVac.data().vehicules || [];
        for(let v of vehicules){
            if(v !== "Aucun"){ 
                await updateDoc(vacRef, { vehicules: ["Aucun"], statut: "Indisponible" });
            }
        }
    }
}




async function openMDT(){
    if(!currentUser) return alert("Vous devez √™tre connect√© !");

    showPage(pageMDT);        // Affiche le MDT
    checkAdmin();             // Montre le bouton admin si c'est un admin
    await initDispatch();     // Initialise dispatch si n√©cessaire
    await initVacations();    // Initialise vacations si n√©cessaire
    initCSU();                // Initialise le CSU
    loadWaiting();            // Recharge la liste d'attente
    loadVacations();          // Recharge les vacations
}

// ===== POINTEUSE =====
const pagePointeuse = document.getElementById("pagePointeuse");
const pointeuseInfo = document.getElementById("pointeuseInfo");
const pointeuseHistory = document.getElementById("pointeuseHistory");
const btnStartShift = document.getElementById("btnStartShift");
const btnEndShift = document.getElementById("btnEndShift");

// Ouvrir la pointeuse depuis l'accueil
document.getElementById("btnPointeuse").onclick = () => {
    showPage(pagePointeuse);
    loadPointeuse();
};

// Charger historique et total heures
function formatDateFR(dateStr) {
    if (!dateStr) return "-";
    const date = new Date(dateStr);
    return date.toLocaleString("fr-FR", { 
        year: "numeric", month: "2-digit", day: "2-digit", 
        hour: "2-digit", minute: "2-digit" 
    });
}

// --- Charger historique et total heures ---
async function loadPointeuse() {
    if (!currentUser) return;

    try {
        const docRef = doc(db, "agents", currentUser.id);
        const snap = await getDoc(docRef);
        if (!snap.exists()) return;

        const data = snap.data();
        const history = data.pointeuse || [];

        // --- Calcul du total ---
        let totalMs = history.reduce((acc, entry) => {
            if (entry.arrivee && entry.depart) {
                return acc + (new Date(entry.depart) - new Date(entry.arrivee));
            }
            return acc;
        }, 0);

        const heures = Math.floor(totalMs / 1000 / 60 / 60);
        const minutes = Math.floor((totalMs / 1000 / 60) % 60);
        pointeuseInfo.innerText = `Total travaill√© : ${heures}h ${minutes}m`;

        // --- Historique ---
        pointeuseHistory.innerHTML = "";
        history.forEach(entry => {
            const div = document.createElement("div");
            div.classList.add("pointeuse-entry"); // pour style CSS si besoin
            div.innerText = `Arriv√©e : ${formatDateFR(entry.arrivee)} | D√©part : ${formatDateFR(entry.depart)}`;
            pointeuseHistory.appendChild(div);
        });

        // --- Boutons ---
        const enService = history.length && !history[history.length-1].depart;
        btnStartShift.disabled = enService;
        btnEndShift.disabled = !enService;

    } catch (error) {
        console.error("Erreur lors du chargement de la pointeuse:", error);
        alert("Impossible de charger vos heures pour le moment.");
    }
}

// --- D√©but de service ---

btnStartShift.onclick = async () => {

    if (!currentUser) {
        showToast("Utilisateur non connect√©.", 2500, "#ef4444");
        return;
    }

    try {
        const now = new Date().toISOString();
        const docRef = doc(db, "agents", currentUser.id);

        await updateDoc(docRef, {
            pointeuse: arrayUnion({ arrivee: now, depart: null })
        });

        showToast("Prise de service effectu√©e.", 2000, "#10b981");

        loadPointeuse();

    } catch (error) {
        console.error("Erreur au d√©but du service:", error);
        showToast("Impossible de d√©marrer votre service !", 2500, "#ef4444");
    }
};

// --- Fin de service ---
// --- Fin de service ---
btnEndShift.onclick = async () => {

    if (!currentUser) {
        showToast("Utilisateur non connect√©.", 2500, "#ef4444");
        return;
    }

    try {
        const docRef = doc(db, "agents", currentUser.id);
        const snap = await getDoc(docRef);
        const history = snap.data().pointeuse || [];

        if (!history.length) {
            showToast("Aucun d√©but de service trouv√© !", 2500, "#f59e0b");
            return;
        }

        const last = history[history.length - 1];

        if (last.depart) {
            showToast("Vous n'√™tes pas en service !", 2500, "#f59e0b");
            return;
        }

        history[history.length - 1] = {
            ...last,
            depart: new Date().toISOString()
        };

        await updateDoc(docRef, { pointeuse: history });

        showToast("Fin de service enregistr√©e.", 2000, "#3b82f6");

        loadPointeuse();

    } catch (error) {
        console.error("Erreur √† la fin du service:", error);
        showToast("Impossible de terminer votre service !", 2500, "#ef4444");
    }
};

btnAdmin.onclick = () => {
    showPage(adminHome);

    // üîπ Gestion affichage
    btnManageAccounts.style.display =
        isRecruiterRole || admins.includes(currentUser.id) ? "block" : "none";

    btnTotalHours.style.display =
        admins.includes(currentUser.id) ? "block" : "none";

    btnAllAgents.style.display =
        isTrainerRole || admins.includes(currentUser.id) ? "block" : "none";

    // üîπ CHANGER LES NOMS DES CARTES

    if (isRecruiterRole && !admins.includes(currentUser.id)) {
        btnManageAccounts.querySelector("h3").textContent = "Comptes";
        btnManageAccounts.querySelector("p").textContent = "G√©rer les comptes en attente";
    }

    if (isTrainerRole && !admins.includes(currentUser.id)) {
        btnAllAgents.querySelector("h3").textContent = "Tout les agents";
        btnAllAgents.querySelector("p").textContent = "Voir et modifier les formations";
    }

    if (admins.includes(currentUser.id)) {
        btnManageAccounts.querySelector("h3").textContent = "Comptes";
        btnManageAccounts.querySelector("p").textContent = "G√©rer les comptes en attente";

        btnAllAgents.querySelector("h3").textContent = "Tous les agents";
        btnAllAgents.querySelector("p").textContent = "Voir et modifier sanctions / formations";
    }
};


document.getElementById("btnBackToHome").onclick = () => {
    showPage(homePage);
    checkAdmin();
};

document.getElementById("btnManageAccounts").onclick = () => {
    showPage(pageAdmin);
    loadAdminAccounts();
};

btnBackAdmin.onclick = () => {
    showPage(adminHome);
};

document.getElementById("btnTotalHours").onclick = () => {
    showPage(pageTotalHours);
    loadTotalHours();
};

btnBackAdminHome.onclick = () => {
    showPage(adminHome);
};

document.getElementById("btnAllAgents").onclick = () => {
    showPage(pageAllAgents);
    loadAllAgents();
};

document.getElementById("btnBackAllAgents").onclick = () => {
    showPage(adminHome);
};

btnBackAgentDetail.onclick = () => {
    showPage(pageAllAgents);
};


let currentSort = "grade"; // par d√©faut : tri par grade

const sortButton = document.getElementById("sortButton");
const searchAgentInput = document.getElementById("searchAgent");
// üîπ Relance le chargement de la liste √† chaque frappe
searchAgentInput.addEventListener("input", () => {
    loadTotalHours();
});

// Texte initial coh√©rent avec le tri par d√©faut
sortButton.innerText = "‚è± Trier par heures";

sortButton.onclick = (e) => {
    e.preventDefault();

    currentSort = currentSort === "grade" ? "hours" : "grade";

    sortButton.innerText =
        currentSort === "grade"
            ? "‚è± Trier par heures"
            : "üì∂ Trier par grade";

    loadTotalHours();
};



async function loadTotalHours() {
    totalHoursList.innerHTML = "";
    // üîπ Texte de recherche
const filter = searchAgentInput.value.toLowerCase();

    const snap = await getDocs(collection(db, "agents"));
    const agentsArray = [];

    snap.forEach(docu => {
        const data = docu.data();
        const history = data.pointeuse || [];

        let totalMs = 0;
        history.forEach(entry => {
            if (entry.arrivee && entry.depart) {
                totalMs += new Date(entry.depart) - new Date(entry.arrivee);
            }
        });

        agentsArray.push({
            id: docu.id,
            data,
            history,
            totalMs
        });
    });

    // üîπ TRI selon le crit√®re actuel
    if (currentSort === "hours") {
        agentsArray.sort((a, b) => b.totalMs - a.totalMs);
    } else if (currentSort === "grade") {
        agentsArray.sort((a, b) => sortByGrade(a.data, b.data));
    }

    // üîπ AFFICHAGE APR√àS TRI
    // üîπ AFFICHAGE APR√àS TRI ET FILTRE DE RECHERCHE
agentsArray
  .filter(agent => `${agent.data.prenom} ${agent.data.nom}`.toLowerCase().includes(filter))
  .forEach(agent => {
    const { data, history, totalMs, id } = agent;
    const heures = Math.floor(totalMs / 1000 / 60 / 60);
    const minutes = Math.floor((totalMs / 1000 / 60) % 60);

    const div = document.createElement("div");
    div.className = "agent";
    div.style.cursor = "pointer";
    div.style.padding = "10px";
    div.style.background = "#1f2937";
    div.style.borderRadius = "8px";
    div.innerText = `${data.prenom} ${data.nom} - ${data.grade} | ${heures}h ${minutes}m`;

    div.onclick = async () => {
        const oldPopup = document.getElementById("adminPointeusePopup");
        if (oldPopup) oldPopup.remove();

        const popup = document.createElement("div");
        popup.id = "adminPointeusePopup";
        popup.style.position = "fixed";
        popup.style.top = "50%";
        popup.style.left = "50%";
        popup.style.transform = "translate(-50%, -50%)";
        popup.style.width = "350px";
        popup.style.maxHeight = "400px";
        popup.style.overflowY = "auto";
        popup.style.background = "#1f2937";
        popup.style.padding = "20px";
        popup.style.borderRadius = "10px";
        popup.style.boxShadow = "0 0 15px rgba(0,0,0,0.5)";
        popup.style.zIndex = 2000;
        popup.style.color = "white";

        const closeBtn = document.createElement("span");
        closeBtn.innerText = "‚úñ";
        closeBtn.style.cursor = "pointer";
        closeBtn.style.float = "right";
        closeBtn.style.fontWeight = "bold";
        closeBtn.onclick = () => popup.remove();
        popup.appendChild(closeBtn);

        const title = document.createElement("h4");
        title.innerText = `Pointeuse de ${data.prenom} ${data.nom}`;
        title.style.marginTop = "0";
        popup.appendChild(title);

        history.forEach((entry, index) => {
            const arrivee = entry.arrivee ? new Date(entry.arrivee).toLocaleString("fr-FR") : "-";
            const depart = entry.depart ? new Date(entry.depart).toLocaleString("fr-FR") : "-";

            const entryDiv = document.createElement("div");
            entryDiv.style.display = "flex";
            entryDiv.style.justifyContent = "space-between";
            entryDiv.style.alignItems = "center";
            entryDiv.innerText = `Arriv√©e : ${arrivee} | D√©part : ${depart}`;

            if (!entry.depart) {
                const stopBtn = document.createElement("button");
                stopBtn.textContent = "üî¥ Terminer le service";
                stopBtn.style.marginLeft = "10px";
                stopBtn.onclick = async () => {
                    const ok = await customConfirm("Supprimer compl√®tement ce service ?");
                    if (!ok) return;

                    const docRef = doc(db, "agents", id);
                    const snap = await getDoc(docRef);
                    const freshHistory = snap.data().pointeuse || [];
                };
                entryDiv.appendChild(stopBtn);
            }

            popup.appendChild(entryDiv);
        });

        document.body.appendChild(popup);
    };

    totalHoursList.appendChild(div);
  });
}




const btnResetHours = document.getElementById("btnResetHours");

btnResetHours.onclick = async () => {
    // üîπ Utilisation de la confirmation personnalis√©e
    const ok = await customConfirm("Voulez-vous vraiment r√©initialiser les heures de tous les agents ?");
    if (!ok) return;

    try {
        const snap = await getDocs(collection(db, "agents"));

        for (const docu of snap.docs) {
            await updateDoc(doc(db, "agents", docu.id), { pointeuse: [] });
        }

        // üîπ Recharge la liste apr√®s r√©initialisation
        loadTotalHours();

        // üîπ Message de succ√®s personnalis√©
        customAlert("Heures r√©initialis√©es pour tous les agents !");
    } catch (err) {
        console.error(err);
        customAlert("Erreur lors de la r√©initialisation des heures.");
    }
};

document.getElementById("btnBackHomeFromMDT").onclick = () => {
    showPage(homePage);
    checkAdmin(); // pour remettre le bouton admin si n√©cessaire
};

document.getElementById("btnBackHomeFromPointeuse").onclick = () => {
    showPage(homePage);
    checkAdmin(); // pour remettre le bouton admin si l‚Äôutilisateur est admin
};






async function loadAllAgents(){
    const list = document.getElementById("allAgentsList");
    list.innerHTML = "";

    const snap = await getDocs(collection(db, "agents"));

    if(snap.empty){
        const span = document.createElement("span");
        span.innerText = "Aucun agent trouv√©.";
        list.appendChild(span);
        return;
    }

    // Stocke tous les agents dans un tableau
    const agents = snap.docs.map(docu => ({ id: docu.id, ...docu.data() }));

    // Trie par grade
    agents.sort(sortByGrade);

    // Affiche les agents tri√©s
    agents.forEach(data => {
        const div = document.createElement("div");
        div.className = "agent";
        div.style.cursor = "pointer";
        div.style.padding = "10px";
        div.style.background = "#1f2937";
        div.style.borderRadius = "8px";
        div.innerText = `${data.prenom} ${data.nom} - ${data.grade}`;

        div.onclick = () => openAgentDetail(data.id, data);

        list.appendChild(div);
    });
}


async function openAgentDetail(id) { // async ajout√©, plus besoin de param√®tre data
    // ‚ö° R√©cup√©rer les donn√©es √† jour depuis Firestore
    const docSnap = await getDoc(doc(db, "agents", id));
    if (!docSnap.exists()) return alert("Agent introuvable");
    const data = docSnap.data();
    data.id = id; // utile pour updateDoc plus tard
    const isTrainerRole = currentUser && trainers.includes(currentUser.id);


    showPage(pageAgentDetail);

    const formattedDate = data.arrivalDate
        ? new Date(data.arrivalDate).toLocaleDateString("fr-FR", {
            day: "2-digit",
            month: "long",
            year: "numeric"
        })
        : "Non renseign√©e";

    // Sanctions existantes
    let sanctions = data.sanctions || [];
    let notes = data.notes || [];

    function renderNotes() {
  if (!notes.length) return `<p>Aucune note</p>`;

  return `
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
      ${notes.map((n, index) => `
        <div style="background:#111827; padding:8px; border-radius:6px; display:flex; justify-content:space-between;">
          <span>${n.texte} <small style="color:#9ca3af;">(${n.date})</small></span>
          <button onclick="removeNote(${index})"
            style="background:#dc2626; color:white; border:none; padding:4px 6px; border-radius:4px; cursor:pointer;">
            üóëÔ∏è
          </button>
        </div>
      `).join("")}
    </div>
  `;
}




      // ‚ö° Fonction pour supprimer une sanction
window.removeSanction = async (index) => {
    sanctions.splice(index, 1); // supprime la sanction du tableau
    await updateDoc(doc(db, "agents", data.id), { sanctions }); // met √† jour Firestore
    document.getElementById("sanctionsList").innerHTML = renderSanctions(); // rafra√Æchit l'affichage
    document.getElementById("sanctionsList").appendChild(sanctionDiv);
};


    // ‚ö° Fonction pour afficher les sanctions (d√©j√† existante)
    function renderSanctions() {
    if (!sanctions.length) return `<p>Aucune sanction</p>`;

    return `
    <div style="margin-top:10px; overflow-x:auto;">
      <table style="width:100%; border-collapse: collapse; text-align:left; background:#111827; color:white; border-radius:8px; overflow:hidden;">
        <thead style="background:#1f2937;">
          <tr>
            <th style="padding:8px 12px;">Type</th>
            <th style="padding:8px 12px;">Raison</th>
            <th style="padding:8px 12px;">Date</th>
            <th style="padding:8px 12px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${sanctions.map((s, index) => `
            <tr style="border-bottom: 1px solid #333;">
              <td style="padding:8px 12px;">${s.type}</td>
              <td style="padding:8px 12px;">${s.raison}</td>
              <td style="padding:8px 12px; color:#f87171;">${s.date || ''}</td>
              <td style="padding:8px 12px;">
                <button onclick="removeSanction(${index})"
                  style="background:#dc2626; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    `;
}



    // ‚ö° Ici on met le code formations
    function renderFormations() {

    const formations = data.formations || [];

    const formationsPossibles = [
        "Call Radio",
        "PPA Th√©orique",
        "Formation Finale",
        "PPA Pratique",
        "APJA"
    ];

    return `
<div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
    ${formationsPossibles.map(f => {
        const found = formations.find(x => x.nom === f);

        return `
        <div class="formation-row" 
             style="display:flex; justify-content:space-between; align-items:center; padding:6px 10px; background:#111827; border-radius:8px;">

            <span>
                ${f}
                ${found ? `<small style="color:#16a34a; margin-left:8px;">(${found.date})</small>` : ""}
            </span>

            <label class="switch" style="transform: scale(1.5);"> <!-- agrandi le switch -->
                <input type="checkbox"
                       ${found ? "checked" : ""}
                       onchange="toggleFormation('${f}')">
                <span class="slider"></span>
            </label>
        </div>
        `;
    }).join("")}
</div>
`;
}




window.toggleFormation = async (formation) => {
    let formations = data.formations || [];

    const today = new Date().toLocaleDateString("fr-FR");

    const index = formations.findIndex(f => f.nom === formation);

    if (index !== -1) {
        formations.splice(index, 1);
    } else {
        formations.push({
            nom: formation,
            date: today
        });
    }

    data.formations = formations;

    await updateDoc(doc(db, "agents", data.id), { formations });

    document.getElementById("FormationsList").innerHTML = renderFormations();
};


window.removeNote = async (index) => {
  notes.splice(index, 1);
  await updateDoc(doc(db, "agents", data.id), { notes });
  document.getElementById("notesItems").innerHTML = renderNotes();
};


window.addNote = async () => {
  const input = document.getElementById("noteInput");
  const texte = input.value.trim();

  if (!texte) {
    showToast("Veuillez √©crire une note !", 2000, "#ef4444");
    return;
  }

  try {
    const today = new Date().toLocaleDateString("fr-FR");

    notes.push({
      texte,
      date: today
    });

    await updateDoc(doc(db, "agents", data.id), { notes });

    document.getElementById("notesItems").innerHTML = renderNotes();
    input.value = "";

    showToast("Note ajout√©e avec succ√®s !", 2000, "#10b981");

  } catch (error) {
    console.error("Erreur ajout note :", error);
    showToast("Impossible d'ajouter la note.", 2500, "#ef4444");
  }
};



    // ‚ö° Contenu HTML
    agentDetailContent.innerHTML = `
  <div class="card card-blue">
    <h3>${data.prenom} ${data.nom}</h3>

     ${currentUser && admins.includes(currentUser.id) ? `
      <button id="deleteAgentBtn"
              style="
                position:absolute;
                top:10px;
                right:10px;
                background:#dc2626;
                color:white;
                border:none;
                padding:4px 8px;
                border-radius:5px;
                cursor:pointer;
              ">
        üóëÔ∏è
      </button>` : ``}

    <div style="display:flex; align-items:center; gap:5px;"> 
  <strong>Grade :</strong>
  <span id="gradeText">${data.grade}</span>

  ${!isTrainerRole ? `
  <div style="position:relative; display:inline-block; margin-left:5px;">
    <button id="gradeMenuBtn"
      style="
        background:none;
        border:none;
        cursor:pointer;
        font-weight:bold;
        padding:0;
        line-height:1;
      ">
      ‚Ä¶
    </button>

    <div id="gradeMenu" style="
        display:none;
        position:absolute;
        top:100%;   
        right:0;    
        background:#111827;
        color:white;
        border:1px solid #333;
        padding:8px;
        border-radius:6px;
        z-index:1000;
        width:220px;
        margin-top:4px;
    ">
      <select id="gradeSelect" style="width:100%;">
        ${gradeOrder.map(g => `<option value="${g}" ${g === data.grade ? "selected" : ""}>${g}</option>`).join('')}
      </select>
      <button id="gradeSaveBtn" style="
          margin-top:5px;
          background:#16a34a; 
          color:white; 
          border:none; 
          padding:4px 8px; 
          border-radius:4px; 
          cursor:pointer;
          width:100%;
        ">
        Valider
      </button>
    </div>
  </div>
  ` : ``}
</div>


${currentUser && admins.includes(currentUser.id) ? `
<!-- CHECKBOX ADMIN -->
<div style="margin-top:10px; border-top:1px solid #333; padding-top:8px;">
  <strong>R√¥le :</strong>
  <label style="display:inline-block; margin-left:10px; margin-right:15px;">
    <input type="checkbox" id="roleFormateur" ${data.formateur ? 'checked' : ''} />
    Formateur
  </label>
  <label style="display:inline-block;">
    <input type="checkbox" id="roleRecruteur" ${data.recruteur ? 'checked' : ''} />
    Recruteur
  </label>
</div>
` : ``}



<p><strong>Date arriv√©e :</strong> ${formattedDate}</p>

    <hr style="border:none; height:3px; background:#555; margin:10px 0;">

    <!-- Onglets -->
    <div style="display:flex; gap:10px; margin-bottom:10px;">
  <button id="tabFormations">Formations</button>

  ${!isTrainerRole ? `
    <button id="tabSanctions">Sanctions</button>
    <button id="tabNotes">Notes</button>
    <button id="tabGradeHistory">Historique Grades</button>
  ` : ``}
</div>



    <!-- Contenus -->
<div id="tabContent">

  <div id="FormationsList">
    ${renderFormations()}
  </div>

  <div id="sanctionsList" style="display:none;">
    <div id="sanctionsItems">${renderSanctions()}</div>
    <div id="sanctionFormContainer"></div>
  </div>

  <div id="notesList" style="display:none;">
  <div id="notesItems">${renderNotes()}</div>

  <div style="display:flex; gap:10px; margin-top:10px;">
    <input id="noteInput" placeholder="Ajouter une note..."
      style="flex:1; padding:6px; border-radius:6px; border:none;">

    <button id="addNoteBtn"
      style="background:#2563eb; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer;">
      Ajouter
    </button>
  </div>
</div>
<div id="gradeHistoryList" style="display:none;"></div>
</div>
</div>
`;

document.getElementById("gradeHistoryList").innerHTML = renderGradeHistory();


document.getElementById("tabFormations").onclick = () => {
  FormationsList.style.display = "block";
  sanctionsList.style.display = "none";
  notesList.style.display = "none";
  gradeHistoryList.style.display = "none";
};

document.getElementById("tabSanctions").onclick = () => {
  FormationsList.style.display = "none";
  sanctionsList.style.display = "block";
  notesList.style.display = "none";
  gradeHistoryList.style.display = "none";
};

document.getElementById("tabNotes").onclick = () => {
  FormationsList.style.display = "none";
  sanctionsList.style.display = "none";
  notesList.style.display = "block";
  gradeHistoryList.style.display = "none";
};

document.getElementById("tabGradeHistory").onclick = () => {
  FormationsList.style.display = "none";
  sanctionsList.style.display = "none";
  notesList.style.display = "none";
  gradeHistoryList.style.display = "block";
  gradeHistoryList.innerHTML = renderGradeHistory();
};


const formateurCheck = document.getElementById("roleFormateur");
const recruteurCheck = document.getElementById("roleRecruteur");

if (currentUser && admins.includes(currentUser.id)) {
    // Admin connect√© ‚Üí peut cocher/d√©cocher
    formateurCheck.disabled = false;
    recruteurCheck.disabled = false;

    formateurCheck.onchange = async (e) => {
        const value = e.target.checked;
        await updateDoc(doc(db, "agents", data.id), { formateur: value });
        data.formateur = value;
    };

    recruteurCheck.onchange = async (e) => {
        const value = e.target.checked;
        await updateDoc(doc(db, "agents", data.id), { recruteur: value });
        data.recruteur = value;
    };
} else {
    // Pas admin ‚Üí d√©sactiv√©
    formateurCheck.disabled = true;
    recruteurCheck.disabled = true;
}









const deleteBtn = document.getElementById("deleteAgentBtn");
if (deleteBtn) {
    deleteBtn.onclick = async () => {
        const confirmDelete = confirm(`Voulez-vous vraiment supprimer ${data.prenom} ${data.nom} ?`);
        if (!confirmDelete) return;

        try {
            await deleteDoc(doc(db, "agents", data.id));
            alert("Agent supprim√© !");
            showPage(adminHome);
            loadAllAgents(); // rafra√Æchir la liste si tu as une fonction existante
        } catch (err) {
            console.error(err);
            alert("Erreur lors de la suppression.");
        }
    };
}


const gradeBtn = document.getElementById("gradeMenuBtn");
const gradeMenu = document.getElementById("gradeMenu");
const gradeSelect = document.getElementById("gradeSelect");
const gradeText = document.getElementById("gradeText");
const gradeSave = document.getElementById("gradeSaveBtn");

// Afficher / cacher le menu
gradeBtn.onclick = (e) => {
    e.stopPropagation(); // emp√™che la fermeture instantan√©e
    gradeMenu.style.display = gradeMenu.style.display === "block" ? "none" : "block";
};

// Fermer le menu si clic √† l‚Äôext√©rieur
document.addEventListener("click", (e) => {
    if (!gradeMenu.contains(e.target) && e.target !== gradeBtn) {
        gradeMenu.style.display = "none";
    }
});
// Sauvegarder le grade
gradeSave.onclick = async () => {

    const newGrade = gradeSelect.value;
    const oldGrade = data.grade;

    if (newGrade === oldGrade) {
        showToast("Aucun changement d√©tect√©.", 2000, "#f59e0b");
        return;
    }

    try {

        const today = new Date().toLocaleDateString("fr-FR");

        const newHistoryEntry = {
            oldGrade: oldGrade,
            newGrade: newGrade,
            date: today
        };

        const gradeHistory = data.gradeHistory || [];
        gradeHistory.push(newHistoryEntry);

        gradeText.textContent = newGrade;
        gradeMenu.style.display = "none";

        await updateDoc(doc(db, "agents", data.id), {
            grade: newGrade,
            gradeHistory: gradeHistory
        });

        data.grade = newGrade;
        data.gradeHistory = gradeHistory;

        showToast("Grade mis √† jour avec succ√®s.", 2000, "#10b981");

    } catch (error) {
        console.error("Erreur mise √† jour grade :", error);
        showToast("Erreur lors de la mise √† jour du grade.", 2500, "#ef4444");
    }
};




    // ‚ö° Ajouter une nouvelle sanction
    const sanctionDiv = document.createElement("div");
    sanctionDiv.style.display = "flex";
    sanctionDiv.style.gap = "10px";
    sanctionDiv.style.marginTop = "10px";

    const typeSelect = document.createElement("select");
    ["Avertissement oral", "Avertissement √©crit", "Bl√¢me", "Mise √† pied", "Licenciement"].forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        typeSelect.appendChild(opt);
    });

    const reasonInput = document.createElement("input");
    reasonInput.placeholder = "Raison";
    reasonInput.style.flex = "1";

    const btnAdd = document.createElement("button");
    btnAdd.textContent = "Ajouter";
    btnAdd.style.background = "#dc2626";
    btnAdd.style.color = "white";
    btnAdd.style.border = "none";
    btnAdd.style.padding = "6px 10px";
    btnAdd.style.borderRadius = "5px";
    btnAdd.style.cursor = "pointer";

    btnAdd.onclick = async () => {
    const type = typeSelect.value;
    const raison = reasonInput.value.trim();
    if (!raison) return alert("Veuillez indiquer une raison");

    const newSanction = { 
        type, 
        raison,
        date: new Date().toLocaleDateString("fr-FR")
    };

    sanctions.push(newSanction);

    await updateDoc(doc(db, "agents", data.id), { sanctions });

    // ‚úÖ Mettre √† jour seulement la liste
    document.getElementById("sanctionsItems").innerHTML = renderSanctions();

    reasonInput.value = "";
    typeSelect.selectedIndex = 0;
    alert("Sanction ajout√©e !");
};


    sanctionDiv.appendChild(typeSelect);
    sanctionDiv.appendChild(reasonInput);
    sanctionDiv.appendChild(btnAdd);
    if (!isTrainerRole) {
    document.getElementById("sanctionsList").appendChild(sanctionDiv);
}
    document.getElementById("addNoteBtn").onclick = addNote;

    function renderGradeHistory() {
        const history = data.gradeHistory || [];
        if (!history.length) return "<p>Aucun changement de grade</p>";

        return `
        <div style="display:flex; flex-direction:column; gap:6px; margin-top:10px;">
            ${history.map(h => `
            <div style="background:#111827; padding:6px 10px; border-radius:6px; display:flex; justify-content:space-between;">
                <span>
                    ${h.oldGrade} ‚Üí ${h.newGrade} 
                    <small style="color:#9ca3af;">(${h.date})</small>
                </span>
            </div>
            `).join("")}
        </div>
        `;
    }

}



async function fillAPJ() {
    const apjInput = document.getElementById("procAPJ");
    if (!apjInput) return;

    try {
        if (currentUser && currentUser.prenom && currentUser.nom) {
            // Si grade dispo dans currentUser, on l'ajoute
            const grade = currentUser.grade ? ` | ${currentUser.grade}` : "";
            apjInput.value = `${currentUser.prenom} ${currentUser.nom}${grade}`;
        } else if (currentUser && currentUser.uid) {
            const db = firebase.firestore();
            const docRef = db.collection("agents").doc(currentUser.uid);
            const docSnap = await docRef.get();
            if (docSnap.exists) {
                const data = docSnap.data();
                const grade = data.grade ? ` (${data.grade})` : "";
                apjInput.value = `${data.prenom} ${data.nom}${grade}`;

                // On stocke √©galement pour la session si besoin
                window.currentUser.prenom = data.prenom;
                window.currentUser.nom = data.nom;
                window.currentUser.grade = data.grade || "";
            } else {
                apjInput.value = "N/A";
            }
        } else {
            apjInput.value = "N/A";
        }
    } catch (error) {
        console.error("Erreur r√©cup√©ration APJA depuis Firestore:", error);
        apjInput.value = "N/A";
    }
}



// Appel au chargement de la page
document.addEventListener("DOMContentLoaded", fillAPJ);







// ==================== GESTION DES √âTAPES ====================
function goToStep(stepId) {
    const steps = document.querySelectorAll(".step");
    steps.forEach(step => step.classList.remove("active"));
    const target = document.getElementById(stepId);
    if (target) target.classList.add("active");
}



// ==================== VALIDATION √âTAPE 1 ====================
document.getElementById("validateID").addEventListener("click", () => {
    const nom = document.getElementById("procNom").value.trim();
    const prenom = document.getElementById("procPrenom").value.trim();
    const dob = document.getElementById("procDOB").value.trim();
    const taille = document.getElementById("procTaille").value.trim();
    const sexe = document.getElementById("procSexe").value;
    const tel = document.getElementById("procTel").value.trim();

    // V√©rifie que tous les champs sont remplis
    if (!nom || !prenom || !dob || !taille || !sexe || !tel) {
        showToast("Veuillez remplir tous les champs obligatoires.", 2000, "#ef4444");
        return;
    }

    // V√©rifie que le nom et le pr√©nom ne contiennent que des lettres
    if (!/^[a-zA-Z√Ä-√ø \-]+$/.test(nom)) {
        showToast("Le nom ne doit contenir que des lettres.", 2000, "#ef4444");
        return;
    }
    if (!/^[a-zA-Z√Ä-√ø \-]+$/.test(prenom)) {
        showToast("Le pr√©nom ne doit contenir que des lettres.", 2000, "#ef4444");
        return;
    }


    // V√©rifie que la taille est uniquement en chiffres
    if (!/^\d+$/.test(taille)) {
        showToast("La taille doit contenir uniquement des chiffres.", 2000, "#ef4444");
        return;
    }

    // Convertit en nombre
    const tailleNum = parseInt(taille, 10);

    // V√©rifie la plage
    if (tailleNum < 1 || tailleNum > 300) {
        showToast("La taille doit √™tre comprise entre 1 et 300 cm.", 2000, "#ef4444");
        return;
    }


    // V√©rifie que le t√©l√©phone contient exactement 10 chiffres
    const telDigits = tel.replace(/\D/g, ''); // supprime tout sauf les chiffres
    if (telDigits.length !== 10) {
        showToast("Le num√©ro de t√©l√©phone doit contenir exactement 10 chiffres.", 2000, "#ef4444");
        return;
    }

    // Formate le t√©l√©phone avec des points : 07.10.52.13.99
    const formattedTel = telDigits.replace(/(\d{2})(?=\d)/g, '$1.');
    document.getElementById("procTel").value = formattedTel.slice(0, 14); // limite √† 14 caract√®res

    // Si tout est correct, passe √† l'√©tape 2
    goToStep("step2");
});



// ==================== VALIDATION √âTAPE 2 ====================
document.getElementById("validateFouille").addEventListener("click", () => {
    // On r√©cup√®re la valeur mais on ne bloque pas si elle est vide
    const fouille = document.getElementById("fouilleObservation").value.trim() || "N√©ant";
    goToStep("step3"); // Passage direct √† la lecture des droits
});


// ==================== VALIDATION √âTAPE 3 ====================
document.getElementById("validateDroits").addEventListener("click", () => {
    // V√©rifie que la lecture des droits est faite
    const lectureConfirm = document.getElementById("lectureConfirm");
    if (!lectureConfirm.checked) {
        showToast("Veuillez confirmer la lecture des droits.", 2000, "#ef4444");
        return;
    }

    // üîí V√©rifie que la reconnaissance des faits est coch√©e
    const reconnaissanceInput = document.querySelector('input[name="reconnaissance"]:checked');
    if (!reconnaissanceInput) {
        showToast("Veuillez indiquer si les faits sont reconnus.", 2000, "#ef4444");
        return;
    }

    // Si tout est ok, passe √† l'√©tape 4
    goToStep("step4");
});

// ==================== ACCORD√âON INFRACTIONS ====================
const infractionsData = {
    "Atteinte aux Biens": {
    "Acte de vandalisme": { amende: 5000, temps: 15 },
    "Braquage ATM / Carrefour": { amende: 3000, temps: 15 },
    "Braquage de Brinks": { amende: 30000, temps: 30 },
    "Braquage de Bijouterie ou Banque": { amende: 150000, temps: 30 },
    "Cambriolage / Vol de Contenaire": { amende: 4000, temps: 15 },
    "Intrusion dans un b√¢timent public": { amende: 5000, temps: 15 },
    "Possession de kit de crochetage": { amende: 1500, temps: 20, multiplicateur: true },
    "Possession de bo√Ætier ATM": { amende: 1500, temps: 20, multiplicateur: true },
    "Port du masque en ville": { amende: 1000, temps: 0 },
    "Possession d‚Äôargent en esp√®ce +10 000": { amende: 0, temps: 15, montantLibre: true },
    "Possession d‚Äôargent sale": { amende: 0, temps: 20, montantLibre: true },
    "Possession de bijoux": { amende: 500, temps: 10, multiplicateur: true },
    "Vol de v√©hicule": { amende: 5000, temps: 20 } // tu n‚Äôas pas donn√© montant/temps   
},


    "Atteinte aux personnes": {
    "Violence l√©g√®re": { amende: 200, temps: 60 },
    "Agression": { amende: 500, temps: 120 },
    "Complicit√© d‚Äô√©meute": { amende: 10000, temps: 25 },
    "Canular t√©l√©phonique": { amende: 5000, temps: 15 },
    "Enl√®vement ou prise d‚Äôotage": { amende: 15000, temps: 15 },
    "Escroquerie ou Arnaque": { amende: 5000, temps: 20 },
    "√âvasion": { amende: 20000, temps: 30 },
    "Manifestation non d√©clar√©e": { amende: 10000, temps: 25 },
    "Menace de mort": { amende: 15000, temps: 30 },
    "Menace de mort sur agent": { amende: 20000, temps: 20 },
    "Meurtre/tentative": { amende: 60000, temps: 30 },
    "Meurtre/tentative sur agent": { amende: 50000, temps: 30 },
    "Rebellion": { amende: 5000, temps: 30 },
    "Outrage √† agent": { amende: 10000, temps: 30, multiplicateur: true },
    "Propos/injures racistes": { amende: 20000, temps: 15 },
    "R√©bellion": { amende: 15000, temps: 30 },
    "Refus de proc√©dure": { amende: 15000, temps: 20 },
    "Trouble √† l‚Äôordre public": { amende: 20000, temps: 30 },
    "Tentative de corruption": { amende: 20000, temps: 20 },
    "Usurpation d‚Äôidentit√©": { amende: 20000, temps: 15 },
    "Violence simple": { amende: 3000, temps: 10 },
    "Kidnapping": { amende: 3000, temps: 15 },
    "Violence sur agent": { amende: 20000, temps: 30 } // Montant/temps non pr√©cis√©
},

    "Code de la Route": {
    "Exc√®s de vitesse": { amende: 90, temps: 15 },
    "Conduite sans permis": { amende: 2000, temps: 0 },
    "Abus de klaxon en centre-ville": { amende: 200, temps: 0 },
    "Conduite sans casque": { amende: 300, temps: 0 },
    "Conduite dangereuse": { amende: 500, temps: 0 },
    "Conduite sans assurance": { amende: 2500, temps: 0 },
    "Course Poursuite": { amende: 2500, temps: 15 },
    "GO FAST": { amende: 8000, temps: 30 },
    "D√©lit de fuite": { amende: 2000, temps: 10 },
    "Vitesse excessive": { amende: 1000, temps: 0 } // Montant/temps non pr√©cis√©
},

    "Possession de Stup√©fiants": {
        "Mati√®re premi√®res (Weed, Meth, Coca√Øne)": { amende: 150, temps: 20, multiplicateur: true },
        "Pochons de Weed, Meth, Coca√Øne / crack": { amende: 400, temps: 20, multiplicateur: true },
        "Vente de drogues en flagrand delit": { amende: 5000, temps: 20 }
    },

    "Possession d'Armes": {
    "Flare/Fumig√®ne/Mortier": { amende: 250, temps: 15, multiplicateur: true },
    "Batte de baseball/couteau": { amende: 9500, temps: 15 },
    "Mousquet": { amende: 30000, temps: 30 },
    "Pistolet": { amende: 50000, temps: 30 },
    "Mini SMG": { amende: 50000, temps: 30 },
    "MP5": { amende: 100000, temps: 30 },
    "M4": { amende: 150000, temps: 30 },
    "Munitions": { amende: 200, temps: 20 },
    "Cocktail Molotov/Pierres": { amende: 300, temps: 30, multiplicateur: true }
}
};


function renderInfractions() {
    const container = document.getElementById("infractionsList");
    container.innerHTML = "";

    Object.entries(infractionsData).forEach(([categorie, infractions]) => {
        const catDiv = document.createElement("div");
        catDiv.classList.add("accordion-category");

        const header = document.createElement("div");
        header.textContent = categorie;
        header.classList.add("accordion-header");

        const content = document.createElement("div");
        content.classList.add("accordion-content");

        Object.entries(infractions).forEach(([nom, data]) => {
            const label = document.createElement("label");
            label.style.display = "flex";
label.style.alignItems = "center";
label.style.justifyContent = "space-between";
label.style.cursor = "pointer";
label.style.padding = "4px 0";

const checkbox = document.createElement("input");
checkbox.type = "checkbox";
checkbox.value = nom;
checkbox.dataset.amende = data.amende;
checkbox.dataset.temps = data.temps;
checkbox.dataset.multiplicateur = data.multiplicateur || false;
checkbox.dataset.montantLibre = data.montantLibre || false; // <-- ici
checkbox.classList.add("infractionCheckbox");

// üî• Partie gauche (checkbox + texte)
const leftPart = document.createElement("div");
leftPart.style.display = "flex";
leftPart.style.alignItems = "center";
leftPart.style.gap = "10px";

leftPart.appendChild(checkbox);

const texte = document.createElement("span");
texte.textContent = `${nom} | ${data.amende}‚Ç¨ | ${data.temps}min`;

leftPart.appendChild(texte);

label.appendChild(leftPart);


// üî• Partie droite (montant libre pour saisie manuelle)
if (data.montantLibre) {
    const montantContainer = document.createElement("div");
    montantContainer.style.display = "flex";
    montantContainer.style.alignItems = "center";
    montantContainer.style.gap = "5px";

    const euroLabel = document.createElement("span");
    euroLabel.textContent = "‚Ç¨";
    euroLabel.style.color = "#22c55e";
    euroLabel.style.fontWeight = "bold";

    const inputMontant = document.createElement("input");
    inputMontant.type = "number";
    inputMontant.min = "0";
    inputMontant.value = "0"; // valeur par d√©faut
    inputMontant.style.width = "90px";
    inputMontant.style.textAlign = "center";
    inputMontant.style.padding = "4px";
    inputMontant.style.borderRadius = "6px";
    inputMontant.style.border = "1px solid #444";
    inputMontant.style.background = "#1f2937";
    inputMontant.style.color = "white";
    inputMontant.classList.add("montant-saisie");

    montantContainer.appendChild(euroLabel);
    montantContainer.appendChild(inputMontant);

    label.appendChild(montantContainer);
}



// üî• Partie droite (multiplicateur)
if (data.multiplicateur) {

    const multiContainer = document.createElement("div");
    multiContainer.style.display = "flex";
    multiContainer.style.alignItems = "center";
    multiContainer.style.gap = "5px";

    const xLabel = document.createElement("span");
    xLabel.textContent = "x";
    xLabel.style.fontWeight = "bold";
    xLabel.style.color = "#facc15"; // jaune visible

    const inputMulti = document.createElement("input");
    inputMulti.type = "number";
    inputMulti.min = "1";
    inputMulti.value = "1";

    inputMulti.style.width = "60px";
    inputMulti.style.textAlign = "center";
    inputMulti.style.padding = "4px";
    inputMulti.style.borderRadius = "6px";
    inputMulti.style.border = "1px solid #444";
    inputMulti.style.background = "#1f2937";
    inputMulti.style.color = "white";

    inputMulti.classList.add("multiplicateur-input");

    multiContainer.appendChild(xLabel);
    multiContainer.appendChild(inputMulti);

    label.appendChild(multiContainer);
}


            content.appendChild(label);
        });

        header.onclick = () => {
            content.style.maxHeight = content.style.maxHeight && content.style.maxHeight !== "0px"
                ? "0"
                : content.scrollHeight + "px";
        };

        catDiv.appendChild(header);
        catDiv.appendChild(content);
        container.appendChild(catDiv);
    });

    const allCheckboxes = document.querySelectorAll(".infractionCheckbox");
    allCheckboxes.forEach(cb => {
        cb.addEventListener("change", () => {
            const checked = Array.from(allCheckboxes).filter(c => c.checked);
            allCheckboxes.forEach(c => {
                c.disabled = !c.checked && checked.length >= 3;
            });
        });
    });
}

renderInfractions();





const searchInput = document.getElementById("searchInfractions");

searchInput.addEventListener("input", () => {
    const filter = searchInput.value.toLowerCase();

    const categories = document.querySelectorAll(".accordion-category");
    categories.forEach(cat => {
        let anyVisible = false;

        // Pour chaque label (infraction)
        const labels = cat.querySelectorAll("label");
        labels.forEach(label => {
            const text = label.textContent.toLowerCase();
            const match = text.includes(filter);
            label.style.display = match ? "flex" : "none";
            if(match) anyVisible = true;
        });

        // Affiche ou masque la cat√©gorie si aucune infraction ne correspond
        cat.style.display = anyVisible ? "block" : "none";
    });
});

// ==================== FORMAT NUM√âRO DE T√âL√âPHONE ====================
const telInput = document.getElementById("procTel");
telInput.addEventListener("input", () => {
    // Supprime tout ce qui n'est pas chiffre
    let nums = telInput.value.replace(/\D/g, '');
    
    // Limite √† 10 chiffres
    nums = nums.substr(0, 10);
    
    // Formate en 2 chiffres + point
    let formatted = '';
    for (let i = 0; i < nums.length; i += 2) {
        if (i > 0) formatted += '.';
        formatted += nums.substr(i, 2);
    }
    
    telInput.value = formatted;
});



// ==================== FILTRE CHIFFRES TAILLE ====================
const procTaille = document.getElementById("procTaille");

// Limite la saisie √† 3 chiffres en temps r√©el
procTaille.addEventListener("input", () => {
    // Supprime tout ce qui n'est pas chiffre
    procTaille.value = procTaille.value.replace(/\D/g, '');
    // Limite √† 3 chiffres
    if (procTaille.value.length > 3) {
        procTaille.value = procTaille.value.slice(0, 3);
    }
});


// ==================== FILTRE LETTRES NOM ====================
const nomInput = document.getElementById("procNom");
nomInput.addEventListener("input", () => {
    // Supprime tout ce qui n'est pas lettre, accent, espace ou tiret
    nomInput.value = nomInput.value.replace(/[^a-zA-Z√Ä-√ø \-]/g, '');
});

// ==================== FILTRE LETTRES PR√âNOM ====================
const prenomInput = document.getElementById("procPrenom");
prenomInput.addEventListener("input", () => {
    // Supprime tout ce qui n'est pas lettre, accent, espace ou tiret
    prenomInput.value = prenomInput.value.replace(/[^a-zA-Z√Ä-√ø \-]/g, '');
});



// ==================== DROITS AVOCAT ====================
const chkAvocat = document.getElementById("chkAvocat");
const presenceContainer = document.getElementById("presenceAvocatContainer");
if (chkAvocat) {
    chkAvocat.addEventListener("change", () => {
        presenceContainer.style.display = chkAvocat.checked ? "block" : "none";
    });
}







let modeGeneration = "creation"; // par d√©faut

document.addEventListener("DOMContentLoaded", () => {

    // ==================== CHOIX DE PROC√âDURE ====================
    document.getElementById("creationCasier").addEventListener("click", () => {
        modeGeneration = "creation";
        goToStep("step1");
    });

    document.getElementById("ajoutCasier").addEventListener("click", () => {
    modeGeneration = "ajout";
    goToStep("step2");

    // üîÑ R√©initialisation des champs
    document.getElementById("procObservation").value = "";
    document.getElementById("procRapport").value = "";
    document.getElementById("fouilleObservation").value = "";
    document.getElementById("lectureConfirm").checked = false;

    document.querySelectorAll(".droitCheckbox").forEach(c => c.checked = false);
    document.querySelectorAll('input[name="reconnaissance"]').forEach(c => c.checked = false);
    document.getElementById("presenceAvocatContainer").style.display = "none";

    // üîÑ R√©initialisation du texte g√©n√©r√©
    const outputElem = document.getElementById("procOutput");
    outputElem.textContent = "";

    // üîÑ Supprime l'intervalle de mise √† jour de la GAV si actif
    if (window.gavInterval) {
        clearInterval(window.gavInterval);
        window.gavInterval = null;
    }

    // üîÑ R√©initialisation des infractions
    document.querySelectorAll(".infractionCheckbox").forEach(cb => {
        cb.checked = false;
        cb.disabled = false;
        const montantInput = cb.parentElement.querySelector(".montant-saisie");
        if (montantInput) montantInput.value = 0;
        const multiInput = cb.parentElement.querySelector(".multiplicateur-input");
        if (multiInput) multiInput.value = 1;
    });
});




    // ==================== RECONNAISSANCE DES FAITS ====================
const reconnaissanceCheckboxes = document.querySelectorAll('input[name="reconnaissance"]');

reconnaissanceCheckboxes.forEach(cb => {
    cb.addEventListener('change', () => {
        if (cb.checked) {
            // D√©coche toutes les autres checkbox du m√™me groupe
            reconnaissanceCheckboxes.forEach(other => {
                if (other !== cb) other.checked = false;
            });
        }
    });
});


    // ==================== BOUTON G√âN√âRER ====================
    document.getElementById("procGenerateBtn").addEventListener("click", async () => {

        // On s'assure que le champ APJ est rempli
        await fillAPJ(); 

        const nom = document.getElementById("procNom").value.toUpperCase();
        const prenom = document.getElementById("procPrenom").value.toUpperCase();
        const dobInput = document.getElementById("procDOB").value;
        const dob = new Date(dobInput).toLocaleDateString('fr-FR');
        const taille = document.getElementById("procTaille").value + " CM";
        const sexe = document.getElementById("procSexe").value;
        // R√©cup√®re le num√©ro, supprime tout sauf chiffres et reformate
        let telRaw = document.getElementById("procTel").value.replace(/\D/g, '').substr(0, 10);
        const tel = telRaw.replace(/(\d{2})(?=\d)/g, '$1.'); // Formate 07.10.52.13.99

        const apj = document.getElementById("procAPJ").value;
        const observation = document.getElementById("procObservation").value;
        const rapport = document.getElementById("procRapport").value;

        // Infractions s√©lectionn√©es
        const infractions = Array.from(document.querySelectorAll(".infractionCheckbox:checked"));
        let totalAmende = 0, totalTemps = 0, infractionsText = "";
        infractions.forEach(cb => {

    let amende = parseInt(cb.dataset.amende) || 0;
    const temps = parseInt(cb.dataset.temps) || 0;

    if (cb.dataset.multiplicateur === "true") {
    const multiplicateurInput = cb.parentElement.querySelector(".multiplicateur-input");
    const multiplicateur = parseInt(multiplicateurInput.value) || 1;
    amende = amende * multiplicateur;
} else if (cb.dataset.montantLibre === "true") {
    const montantInput = cb.parentElement.querySelector(".montant-saisie");
    const montant = parseInt(montantInput.value) || 0;
    amende = montant;
}


    totalAmende += amende;
    totalTemps += temps;
    infractionsText += `‚Ä¢ ${cb.value}\n`;
});


        // Droits exerc√©s
        const droitsCoches = Array.from(document.querySelectorAll(".droitCheckbox:checked")).map(c => c.value);
        let droitsText = droitsCoches.join(", ") || "N√©ant";
        let presenceAvocatText = "Non";
        if (droitsCoches.includes("Avocat")) {
            const presenceOui = document.getElementById("presenceOui");
            presenceAvocatText = presenceOui.checked ? "Oui" : "Non";
        }
        const presenceLine = droitsCoches.includes("Avocat") ? `\nPr√©sence avocat : ${presenceAvocatText}` : "";

        const fouille = document.getElementById("fouilleObservation")?.value.trim() || "N√©ant";
        const outputElem = document.getElementById("procOutput");
        if (window.gavInterval) clearInterval(window.gavInterval);


        
// V√©rifie que la reconnaissance des faits est coch√©e
const reconnaissanceInput = document.querySelector('input[name="reconnaissance"]:checked');
if (!reconnaissanceInput) {
    showToast("Veuillez cocher la reconnaissance des faits avant de g√©n√©rer le rapport.", 2000, "#ef4444");
    return; // bloque la g√©n√©ration
}

// R√©cup√®re la valeur pour le rapport
const ouiNon = reconnaissanceInput.value === "oui" ? "oui" : "non";
const reconnaissanceFaits = infractions.length > 1 
    ? `Reconnaissance des faits : ${ouiNon}` 
    : `Reconnaissance du fait : ${ouiNon}`;




        function updateGAVText() {
            const now = new Date();
            const debut = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
            const finDate = new Date(now.getTime() + totalTemps * 60000);
            const fin = finDate.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});

            if (modeGeneration === "creation") {
                outputElem.textContent = `[ADDITIF TRAITEMENT DES ANT√âC√âDENTS JUDICIAIRES]
Nom : ${nom || 'N√©ant'}
Pr√©nom : ${prenom || 'N√©ant'}
Date de naissance : ${dob || 'N√©ant'}
Taille : ${taille || 'N√©ant'}
Sexe : ${sexe || 'N√©ant'}
R√©sultat de la fouille : ${fouille}
Liste des infractions retenues :
${infractionsText}
Amende : ${totalAmende}‚Ç¨
Heure de d√©but de garde a vue et application des contraintes : ${debut}
Heure de fin de garde a vue en sortie de cellule : ${fin}
Temps de la mise en cellule : ${totalTemps} minutes
Num√©ro de t√©l√©phone : ${tel || 'N√©ant'}
DROIT(S) EXERC√âS : ${droitsText}${presenceLine}
${reconnaissanceFaits}
APJA en charge de la proc√©dure : ${apj || 'N√©ant'}
Observation : ${observation || 'N√©ant'}
Rapport succinct :
${rapport || 'N√©ant'}`;
            } else if (modeGeneration === "ajout") {
                outputElem.textContent = `R√©sultat de la fouille : ${fouille}
Liste des infractions retenues :
${infractionsText}
Amende : ${totalAmende}‚Ç¨
Heure de d√©but de garde a vue et application des contraintes : ${debut}
Heure de fin de garde a vue en sortie de cellule : ${fin}
Temps en cellule : ${totalTemps} minutes
DROIT(S) EXERC√âS : ${droitsText}${presenceLine}
${reconnaissanceFaits}
APJA en charge de la proc√©dure : ${apj || 'N√©ant'}
Observation : ${observation || 'N√©ant'}
Rapport succinct :
${rapport || 'N√©ant'}`;
            }
        }

        updateGAVText();
        window.gavInterval = setInterval(updateGAVText, 1000);
    });
});


// ==================== COPIE POUR DISCORD ====================
document.getElementById("copyDiscordBtn").addEventListener("click", () => {
    const nom = document.getElementById("procNom").value.toUpperCase() || "N√©ant";
    const prenom = document.getElementById("procPrenom").value.toUpperCase() || "N√©ant";
    const dobInput = document.getElementById("procDOB").value;
    const dob = dobInput ? new Date(dobInput).toLocaleDateString('fr-FR') : "N√©ant";
    const taille = document.getElementById("procTaille").value ? document.getElementById("procTaille").value + " CM" : "N√©ant";
    const sexe = document.getElementById("procSexe").value || "N√©ant";
    const tel = document.getElementById("procTel").value || "N√©ant";
    const apj = document.getElementById("procAPJ").value || "N√©ant";
    const observation = document.getElementById("procObservation").value || "N√©ant";
    const rapport = document.getElementById("procRapport").value || "N√©ant";
    const fouille = document.getElementById("fouilleObservation")?.value.trim() || "N√©ant";

    // Infractions
    const infractions = Array.from(document.querySelectorAll(".infractionCheckbox:checked"));
    let totalAmende = 0, totalTemps = 0, infractionsText = "";
    infractions.forEach(cb => {
        let amende = parseInt(cb.dataset.amende) || 0;
        const temps = parseInt(cb.dataset.temps) || 0;

        if (cb.dataset.multiplicateur === "true") {
            const multi = parseInt(cb.parentElement.querySelector(".multiplicateur-input")?.value) || 1;
            amende *= multi;
        } else if (cb.dataset.montantLibre === "true") {
            amende = parseInt(cb.parentElement.querySelector(".montant-saisie")?.value) || 0;
        }

        totalAmende += amende;
        totalTemps += temps;
        infractionsText += `‚Ä¢ ${cb.value}\n`;
    });

    // Droits
    const droitsCoches = Array.from(document.querySelectorAll(".droitCheckbox:checked")).map(c => c.value);
    let droitsText = droitsCoches.join(", ") || "N√©ant";
    let presenceAvocatText = "Non";
    if (droitsCoches.includes("Avocat")) {
        presenceAvocatText = document.getElementById("presenceOui")?.checked ? "Oui" : "Non";
    }
    const presenceLine = droitsCoches.includes("Avocat") ? `\n**Pr√©sence avocat :** ${presenceAvocatText}` : "";

    // Reconnaissance
    const rec = document.querySelector('input[name="reconnaissance"]:checked');
    let reconnaissanceFaits = "Non renseign√©";
    if (rec) {
        const ouiNon = rec.value === "oui" ? "oui" : "non";
        reconnaissanceFaits = infractions.length > 1 ? `Reconnaissance des faits : ${ouiNon}` : `Reconnaissance du fait : ${ouiNon}`;
    }

    // Horaires
    const now = new Date();
    const debut = now.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});
    const finDate = new Date(now.getTime() + totalTemps * 60000);
    const fin = finDate.toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'});

    // Texte Discord selon mode
    const discordText = modeGeneration === "creation"
        ? `**[ADDITIF TRAITEMENT DES ANT√âC√âDENTS JUDICIAIRES]**
**Nom :** ${nom}
**Pr√©nom :** ${prenom}
**Date de naissance :** ${dob}
**Taille :** ${taille}
**Sexe :** ${sexe}
**R√©sultat de la fouille :** ${fouille}
**Liste des infractions :**
${infractionsText}
**Amende :** ${totalAmende}‚Ç¨
**Heure de d√©but :** ${debut}
**Heure de fin :** ${fin}
**Temps en cellule :** ${totalTemps} minutes
**DROIT(S) EXERC√âS :** ${droitsText}${presenceLine}
${reconnaissanceFaits}
**APJA :** ${apj}
**Observation :** ${observation}
**Rapport :**
${rapport}`
        : `**R√©sultat de la fouille :** ${fouille}
**Liste des infractions :**
${infractionsText}
**Amende :** ${totalAmende}‚Ç¨
**Heure de d√©but :** ${debut}
**Heure de fin :** ${fin}
**Temps en cellule :** ${totalTemps} minutes
**DROIT(S) EXERC√âS :** ${droitsText}${presenceLine}
**${reconnaissanceFaits}**
**APJA :** ${apj}
**Observation :** ${observation}
**Rapport :**
${rapport}`;

    navigator.clipboard.writeText(discordText)
        .then(() => showToast("Rapport format Discord copi√© !", 2000, "#10b981"))
        .catch(err => showToast("Impossible de copier : " + err, 3000, "#ef4444"));
});


// ==================== TOAST ====================
function showToast(message, duration = 2000, color = "#10b981") {
    const toast = document.getElementById("copyToast");
    toast.textContent = message;
    toast.style.background = color;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), duration);
}
</script>
</body>
</html>
