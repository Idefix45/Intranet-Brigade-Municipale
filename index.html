<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Intranet Brigade Municipale</title>
<style>
    
body{
    
    font-family:Segoe UI, sans-serif;
    background:#1c2b49;
    color:white;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    height:100vh;
}
 
.container{
    width:450px;
    background:#111827;
    padding:30px;
    border-radius:15px;
    display:flex;
    flex-direction:column;
    gap:15px;
}
h2{text-align:center;}
input,button,select{
    padding:12px;
    border-radius:8px;
    border:none;
    font-size:14px;
}
button{
    background:#2563eb;
    color:white;
    cursor:pointer;
    transition:0.2s;
}
button:hover{background:#1e40af;}
a{
    color:#2563eb;
    cursor:pointer;
    text-decoration:underline;
    text-align:center;
    margin-top:10px;
}
#mdt{
    display:none;
    flex:1;
    width:100%;
    height:100vh;
    flex-direction:row;
}
.sidebar{
    width:260px;
    background:#020617;
    padding:20px;
    display:flex;
    flex-direction:column;
    gap:15px;
}

#joinCSU {
    margin-top: 10px; /* espace entre le texte et le bouton */
}

#leaveCSU {
    margin-top: 10px; /* espace entre le texte et le bouton */
}

.main{
    flex:1;
    display:flex;
    padding:30px;
    gap:30px;
    overflow-y:auto;
}
.card{
    background:#111827;
    padding:20px;
    border-radius:15px;
}
.vacations{
    flex:2;
    display:flex;
    flex-direction:column;
    gap:20px;
}
.waiting{
    flex:1;
}
.agent{
    background:#1f2937;
    padding:6px;
    border-radius:6px;
    margin-top:5px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
.csu{
    background:#f59e0b;
    padding:10px;
    border-radius:8px;
    margin-bottom:10px;
}
.csu-button{
    background:#dc2626;
    margin-left:5px;
    padding:4px 6px;
    border-radius:5px;
}
.agent.dragging{opacity:0.5;}
</style>
</head>
<body>
<h1 style="
        text-align: center; 
        font-size: 32px; 
        color: #2563eb; 
        margin-bottom: 20px;
        margin-top: 40px;">
        Intranet Brigade Municipale
    </h1>


    <button id="btnAdmin" 
        style="
            display:none; 
            position: fixed; 
            top: 15px; 
            right: 15px; 
            z-index: 1000; 
            padding: 10px 15px;
            border-radius: 8px;
            background: #2563eb;
            color: white;
            cursor: pointer;
        ">
    ‚öôÔ∏è Admin
    </button>



<!-- INSCRIPTION -->
<div class="container" id="pageInscription">
    <h2>Inscription</h2>
    <input id="rPrenom" placeholder="Pr√©nom">
    <input id="rNom" placeholder="Nom">
    <input id="rGrade" placeholder="Grade">
    <input id="rArrivalDate" type="date" placeholder="Date d'arriv√©e" />
    <input id="rPass" type="password" placeholder="Mot de passe">
    <button id="btnRegister">Cr√©er compte</button>
    <a id="linkToLogin">D√©j√† un compte ? Connexion</a>
</div>

<!-- LOGIN -->
<div class="container" id="pageLogin" style="display:none;">
    <h2>Connexion</h2>
    <input id="lPrenom" placeholder="Pr√©nom">
    <input id="lNom" placeholder="Nom">
    <input id="lPass" type="password" placeholder="Mot de passe">
    <button id="btnLogin">Connexion</button>
    <a id="linkToRegister">Pas de compte ? Inscription</a>
</div>


<!-- HOME APR√àS CONNEXION -->
<div class="container" id="adminHome" style="display:none; flex-direction:column; align-items:center;">
    <h2>Admin - Choisissez une option :</h2>
    <div style="display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; justify-content:center; width:100%;">
        <div class="card" id="btnManageAccounts" style="cursor:pointer; flex:1; min-width:150px; text-align:center;">
            <h3>Comptes</h3>
            <p>G√©rer les comptes en attente</p>
        </div>
        <div class="card" id="btnTotalHours" style="cursor:pointer; flex:1; min-width:150px; text-align:center;">
            <h3>Heures Totales</h3>
            <p>Voir les heures des agents</p>
        </div>
        <!-- TROISI√àME CARTE -->
        <div class="card" id="btnAllAgents" style="cursor:pointer; flex:1; min-width:150px; text-align:center;">
            <h3>Tous les agents</h3>
            <p>Voir et modifier sanctions / formations</p>
        </div>
    </div>
    <button id="btnBackToHome" style="margin-top:20px;">‚¨ÖÔ∏è Retour</button>
</div>

<!-- HOME APR√àS CONNEXION (Agent) -->
<div class="container" id="homePage" style="display:none; flex-direction:column; align-items:center;">
    <h2>Bienvenue</h2>
    <div style="display:flex; gap:20px; margin-top:20px; flex-wrap:wrap; justify-content:center; width:100%;">
        <div class="card" id="btnMDT" style="cursor:pointer; flex:1; min-width:150px; text-align:center;">
            <h3>MDT / Dispatch</h3>
            <p>Voir et g√©rer les vacations</p>
        </div>
        <div class="card" id="btnPointeuse" style="cursor:pointer; flex:1; min-width:150px; text-align:center;">
            <h3>Pointeuse</h3>
            <p>G√©rer vos heures de service</p>
        </div>
    </div>
</div>


<!-- POINTEUSE -->
<div class="container" id="pagePointeuse" style="display:none; flex-direction:column; align-items:center;">
    <h2>Pointeuse</h2>
    <div id="pointeuseInfo" style="margin-bottom:20px; font-weight:bold;"></div>
    <button id="btnStartShift">üü¢ D√©but de service</button>
    <button id="btnEndShift">üî¥ Fin de service</button>
    <div style="margin-top:20px; width:100%;">
        <h3>Historique</h3>
        <div id="pointeuseHistory" style="display:flex; flex-direction:column; gap:5px;"></div>
    </div>
    <button id="btnBackHomeFromPointeuse">‚¨ÖÔ∏è Retour Accueil</button>
</div>


<!-- MDT -->
<div id="mdt">
    <div class="sidebar">
        <h3>Agent</h3>
        <div id="agentInfo"></div>
        <button id="btnAttente">üü¢ Attente</button>
        <button id="btnQuitterAttente">üî¥ Quitter</button>
        <div class="csu">
            <h4>CSU</h4>
            <div style="display:flex; align-items:center; gap:20px;"></div>
            <div id="csuInfo">Aucun agent CSU</div>
            <button id="joinCSU">Rejoindre CSU</button>
            <button id="leaveCSU" style="display:none;">Quitter CSU</button>
        </div>
        <button id="btnBackHomeFromMDT">‚¨ÖÔ∏è Accueil</button>
    </div>

    <div class="main">
        <div class="vacations" id="vacationsDiv"></div>
        <div class="waiting card">
            <h3>Attente d'affectation</h3>
            <div id="waitingList"></div>
        </div>
    </div>
</div>



<!-- PAGE ADMIN -->
<div class="container" id="pageAdmin" style="display:none;">
    <h2>Admin - Validation des comptes</h2>
    <div id="adminList" style="display:flex; flex-direction:column; gap:10px;"></div>
    <button id="btnBackAdmin">‚¨ÖÔ∏è Retour</button>
</div>

<!-- PAGE ADMIN - HEURES TOTALES -->
<div class="container" id="pageTotalHours" style="display:none;">
    <h2>Admin - Heures totales des agents</h2>

    <div id="totalHoursList" 
         style="display:flex; flex-direction:column; gap:10px;">
    </div>
    <button id="btnResetHours" style="margin-top: 20px; background:#dc2626; color:white; padding:10px; border-radius:8px; cursor:pointer;">
    üîÑ Reset heures
</button>
    <button id="btnBackAdminHome">‚¨ÖÔ∏è Retour</button>
</div>

<!-- PAGE ADMIN - TOUS LES AGENTS -->
<div class="container" id="pageAllAgents" style="display:none; flex-direction:column; align-items:center;">
    <h2 style="margin-top:100px;">Votre effectifs</h2>
    <div id="allAgentsList" style="display:flex; flex-direction:column; gap:10px;"></div>
    <button id="btnBackAllAgents">‚¨ÖÔ∏è Retour</button>
</div>

<!-- PAGE ADMIN - D√âTAIL AGENT -->
<div class="container" id="pageAgentDetail" style="display:none; flex-direction:column; align-items:center;">
    <h2>Dossier Agent</h2>

    <div id="agentDetailContent" style="width:100%; display:flex; flex-direction:column; gap:10px;"></div>

    <button id="btnBackAgentDetail">‚¨ÖÔ∏è Retour</button>
</div>




<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, collection, onSnapshot, getDocs }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDX486w4yzHXDOgJ66Q0VjMRXMGtBFNdIY",
  authDomain: "mydispatch-3a386.firebaseapp.com",
  projectId: "mydispatch-3a386",
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ELEMENTS
const pageInscription=document.getElementById("pageInscription");
const pageLogin=document.getElementById("pageLogin");
const pageMDT=document.getElementById("mdt");
const agentInfo=document.getElementById("agentInfo");
const waitingList=document.getElementById("waitingList");
const vacationsDiv=document.getElementById("vacationsDiv");
const csuInfo=document.getElementById("csuInfo");
const joinCSU=document.getElementById("joinCSU");
const leaveCSU=document.getElementById("leaveCSU");
const rPrenom=document.getElementById("rPrenom");
const rNom=document.getElementById("rNom");
const rGrade=document.getElementById("rGrade");
const rPass=document.getElementById("rPass");
const lPrenom=document.getElementById("lPrenom");
const lNom=document.getElementById("lNom");
const lPass=document.getElementById("lPass");
const btnRegister=document.getElementById("btnRegister");
const btnLogin=document.getElementById("btnLogin");
const linkToLogin=document.getElementById("linkToLogin");
const linkToRegister=document.getElementById("linkToRegister");
const btnAttente=document.getElementById("btnAttente");
const btnQuitterAttente=document.getElementById("btnQuitterAttente");
const homePage = document.getElementById("homePage");
const pageTotalHours = document.getElementById("pageTotalHours");
const totalHoursList = document.getElementById("totalHoursList");
const btnBackAdminHome = document.getElementById("btnBackAdminHome");


const btnAdmin = document.getElementById("btnAdmin");
const adminHome = document.getElementById("adminHome");
const pageAdmin = document.getElementById("pageAdmin");
const adminList = document.getElementById("adminList");
const btnBackAdmin = document.getElementById("btnBackAdmin");
const pageAllAgents = document.getElementById("pageAllAgents");
const allAgentsList = document.getElementById("allAgentsList");
const pageAgentDetail = document.getElementById("pageAgentDetail");
const agentDetailContent = document.getElementById("agentDetailContent");
const btnBackAgentDetail = document.getElementById("btnBackAgentDetail");


const gradeOrder = [
    "Directeur Principal",
    "Directeur Adjoint",
    "Chef de Police",
    "Chef de Service Classe Exceptionnel",
    "Chef de Service Classe Sup√©rieur",
    "Chef de Service Classe Normal",
    "Chef de Service Classe Stagiaire",
    "Brigadier Chef Principal",
    "Brigadier Chef",
    "Brigadier",
    "Gardien Principal",
    "Gardien Titulaire",
    "Gardien Stagiaire"
];

function sortByGrade(a, b) {
    const indexA = gradeOrder.indexOf(a.grade);
    const indexB = gradeOrder.indexOf(b.grade);

    // Si le grade n'est pas dans la liste, le placer √† la fin
    const valA = indexA === -1 ? gradeOrder.length : indexA;
    const valB = indexB === -1 ? gradeOrder.length : indexB;

    return valA - valB;
}


// Ouvrir MDT depuis la page d'accueil
document.getElementById("btnMDT").onclick = async () => {
    await openMDT();
};


let currentUser=null;
let isCSU=false;

// ADMINS AUTORIS√âS
const admins = ["Robin.Perrick", "Tommy.Angello", "de.de", "Mick.Ross"]; // <-- deux √©l√©ments


// NAVIGATION
function showPage(page){

    pageInscription.style.display="none";
    pageLogin.style.display="none";
    pageMDT.style.display="none";
    pageAdmin.style.display="none";
    homePage.style.display="none";
    pagePointeuse.style.display="none";
    adminHome.style.display="none";
    pageTotalHours.style.display="none";
    pageAllAgents.style.display="none";
    pageAgentDetail.style.display="none";



    page.style.display="flex";

    const header = document.querySelector("h1");
    if(page === pageMDT){
        header.style.display = "none";
    } else {
        header.style.display = "block";
    }
}

// üî• AJOUTE √áA
linkToLogin.onclick = () => showPage(pageLogin);
linkToRegister.onclick = () => showPage(pageInscription);



// INSCRIPTION
btnRegister.onclick=async()=>{
    const prenom=rPrenom.value.trim();
    const nom=rNom.value.trim();
    const grade=rGrade.value.trim();
    const arrivalDate=rArrivalDate.value; // <-- R√©cup√®re la date
    const pass=rPass.value.trim();
    if(!prenom || !nom || !grade || !arrivalDate || !pass) return alert("Veuillez remplir tout les champs !");
    const id=prenom+"."+nom;
    const docRef=doc(db,"agents",id);
    const snap=await getDoc(docRef);
    if(snap.exists()) return alert("Ce compte existe d√©j√†");
    await setDoc(docRef,{prenom,nom,grade,pass,validated:false,inWaiting:false,inVacation:null});
    await setDoc(docRef,{
    prenom,
    nom,
    grade,
    pass,
    validated:false,
    inWaiting:false,
    inVacation:null,
    pointeuse: [],   // <-- ajout automatique
    arrivalDate: arrivalDate, // <-- Stocke la date
    sanctions: "",             // initialisation vide
    formations: ""             // initialisation vide
});

    alert("Compte cr√©√© ! En attente de validation.");
    rPrenom.value=rNom.value=rGrade.value=rPass.value="";
    showPage(pageLogin);
}

// LOGIN
btnLogin.onclick = async () => {
    const prenom = lPrenom.value.trim();
    const nom = lNom.value.trim();
    const pass = lPass.value.trim();
    if(!prenom || !nom || !pass) return alert("Veuillez remplir tout les champs !");
    const id = prenom + "." + nom;
    const docRef = doc(db,"agents",id);
    const snap = await getDoc(docRef);
    if(!snap.exists()) return alert("Vous n'avez pas de compte");
    const data = snap.data();
    if(data.pass !== pass) return alert("Une de vos informations est incorect");
    if(!data.validated) return alert("Votre compte n'a pas encore √©t√© valid√© !");
    currentUser = {...data, id};
    agentInfo.innerText = `${currentUser.prenom} ${currentUser.nom} - ${currentUser.grade}`;
    showPage(homePage);
    checkAdmin();
    await initDispatch();
    await initVacations();
    initCSU();
    loadWaiting();
    loadVacations();
};

// V√©rifie si currentUser est admin
function checkAdmin(){
    // Le bouton n‚Äôappara√Æt que si on est sur la homePage ET si l'utilisateur est admin
    btnAdmin.style.display = (currentUser && admins.includes(currentUser.id) && homePage.style.display !== "none") ? "block" : "none";
}


// Charger comptes non valid√©s
async function loadAdminAccounts(){
    adminList.innerHTML="";
    const snap = await getDocs(collection(db,"agents"));
    let count = 0;

    snap.forEach(docu=>{
        const data = docu.data();

        if(!data.validated){

            const div = document.createElement("div");
            div.className="agent";
            div.style.display="flex";
            div.style.justifyContent="space-between";
            div.style.alignItems="center";
            div.style.background="#1f2937";
            div.style.padding="10px";
            div.style.borderRadius="8px";

            const span = document.createElement("span");
            span.innerText=`${data.prenom} ${data.nom} - ${data.grade}`;
            div.appendChild(span);

            const actions = document.createElement("div");

            // ‚úÖ BOUTON VALIDER
            const btnValider = document.createElement("button");
            btnValider.textContent="‚úÖ Valider";
            btnValider.style.background="#16a34a";
            btnValider.onclick=async()=>{
                await updateDoc(doc(db,"agents",docu.id),{validated:true});
                loadAdminAccounts();
            };

            // ‚ùå BOUTON REFUSER
            const btnRefuser = document.createElement("button");
            btnRefuser.textContent="‚ùå Refuser";
            btnRefuser.style.background="#dc2626";
            btnRefuser.style.marginLeft="5px";
            btnRefuser.onclick=async()=>{
                if(confirm("Refuser ce compte ?")){
                    await deleteDoc(doc(db,"agents",docu.id));
                    loadAdminAccounts();
                }
            };

            actions.appendChild(btnValider);
            actions.appendChild(btnRefuser);
            div.appendChild(actions);

            adminList.appendChild(div);
            count++;
        }
    });

    if(count===0){
        const span = document.createElement("span");
        span.innerText="Votre compte n'est pas en attente";
        adminList.appendChild(span);
    }
}


// INIT DISPATCH & VACATIONS
async function initDispatch(){
    const ref=doc(db,"dispatch","waiting");
    const snap=await getDoc(ref);
    if(!snap.exists()) await setDoc(ref,{agents:[]});
}
async function initVacations(){
    const vacCol=collection(db,"vacations");
    const snap=await getDocs(vacCol);
    if(snap.empty){
        const defaultVacations=[
            {nom:"Victor 01",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"Victor 02",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"Victor 03",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"GSI Alpha",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"GSI Bravo",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"BMU Alpha",statut:"Disponible",agents:[],vehicules:["Aucun"]},
            {nom:"BMU Bravo",statut:"Disponible",agents:[],vehicules:["Aucun"]},
        ];
        for(let v of defaultVacations){
            const id=v.nom.replace(/\s+/g,"_");
            await setDoc(doc(db,"vacations",id),v);
        }
    }
}

// ATTENTE
btnAttente.onclick=async()=>{
    if(!currentUser || currentUser.inVacation) return alert("Vous √™tes d√©j√† dans une vacation !");
    const ref=doc(db,"dispatch","waiting");
    await updateDoc(ref,{agents:arrayUnion(currentUser)});
    await updateDoc(doc(db,"agents",currentUser.id),{inWaiting:true});
    currentUser.inWaiting=true;
}
btnQuitterAttente.onclick=async()=>{
    if(!currentUser) return;
    const ref=doc(db,"dispatch","waiting");
    await updateDoc(ref,{agents:arrayRemove(currentUser)});
    await updateDoc(doc(db,"agents",currentUser.id),{inWaiting:false});
    currentUser.inWaiting=false;
}

// CSU
function initCSU(){
    const csuRef=doc(db,"csu","current");
    onSnapshot(csuRef,snap=>{
        const data = snap.data()||{};
        if(data.agent){
            csuInfo.innerText=`${data.agent.prenom} ${data.agent.nom} ${data.agent.grade}`;
            isCSU=(currentUser.id===data.agent.id);
            joinCSU.style.display=isCSU? "none" : "none";
            leaveCSU.style.display=isCSU? "block" : "none";
        } else {
            csuInfo.innerText="Aucun agent CSU";
            isCSU=false;
            joinCSU.style.display="block";
            leaveCSU.style.display="none";
        }
        loadVacations();
        loadWaiting();
    });
}
joinCSU.onclick=async()=>{
    const csuRef=doc(db,"csu","current");
    const snap=await getDoc(csuRef);
    if(snap.data()?.agent) return alert("Un agent est d√©j√† CSU !");
    await setDoc(csuRef,{agent:currentUser});
}
leaveCSU.onclick=async()=>{
    const csuRef=doc(db,"csu","current");
    await setDoc(csuRef,{agent:null});
}

// LOAD
function loadWaiting() {
    const waitingRef = doc(db, "dispatch", "waiting");

    // --------------------------
    // DROP dans waiting (depuis une vacation)
    // --------------------------
    waitingList.addEventListener("dragover", e => e.preventDefault());
    waitingList.addEventListener("drop", async e => {
        e.preventDefault();

        let data;
        try {
            data = JSON.parse(e.dataTransfer.getData("text/plain"));
        } catch {
            return;
        }

        const agentObj = data.agent;

        if (data.from === "waiting") return; // d√©j√† en waiting

        // 1Ô∏è‚É£ Ajouter l'ID de l'agent √† waiting
        const snapWaiting = await getDoc(waitingRef);
        const agentsWaiting = snapWaiting.data()?.agents || [];
        await updateDoc(waitingRef, { agents: [...agentsWaiting, agentObj] });

        // 2Ô∏è‚É£ Mettre √† jour l'agent
        await updateDoc(doc(db, "agents", agentObj.id), { inVacation: null, inWaiting: true });

        // 3Ô∏è‚É£ Retirer de la vacation si besoin
        if (data.from) {
            const fromRef = doc(db, "vacations", data.from);
            const snapFrom = await getDoc(fromRef);
            if (snapFrom.exists()) {
                const agentsFrom = snapFrom.data()?.agents || [];
                const newAgentsFrom = agentsFrom.filter(a => a.id !== agentObj.id);
                await updateDoc(fromRef, { agents: newAgentsFrom });
            }
        }
    });

    // --------------------------
    // √âcoute des changements sur la waiting list
    // --------------------------
    onSnapshot(waitingRef, snap => {
        waitingList.innerHTML = "";
        const agentsInWaiting = snap.data()?.agents || [];

        agentsInWaiting.forEach(a => {
            const div = document.createElement("div");
            div.className = "agent";
            div.innerText = `${a.prenom} ${a.nom} - ${a.grade}`;

            // On affiche les boutons seulement si isCSU
            if (isCSU) {
                // Bouton retirer
                const btn = document.createElement("button");
                btn.textContent = "‚ùå Retirer";
                btn.className = "csu-button";
                btn.onclick = async () => {
                    // Retirer l'agent par ID
                    const snap = await getDoc(waitingRef);
                    const agents = snap.data()?.agents || [];
                    const newAgents = agents.filter(agent => agent.id !== a.id);
                    await updateDoc(waitingRef, { agents: newAgents });

                    await updateDoc(doc(db, "agents", a.id), { inWaiting: false });
                };
                div.appendChild(btn);

                // Drag depuis waiting
                div.draggable = true;
                div.addEventListener("dragstart", e => {
                    e.dataTransfer.setData(
                        "text/plain",
                        JSON.stringify({ agent: a, from: "waiting" })
                    );
                    div.classList.add("dragging");
                });
                div.addEventListener("dragend", () => div.classList.remove("dragging"));
            }

            waitingList.appendChild(div);
        });
    });
}

function colorStatut(select){
    if(select.value === "Disponible"){
        select.style.backgroundColor = "#2ecc71"; // vert
        select.style.color = "white";
    }
    else if(select.value === "En intervention"){
        select.style.backgroundColor = "#f39c12"; // orange
        select.style.color = "white";
    }
    else if(select.value === "Indisponible"){
        select.style.backgroundColor = "#e74c3c"; // rouge
        select.style.color = "white";
    }
    
}


function loadVacations(){
    const vacCol=collection(db,"vacations");
    onSnapshot(vacCol,snap=>{
        vacationsDiv.innerHTML="";
        // Ordre voulu : Victor -> GSI -> BMU
        const docs = snap.docs.sort((a, b) => {
    const order = [
        "Victor 01", "Victor 02", "Victor 03",
        "GSI Alpha", "GSI Bravo",
        "BMU Alpha", "BMU Bravo"
    ];

    const aData = a.data();
    const bData = b.data();

    const aHasAgents = (aData.agents || []).length > 0 ? 0 : 1;
    const bHasAgents = (bData.agents || []).length > 0 ? 0 : 1;

    // 1Ô∏è‚É£ Priorit√© aux vacations avec agents
    if(aHasAgents !== bHasAgents) return aHasAgents - bHasAgents;

    // 2Ô∏è‚É£ Priorit√© selon l'ordre fixe
    const aIndex = order.indexOf(aData.nom);
    const bIndex = order.indexOf(bData.nom);

    if(aIndex === -1 && bIndex === -1) return 0;
    if(aIndex === -1) return 1;
    if(bIndex === -1) return -1;

    return aIndex - bIndex;
});


        docs.forEach(docu=>{
            const v = docu.data();
            const div = document.createElement("div");
            div.className="card";
            const title = document.createElement("h3");
            title.textContent=v.nom;
            div.appendChild(title);
            // STATUT
            const selectStat = document.createElement("select");
            ["Disponible","En intervention","Indisponible"].forEach(s=>{
                const opt=document.createElement("option");
                opt.value=s; opt.textContent=s;
                if(v.statut===s) opt.selected=true;
                selectStat.appendChild(opt);
            });
            selectStat.disabled=!(isCSU || (v.agents||[]).some(a=>a.id===currentUser.id));
            colorStatut(selectStat);
            selectStat.onchange=async()=>{
            colorStatut(selectStat);
            await updateDoc(doc(db,"vacations",docu.id),{statut:selectStat.value});
            };

            div.appendChild(selectStat);

            // VEHICULE
let vehicles = ["Aucun","Enyoq","Cinq C SW","M√©gane","Kangoo","Tucson","Zo√©"]; // liste compl√®te par d√©faut

// ‚ö° appliquer r√®gles selon type de vacation
if(v.nom.startsWith("Victor")) {
    vehicles = vehicles.filter(vh => vh !== "Cinq C SW"); // tout sauf Cinq C SW
} else if(v.nom.startsWith("GSI")) {
    vehicles = ["Aucun","M√©gane","Cinq C SW"]; // seulement ces deux
}

const selVeh = document.createElement("select");
vehicles.forEach(vh => {
    const opt = document.createElement("option");
    opt.value = vh;
    opt.textContent = vh;
    if((v.vehicules||["Aucun"]).includes(vh)) opt.selected = true;
    selVeh.appendChild(opt);
});

selVeh.disabled = !(isCSU || (v.agents||[]).some(a => a.id === currentUser.id));

selVeh.onchange = async () => {
    await updateDoc(doc(db,"vacations",docu.id), {vehicules:[selVeh.value]});
};

div.appendChild(selVeh);


            // BOUTONS REJOINDRE / QUITTER
            const joinBtn=document.createElement("button");
            joinBtn.textContent="Rejoindre"; joinBtn.onclick=()=>rejoindreVacation(docu.id);
            const leaveBtn=document.createElement("button");
            leaveBtn.textContent="Quitter"; leaveBtn.onclick=()=>quitterVacation(docu.id);
            div.appendChild(joinBtn); div.appendChild(leaveBtn);

            // AGENTS
            const agentDiv=document.createElement("div");
            agentDiv.className="agents-container";
            // Trie les agents de la vacation par grade
            const sortedAgents = (v.agents || []).sort(sortByGrade);
            sortedAgents.forEach(a => {
                const ag = document.createElement("div");
                ag.className = "agent";
                ag.innerText = `${a.prenom} ${a.nom} - ${a.grade}`;
                ag.draggable = isCSU;
    
                if (isCSU) {
                    const btn = document.createElement("button");
                    btn.textContent = "‚ùå Retirer";
                    btn.className = "csu-button";
                    btn.onclick = async () => {
                        await updateDoc(doc(db,"vacations",docu.id), { agents: arrayRemove(a) });
                        await updateDoc(doc(db,"agents",a.id), { inVacation: null });
                    };
                    ag.appendChild(btn);

                    // Drag & drop
                    ag.addEventListener("dragstart", e => {
                        e.dataTransfer.setData("text/plain", JSON.stringify({ agent: a, from: docu.id }));
                        ag.classList.add("dragging");
                    });
                    ag.addEventListener("dragend", () => ag.classList.remove("dragging"));
                }

                agentDiv.appendChild(ag);
        });

            div.addEventListener("dragover", e => e.preventDefault()); // obligatoire pour drop
div.addEventListener("drop", async e => {
    e.preventDefault(); 
    if(!isCSU) return;

    const data = JSON.parse(e.dataTransfer.getData("text/plain"));
    const agentObj = data.agent;
    const toRef = doc(db, "vacations", docu.id);

    if(data.from === docu.id) return; // m√™me vacation, rien √† faire

    if(data.from === "waiting") {
    const waitingRef = doc(db, "dispatch", "waiting");
    await updateDoc(toRef, { agents: arrayUnion(agentObj.id) });
    await updateDoc(waitingRef, { agents: arrayRemove(agentObj.id) });
    await updateDoc(doc(db, "agents", agentObj.id), { inWaiting: false, inVacation: docu.id });
} else {
    const fromRef = doc(db, "vacations", data.from);
    await updateDoc(toRef, { agents: arrayUnion(agentObj) });
    await updateDoc(fromRef, { agents: arrayRemove(agentObj) });
    await updateDoc(doc(db, "agents", agentObj.id), { inVacation: docu.id });
}

});


            div.appendChild(agentDiv);
            vacationsDiv.appendChild(div);
        });
    });
}

// REJOINDRE / QUITTER VACATION
async function rejoindreVacation(id){
    if(!currentUser) return;

    // Si l'agent est d√©j√† dans une vacation
    if(currentUser.inVacation) return alert("Vous √™tes d√©j√† dans une vacation !");

    // Si l'agent est en attente, le retirer de la liste d'attente
    if(currentUser.inWaiting){
    const ref = doc(db, "dispatch", "waiting");
    
    // R√©cup√®re les agents en attente
    const snap = await getDoc(ref);
    const waitingAgents = snap.data()?.agents || [];

    // Retire uniquement l'agent avec le m√™me id
    const newWaitingAgents = waitingAgents.filter(a => a.id !== currentUser.id);

    // Met √† jour la liste
    await updateDoc(ref, { agents: newWaitingAgents });

    // Mets √† jour l'√©tat local
    await updateDoc(doc(db,"agents",currentUser.id), { inWaiting: false });
    currentUser.inWaiting = false;
}


    // Rejoindre la vacation
    await updateDoc(doc(db,"vacations",id), { agents: arrayUnion(currentUser) });
    await updateDoc(doc(db,"agents",currentUser.id), { inVacation: id });
    currentUser.inVacation = id;
} 

async function quitterVacation(id){
    if(!currentUser) return;

    const vacRef = doc(db,"vacations",id);

    // Retirer l'agent de la vacation
    await updateDoc(vacRef, { agents: arrayRemove(currentUser) });
    await updateDoc(doc(db,"agents",currentUser.id), { inVacation:null });
    currentUser.inVacation = null;

    // V√©rifie si la vacation est vide apr√®s retrait
    const snapVac = await getDoc(vacRef);
    const agentsLeft = snapVac.data().agents || [];

    if(agentsLeft.length === 0){
        // Reset v√©hicule
        const vehicules = snapVac.data().vehicules || [];
        for(let v of vehicules){
            if(v !== "Aucun"){ // si ce n'est pas d√©j√† "Aucun"
                await updateDoc(vacRef, { vehicules: ["Aucun"], statut: "Indisponible" });
            }
        }
    }
}



async function openMDT(){
    if(!currentUser) return alert("Vous devez √™tre connect√© !");

    showPage(pageMDT);        // Affiche le MDT
    checkAdmin();             // Montre le bouton admin si c'est un admin
    await initDispatch();     // Initialise dispatch si n√©cessaire
    await initVacations();    // Initialise vacations si n√©cessaire
    initCSU();                // Initialise le CSU
    loadWaiting();            // Recharge la liste d'attente
    loadVacations();          // Recharge les vacations
}

// ===== POINTEUSE =====
const pagePointeuse = document.getElementById("pagePointeuse");
const pointeuseInfo = document.getElementById("pointeuseInfo");
const pointeuseHistory = document.getElementById("pointeuseHistory");
const btnStartShift = document.getElementById("btnStartShift");
const btnEndShift = document.getElementById("btnEndShift");

// Ouvrir la pointeuse depuis l'accueil
document.getElementById("btnPointeuse").onclick = () => {
    showPage(pagePointeuse);
    loadPointeuse();
};

// Charger historique et total heures
async function loadPointeuse(){
    if(!currentUser) return;
    const docRef = doc(db,"agents",currentUser.id);
    const snap = await getDoc(docRef);
    if(!snap.exists()) return;

    const data = snap.data();
    const history = data.pointeuse || [];

    // Calcul du total
    let totalMs = 0;
    history.forEach(entry=>{
        if(entry.arrivee && entry.depart){
            totalMs += new Date(entry.depart) - new Date(entry.arrivee);
        }
    });
    const heures = Math.floor(totalMs / 1000 / 60 / 60);
    const minutes = Math.floor((totalMs / 1000 / 60) % 60);
    pointeuseInfo.innerText = `Total travaill√© : ${heures}h ${minutes}m`;

    // Historique
    pointeuseHistory.innerHTML = "";
    history.forEach(entry=>{
    const div = document.createElement("div");

    // Conversion date ISO en format lisible
    const arrivee = entry.arrivee ? new Date(entry.arrivee).toLocaleString("fr-FR", { 
        year: "numeric", month: "2-digit", day: "2-digit", 
        hour: "2-digit", minute: "2-digit" 
    }) : "-";

    const depart = entry.depart ? new Date(entry.depart).toLocaleString("fr-FR", { 
        year: "numeric", month: "2-digit", day: "2-digit", 
        hour: "2-digit", minute: "2-digit" 
    }) : "-";

    div.innerText = `Arriv√©e : ${arrivee} | D√©part : ${depart}`;
    pointeuseHistory.appendChild(div);
});


    // Boutons
    const enService = history.length && !history[history.length-1].depart;
    btnStartShift.disabled = enService;
    btnEndShift.disabled = !enService;
}

// D√©but de service
btnStartShift.onclick = async ()=>{
    if(!currentUser) return;
    const now = new Date().toISOString();
    const docRef = doc(db,"agents",currentUser.id);
    await updateDoc(docRef, { pointeuse: arrayUnion({arrivee: now, depart: null}) });
    loadPointeuse();
};

// Fin de service
btnEndShift.onclick = async ()=>{
    if(!currentUser) return;
    const docRef = doc(db,"agents",currentUser.id);
    const snap = await getDoc(docRef);
    const history = snap.data().pointeuse || [];
    if(!history.length) return alert("Aucun d√©but de service trouv√© !");
    const last = history[history.length-1];
    if(last.depart) return alert("Vous n'√™tes pas en service !");
    const newEntry = {...last, depart: new Date().toISOString()};
    history[history.length-1] = newEntry;
    await updateDoc(docRef,{pointeuse: history});
    loadPointeuse();
};


btnAdmin.onclick = () => {
    showPage(adminHome);
};

document.getElementById("btnBackToHome").onclick = () => {
    showPage(homePage);
    checkAdmin();
};

document.getElementById("btnManageAccounts").onclick = () => {
    showPage(pageAdmin);
    loadAdminAccounts();
};

btnBackAdmin.onclick = () => {
    showPage(adminHome);
};

document.getElementById("btnTotalHours").onclick = () => {
    showPage(pageTotalHours);
    loadTotalHours();
};

btnBackAdminHome.onclick = () => {
    showPage(adminHome);
};

document.getElementById("btnAllAgents").onclick = () => {
    showPage(pageAllAgents);
    loadAllAgents();
};

document.getElementById("btnBackAllAgents").onclick = () => {
    showPage(adminHome);
};

btnBackAgentDetail.onclick = () => {
    showPage(pageAllAgents);
};


async function loadTotalHours() {
    totalHoursList.innerHTML = "";

    const snap = await getDocs(collection(db, "agents"));

    snap.forEach(docu => {
        const data = docu.data();
        const history = data.pointeuse || [];

        let totalMs = 0;
        history.forEach(entry => {
            if (entry.arrivee && entry.depart) {
                totalMs += new Date(entry.depart) - new Date(entry.arrivee);
            }
        });

        const heures = Math.floor(totalMs / 1000 / 60 / 60);
        const minutes = Math.floor((totalMs / 1000 / 60) % 60);

        const div = document.createElement("div");
        div.className = "agent";
        div.style.cursor = "pointer";
        div.innerText = `${data.prenom} ${data.nom} - ${data.grade} | ${heures}h ${minutes}m`;

        // ‚ö° Ajout de l'acc√®s pointeuse admin
        div.onclick = async () => {
            // Supprime l'ancien popup si existe
            const oldPopup = document.getElementById("adminPointeusePopup");
            if (oldPopup) oldPopup.remove();

            // Cr√©ation du popup central
            const popup = document.createElement("div");
            popup.id = "adminPointeusePopup";
            popup.style.position = "fixed";
            popup.style.top = "50%";
            popup.style.left = "50%";
            popup.style.transform = "translate(-50%, -50%)";
            popup.style.width = "350px";
            popup.style.maxHeight = "400px";
            popup.style.overflowY = "auto";
            popup.style.background = "#1f2937";
            popup.style.padding = "20px";
            popup.style.borderRadius = "10px";
            popup.style.boxShadow = "0 0 15px rgba(0,0,0,0.5)";
            popup.style.zIndex = 2000;
            popup.style.color = "white";

            // Crois pour fermer
            const closeBtn = document.createElement("span");
            closeBtn.innerText = "‚úñ";
            closeBtn.style.cursor = "pointer";
            closeBtn.style.float = "right";
            closeBtn.style.fontWeight = "bold";
            closeBtn.onclick = () => popup.remove();
            popup.appendChild(closeBtn);

            // Titre
            const title = document.createElement("h4");
            title.innerText = `Pointeuse de ${data.prenom} ${data.nom}`;
            title.style.marginTop = "0";
            popup.appendChild(title);

            // Historique
            history.forEach((entry, index) => {
                const arrivee = entry.arrivee ? new Date(entry.arrivee).toLocaleString("fr-FR", {
                    year: "numeric", month: "2-digit", day: "2-digit",
                    hour: "2-digit", minute: "2-digit"
                }) : "-";
                const depart = entry.depart ? new Date(entry.depart).toLocaleString("fr-FR", {
                    year: "numeric", month: "2-digit", day: "2-digit",
                    hour: "2-digit", minute: "2-digit"
                }) : "-";

                const entryDiv = document.createElement("div");
                entryDiv.style.display = "flex";
                entryDiv.style.justifyContent = "space-between";
                entryDiv.style.alignItems = "center";
                entryDiv.style.marginTop = "10px";
                entryDiv.innerText = `Arriv√©e : ${arrivee} | D√©part : ${depart}`;

                // Si le service est en cours, ajouter bouton pour le terminer
                if (!entry.depart) {
                    const stopBtn = document.createElement("button");
                    stopBtn.textContent = "üî¥ Terminer le service";
                    stopBtn.style.marginLeft = "10px";
                    stopBtn.onclick = async () => {
                        const newEntry = { ...entry, depart: new Date().toISOString() };
                        history[index] = newEntry;
                        await updateDoc(doc(db, "agents", docu.id), { pointeuse: history });
                        alert("Service termin√© !");
                        popup.remove();
                        loadTotalHours(); // recharge la liste
                    };
                    entryDiv.appendChild(stopBtn);
                }

                popup.appendChild(entryDiv);
            });

            document.body.appendChild(popup);
        };

        totalHoursList.appendChild(div);
    });
}


const btnResetHours = document.getElementById("btnResetHours");

btnResetHours.onclick = async () => {
    if(!confirm("Voulez-vous vraiment r√©initialiser les heures de tous les agents ?")) return;

    const snap = await getDocs(collection(db,"agents"));

    for(const docu of snap.docs){
        await updateDoc(doc(db,"agents",docu.id), { pointeuse: [] });
    }

    loadTotalHours(); // recharge la page pour afficher tout vide
};


document.getElementById("btnBackHomeFromMDT").onclick = () => {
    showPage(homePage);
    checkAdmin(); // pour remettre le bouton admin si n√©cessaire
};

document.getElementById("btnBackHomeFromPointeuse").onclick = () => {
    showPage(homePage);
    checkAdmin(); // pour remettre le bouton admin si l‚Äôutilisateur est admin
};

document.getElementById("btnAllAgents").onclick = () => {
    showPage(pageAllAgents);
    loadAllAgents(); // fonction qui liste tous les agents
};

document.getElementById("btnBackAllAgents").onclick = () => {
    showPage(adminHome);
};


async function loadAllAgents(){
    const list = document.getElementById("allAgentsList");
    list.innerHTML = "";

    const snap = await getDocs(collection(db, "agents"));

    if(snap.empty){
        const span = document.createElement("span");
        span.innerText = "Aucun agent trouv√©.";
        list.appendChild(span);
        return;
    }

    // Stocke tous les agents dans un tableau
    const agents = snap.docs.map(docu => ({ id: docu.id, ...docu.data() }));

    // Trie par grade
    agents.sort(sortByGrade);

    // Affiche les agents tri√©s
    agents.forEach(data => {
        const div = document.createElement("div");
        div.className = "agent";
        div.style.cursor = "pointer";
        div.style.padding = "10px";
        div.style.background = "#1f2937";
        div.style.borderRadius = "8px";
        div.innerText = `${data.prenom} ${data.nom} - ${data.grade}`;

        div.onclick = () => openAgentDetail(data.id, data);

        list.appendChild(div);
    });
}


function openAgentDetail(id, data) {
    showPage(pageAgentDetail);

    const formattedDate = data.arrivalDate
        ? new Date(data.arrivalDate).toLocaleDateString("fr-FR", {
            day: "2-digit",
            month: "long",
            year: "numeric"
        })
        : "Non renseign√©e";

    // Sanctions existantes
    let sanctions = data.sanctions || [];


      // ‚ö° Fonction pour supprimer une sanction
window.removeSanction = async (index) => {
    sanctions.splice(index, 1); // supprime la sanction du tableau
    await updateDoc(doc(db, "agents", data.id), { sanctions }); // met √† jour Firestore
    document.getElementById("sanctionsList").innerHTML = renderSanctions(); // rafra√Æchit l'affichage
    document.getElementById("sanctionsList").appendChild(sanctionDiv);
};


    // ‚ö° Fonction pour afficher les sanctions (d√©j√† existante)
    function renderSanctions() {
    if (!sanctions.length) return `<p>Aucune sanction</p>`;

    return `
    <div style="margin-top:10px; overflow-x:auto;">
      <table style="width:100%; border-collapse: collapse; text-align:left; background:#111827; color:white; border-radius:8px; overflow:hidden;">
        <thead style="background:#1f2937;">
          <tr>
            <th style="padding:8px 12px;">Type</th>
            <th style="padding:8px 12px;">Raison</th>
            <th style="padding:8px 12px;">Date</th>
            <th style="padding:8px 12px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          ${sanctions.map((s, index) => `
            <tr style="border-bottom: 1px solid #333;">
              <td style="padding:8px 12px;">${s.type}</td>
              <td style="padding:8px 12px;">${s.raison}</td>
              <td style="padding:8px 12px; color:#f87171;">${s.date || ''}</td>
              <td style="padding:8px 12px;">
                <button onclick="removeSanction(${index})"
                  style="background:#dc2626; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">
                  üóëÔ∏è
                </button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
    `;
}



    // ‚ö° Ici on met le code formations
    function renderFormations() {

    const formations = data.formations || [];

    const formationsPossibles = [
        "Call Radio",
        "PPA Th√©orique",
        "Formation Finale",
        "PPA Pratique",
        "APJA"
    ];

    return `
    <div style="display:flex; flex-direction:column; gap:8px; margin-top:10px;">
        ${formationsPossibles.map(f => {

            const found = formations.find(x => x.nom === f);

            return `
                <div class="formation-row" 
                     style="display:flex; justify-content:space-between; align-items:center; padding:6px 10px; background:#111827; border-radius:8px;">

                    <span>
                        ${f}
                        ${found ? `<small style="color:#16a34a; margin-left:8px;">(${found.date})</small>` : ""}
                    </span>

                    <label class="switch">
                        <input type="checkbox"
                               ${found ? "checked" : ""}
                               onchange="toggleFormation('${f}')">
                        <span class="slider"></span>
                    </label>
                </div>
            `;
        }).join("")}
    </div>
`;

}




window.toggleFormation = async (formation) => {
    let formations = data.formations || [];

    const today = new Date().toLocaleDateString("fr-FR");

    const index = formations.findIndex(f => f.nom === formation);

    if (index !== -1) {
        formations.splice(index, 1);
    } else {
        formations.push({
            nom: formation,
            date: today
        });
    }

    data.formations = formations;

    await updateDoc(doc(db, "agents", data.id), { formations });

    document.getElementById("FormationsList").innerHTML = renderFormations();
};



    // ‚ö° Contenu HTML
    agentDetailContent.innerHTML = `
  <div class="card">
    <h3>${data.prenom} ${data.nom}</h3>
    <p><strong>Grade :</strong> ${data.grade}</p>
    <p><strong>Date arriv√©e :</strong> ${formattedDate}</p>

    <hr style="border:none; height:3px; background:#555; margin:10px 0;">

    <!-- Onglets -->
    <div style="display:flex; gap:10px; margin-bottom:10px;">
      <button id="tabFormations">Formations</button>
      <button id="tabSanctions">Sanctions</button>
    </div>

    <!-- Contenus -->
    <div id="tabContent">
      <div id="FormationsList">${renderFormations()}</div>
      <div id="sanctionsList" style="display:none;">
    <div id="sanctionsItems">${renderSanctions()}</div> <!-- juste la liste des sanctions -->
    <div id="sanctionFormContainer"></div> <!-- le formulaire sera inject√© ici -->
</div>
    </div>
  </div>
`;

// Gestion des clics sur les onglets
document.getElementById("tabFormations").onclick = () => {
  document.getElementById("FormationsList").style.display = "block";
  document.getElementById("sanctionsList").style.display = "none";
};
document.getElementById("tabSanctions").onclick = () => {
  document.getElementById("FormationsList").style.display = "none";
  document.getElementById("sanctionsList").style.display = "block";
};



    // ‚ö° Ajouter une nouvelle sanction
    const sanctionDiv = document.createElement("div");
    sanctionDiv.style.display = "flex";
    sanctionDiv.style.gap = "10px";
    sanctionDiv.style.marginTop = "10px";

    const typeSelect = document.createElement("select");
    ["Avertissement oral", "Avertissement √©crit", "Bl√¢me", "Mise √† pied", "Licenciement"].forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        typeSelect.appendChild(opt);
    });

    const reasonInput = document.createElement("input");
    reasonInput.placeholder = "Raison";
    reasonInput.style.flex = "1";

    const btnAdd = document.createElement("button");
    btnAdd.textContent = "Ajouter";
    btnAdd.style.background = "#dc2626";
    btnAdd.style.color = "white";
    btnAdd.style.border = "none";
    btnAdd.style.padding = "6px 10px";
    btnAdd.style.borderRadius = "5px";
    btnAdd.style.cursor = "pointer";

    btnAdd.onclick = async () => {
    const type = typeSelect.value;
    const raison = reasonInput.value.trim();
    if (!raison) return alert("Veuillez indiquer une raison");

    const newSanction = { 
        type, 
        raison,
        date: new Date().toLocaleDateString("fr-FR")
    };

    sanctions.push(newSanction);

    await updateDoc(doc(db, "agents", data.id), { sanctions });

    // ‚úÖ Mettre √† jour seulement la liste
    document.getElementById("sanctionsItems").innerHTML = renderSanctions();

    reasonInput.value = "";
    typeSelect.selectedIndex = 0;
    alert("Sanction ajout√©e !");
};


    sanctionDiv.appendChild(typeSelect);
    sanctionDiv.appendChild(reasonInput);
    sanctionDiv.appendChild(btnAdd);
    document.getElementById("sanctionsList").appendChild(sanctionDiv);
}


</script>
</body>
</html>
